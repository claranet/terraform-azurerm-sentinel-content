{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "String",
            "minLength": 1,
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
            }
        },
        "workspace-location": {
            "type": "String",
            "defaultValue": "",
            "metadata": {
                "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
            }
        },
        "workspace": {
            "defaultValue": "",
            "type": "String",
            "metadata": {
                "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
            }
        },
        "workbook1-name": {
            "type": "String",
            "defaultValue": "Darktrace",
            "minLength": 1,
            "metadata": {
                "description": "Name for the workbook"
            }
        }
    },
    "resources": [
        {
            "name": "pid-308be9d0-24cc-4c92-acbb-06ff29017673-partnercenter",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-10-01",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": []
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-wb-',uniquestring('DarktraceWorkbook')),'1.0.1'))]",
            "location": "[parameters('workspace-location')]",
            "apiVersion": "2023-04-01-preview",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'darktrace1655286944672.darktrace_for_sentinel')]"
            ],
            "properties": {
                "contentId": "DarktraceWorkbook",
                "displayName": "Darktrace",
                "contentKind": "Workbook",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.1",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Insights/workbooks",
                            "name": "DarktraceWorkbook",
                            "location": "[parameters('workspace-location')]",
                            "kind": "shared",
                            "apiVersion": "2021-08-01",
                            "metadata": {
                                "description": "The Darktrace Workbook visualises Model Breach and AI Analyst data received by the Darktrace Data Connector and visualises events across the network, SaaS, IaaS and Email."
                            },
                            "properties": {
                                "displayName": "Darktrace",
                                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"a4b35478-499a-4fcc-8424-63abbb698bfa\",\"cellValue\":\"tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"AI Analyst\",\"subTarget\":\"ai-analyst\",\"style\":\"link\"},{\"id\":\"45805ae8-29d7-4774-a10a-8d60af407bbf\",\"cellValue\":\"tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"DETECT + RESPOND/Network \",\"subTarget\":\"overview\",\"style\":\"link\"},{\"id\":\"7a64cd79-3a09-4046-8d6f-ba24fc2bab6c\",\"cellValue\":\"tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"DETECT + RESPOND/Apps\",\"subTarget\":\"cloud\",\"style\":\"link\"},{\"id\":\"0dc4ab10-226f-422f-a7bb-9e905f96fb6c\",\"cellValue\":\"tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"DETECT + RESPOND/Email\",\"subTarget\":\"email\",\"style\":\"link\"},{\"id\":\"2eac3f00-5164-4a77-9781-118eb681b729\",\"cellValue\":\"tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"RESPOND\",\"subTarget\":\"agn\",\"style\":\"link\"},{\"id\":\"ff97b7e6-6bbf-401c-aaff-833d5309f00d\",\"cellValue\":\"tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"System Status\",\"subTarget\":\"status\",\"style\":\"link\"}]},\"name\":\"tabs\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"96e10804-35d4-4d5c-b2d8-1af544471721\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Timeframe\",\"type\":4,\"description\":\"Set the global time range for all queries below\",\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":604800000}}],\"style\":\"pills\",\"doNotRunWhenHidden\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Timescale \"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"610136a1-b7cf-4eb3-9ef6-51a2d22e1621\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_severity\",\"type\":1,\"description\":\"parameter to drill down on clicked severity tile\",\"value\":\"\",\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":86400000},\"label\":\"severity\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"datatable (Count: long, status: string, status_count: long) [0, \\\"Compliance\\\", 1, 0, \\\"Informational\\\", 2, 0, \\\"Suspicious\\\", 3, 0, \\\"Critical\\\", 4]\\r\\n| union\\r\\n    (\\r\\n    darktrace_model_alerts_CL\\r\\n    | where dtProduct_s ==\\\"Policy Breach\\\" and modelName_s !contains (\\\"SaaS\\\") and modelName_s !contains (\\\"IaaS\\\")\\r\\n    | extend ThreatRiskLevel=score_d\\r\\n    | extend status = case(    \\r\\n        compliance_b == false and Category == \\\"Critical\\\", \\\"Critical\\\",\\r\\n        compliance_b == true, \\\"Compliance\\\",\\r\\n        compliance_b == false and Category == \\\"Suspicious\\\", \\\"Suspicious\\\",\\r\\n        compliance_b == false and Category == \\\"Informational\\\", \\\"Informational\\\",       \\r\\n        \\\"True\\\"\\r\\n        )\\r\\n    | where status != \\\"True\\\"\\r\\n    | extend status_count = case(status == \\\"Critical\\\", 4, status == \\\"Suspicious\\\", 3, status == \\\"Informational\\\", 2, 1)\\r\\n    | summarize Count = count() by status, status_count\\r\\n    )\\r\\n| summarize Count=sum(Count) by status, status_count\\r\\n| sort by status_count asc\",\"size\":3,\"title\":\"Model Breaches by Category\",\"timeContextFromParameter\":\"Timeframe\",\"exportFieldName\":\"status\",\"exportParameterName\":\"_severity\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"status\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Compliance\",\"representation\":\"turquoise\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Informational\",\"representation\":\"yellow\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Suspicious\",\"representation\":\"orange\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Critical\",\"representation\":\"redBright\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"green\",\"text\":\"{0}{1}\"}]}},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":true,\"size\":\"auto\"}},\"name\":\"model breaches by severity\"},{\"type\":1,\"content\":{\"json\":\"_Click on the tiles to view more details (maximum 100 entries displayed)_\",\"style\":\"info\"},\"name\":\"text - 3\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"Policy Breach\\\" and modelName_s !contains (\\\"SaaS\\\") and modelName_s !contains (\\\"IaaS\\\")\\r\\n| extend EventCount = 1\\r\\n| extend EventType = \\\"NetworkSession\\\"\\r\\n| extend EventSchema = \\\"NetworkSession\\\"\\r\\n| extend EventSchemaVersion = \\\"0.2.2\\\"\\r\\n| extend EventResult = \\\"Success\\\"\\r\\n| extend DvcAction = \\\"Allow\\\"\\r\\n| project-rename EventSeverity=score_d\\r\\n| extend EventVendor = \\\"Darktrace\\\"\\r\\n| extend EventProduct = \\\"Enterprise Immune System\\\"\\r\\n| project-rename  EventStartTime = breachTime_s\\r\\n| extend EventEndTime = EventStartTime\\r\\n| project-rename NetworkRuleName=modelName_s\\r\\n| project-rename NetworkRuleNumber=pid_d\\r\\n| extend Rule = \\\"NetworkRuleNumber\\\"\\r\\n| project-rename ThreatId=threatID_d\\r\\n| extend ThreatName = NetworkRuleName\\r\\n| project-rename ThreatCategory=dtProduct_s\\r\\n| extend ThreatRiskLevel=EventSeverity\\r\\n| project-rename SrcIpAddr=SourceIP\\r\\n| project-rename SrcHostname=hostname_s\\r\\n| project-rename SrcMacAddr=sourceMac_s\\r\\n| project-rename SrcPortNumber=sourcePort_s\\r\\n| project-rename DstIpAddr=destIP_s\\r\\n| project-rename DstPortNumber=destPort_s\\r\\n| project-rename DstHostname=destHost_s\\r\\n| project-rename DstMacAddr=destMac_s\\r\\n| project-rename MitreTechniques=mitreTechniques_s\\r\\n| project-rename DarktraceLink=breachUrl_s\\r\\n| where compliance_b == true\\r\\n| limit 100\\r\\n| project TimeGenerated, NetworkRuleName, ThreatRiskLevel, ThreatId, DarktraceLink, SrcHostname, SrcIpAddr, DstHostname, DstIpAddr, EventStartTime, MitreTechniques\\r\\n| sort by TimeGenerated desc\\r\\n\",\"size\":0,\"title\":\"Compliance Model Breaches\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"formatOptions\":{\"customColumnWidthSetting\":\"20%\"}},{\"columnMatch\":\"Activity\",\"formatter\":1,\"formatOptions\":{\"linkColumn\":\"DarktraceURL\",\"linkTarget\":\"Url\",\"customColumnWidthSetting\":\"40%\"}},{\"columnMatch\":\"DeviceName\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"DeviceAddress\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"LogSeverity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"representation\":\"yellow\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"DarktraceURL\",\"formatter\":5},{\"columnMatch\":\"DarktraceUrl\",\"formatter\":5,\"formatOptions\":{\"linkTarget\":\"Url\"}},{\"columnMatch\":\"OtherExtensions\",\"formatter\":5,\"formatOptions\":{\"customColumnWidthSetting\":\"50%\"}}],\"labelSettings\":[{\"columnId\":\"TimeGenerated\",\"label\":\"Time\"}]}},\"conditionalVisibility\":{\"parameterName\":\"_severity\",\"comparison\":\"isEqualTo\",\"value\":\"Compliance\"},\"name\":\"Low severity model breaches\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"Policy Breach\\\" and modelName_s !contains (\\\"SaaS\\\") and modelName_s !contains (\\\"IaaS\\\")\\r\\n| extend EventCount = 1\\r\\n| extend EventType = \\\"NetworkSession\\\"\\r\\n| extend EventSchema = \\\"NetworkSession\\\"\\r\\n| extend EventSchemaVersion = \\\"0.2.2\\\"\\r\\n| extend EventResult = \\\"Success\\\"\\r\\n| extend DvcAction = \\\"Allow\\\"\\r\\n| project-rename EventSeverity=score_d\\r\\n| extend EventVendor = \\\"Darktrace\\\"\\r\\n| extend EventProduct = \\\"Enterprise Immune System\\\"\\r\\n| project-rename  EventStartTime = breachTime_s\\r\\n| extend EventEndTime = EventStartTime\\r\\n| project-rename NetworkRuleName=modelName_s\\r\\n| project-rename NetworkRuleNumber=pid_d\\r\\n| extend Rule = \\\"NetworkRuleNumber\\\"\\r\\n| project-rename ThreatId=threatID_d\\r\\n| extend ThreatName = NetworkRuleName\\r\\n| project-rename ThreatCategory=dtProduct_s\\r\\n| extend ThreatRiskLevel=EventSeverity\\r\\n| project-rename SrcIpAddr=SourceIP\\r\\n| project-rename SrcHostname=hostname_s\\r\\n| project-rename SrcMacAddr=sourceMac_s\\r\\n| project-rename SrcPortNumber=sourcePort_s\\r\\n| project-rename DstIpAddr=destIP_s\\r\\n| project-rename DstPortNumber=destPort_s\\r\\n| project-rename DstHostname=destHost_s\\r\\n| project-rename DstMacAddr=destMac_s\\r\\n| project-rename MitreTechniques=mitreTechniques_s\\r\\n| project-rename DarktraceLink=breachUrl_s\\r\\n| where compliance_b == false and Category == \\\"Informational\\\"\\r\\n| limit 100\\r\\n| project TimeGenerated, NetworkRuleName, ThreatRiskLevel, ThreatId, DarktraceLink, SrcHostname, SrcIpAddr, DstHostname, DstIpAddr, EventStartTime, MitreTechniques\\r\\n| sort by TimeGenerated desc\\r\\n\\r\\n\",\"size\":0,\"title\":\"Informational Model Breaches\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"formatOptions\":{\"customColumnWidthSetting\":\"20%\"}},{\"columnMatch\":\"Activity\",\"formatter\":1,\"formatOptions\":{\"linkColumn\":\"DarktraceURL\",\"linkTarget\":\"Url\",\"customColumnWidthSetting\":\"40%\"}},{\"columnMatch\":\"DeviceName\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"DeviceAddress\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"LogSeverity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"representation\":\"orange\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"DarktraceURL\",\"formatter\":5},{\"columnMatch\":\"DarktraceUrl\",\"formatter\":5,\"formatOptions\":{\"linkTarget\":\"Url\"}},{\"columnMatch\":\"OtherExtensions\",\"formatter\":5,\"formatOptions\":{\"customColumnWidthSetting\":\"50%\"}}],\"labelSettings\":[{\"columnId\":\"TimeGenerated\",\"label\":\"Time\"}]}},\"conditionalVisibility\":{\"parameterName\":\"_severity\",\"comparison\":\"isEqualTo\",\"value\":\"Informational\"},\"name\":\"Medium severity model breaches \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"Policy Breach\\\" and modelName_s !contains (\\\"SaaS\\\") and modelName_s !contains (\\\"IaaS\\\")\\r\\n| extend EventCount = 1\\r\\n| extend EventType = \\\"NetworkSession\\\"\\r\\n| extend EventSchema = \\\"NetworkSession\\\"\\r\\n| extend EventSchemaVersion = \\\"0.2.2\\\"\\r\\n| extend EventResult = \\\"Success\\\"\\r\\n| extend DvcAction = \\\"Allow\\\"\\r\\n| project-rename EventSeverity=score_d\\r\\n| extend EventVendor = \\\"Darktrace\\\"\\r\\n| extend EventProduct = \\\"Enterprise Immune System\\\"\\r\\n| project-rename  EventStartTime = breachTime_s\\r\\n| extend EventEndTime = EventStartTime\\r\\n| project-rename NetworkRuleName=modelName_s\\r\\n| project-rename NetworkRuleNumber=pid_d\\r\\n| extend Rule = \\\"NetworkRuleNumber\\\"\\r\\n| project-rename ThreatId=threatID_d\\r\\n| extend ThreatName = NetworkRuleName\\r\\n| project-rename ThreatCategory=dtProduct_s\\r\\n| extend ThreatRiskLevel=EventSeverity\\r\\n| project-rename SrcIpAddr=SourceIP\\r\\n| project-rename SrcHostname=hostname_s\\r\\n| project-rename SrcMacAddr=sourceMac_s\\r\\n| project-rename SrcPortNumber=sourcePort_s\\r\\n| project-rename DstIpAddr=destIP_s\\r\\n| project-rename DstPortNumber=destPort_s\\r\\n| project-rename DstHostname=destHost_s\\r\\n| project-rename DstMacAddr=destMac_s\\r\\n| project-rename MitreTechniques=mitreTechniques_s\\r\\n| project-rename DarktraceLink=breachUrl_s\\r\\n| where compliance_b == false and Category == \\\"Suspicious\\\"\\r\\n| project TimeGenerated, NetworkRuleName, ThreatRiskLevel, ThreatId, DarktraceLink, SrcHostname, SrcIpAddr, DstHostname, DstIpAddr, EventStartTime, MitreTechniques\\r\\n| limit 100\\r\\n| sort by TimeGenerated desc\\r\\n\",\"size\":0,\"title\":\"Suspicious Model Breaches\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"formatOptions\":{\"customColumnWidthSetting\":\"20%\"}},{\"columnMatch\":\"Activity\",\"formatter\":1,\"formatOptions\":{\"linkColumn\":\"DarktraceURL\",\"linkTarget\":\"Url\",\"customColumnWidthSetting\":\"40%\"}},{\"columnMatch\":\"DeviceName\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"DeviceAddress\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"LogSeverity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"representation\":\"redBright\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"DarktraceURL\",\"formatter\":5},{\"columnMatch\":\"DarktraceUrl\",\"formatter\":5,\"formatOptions\":{\"linkTarget\":\"Url\"}},{\"columnMatch\":\"AdditionalExtensions\",\"formatter\":5,\"formatOptions\":{\"customColumnWidthSetting\":\"70%\"}}],\"labelSettings\":[{\"columnId\":\"TimeGenerated\",\"label\":\"Time\"}]}},\"conditionalVisibility\":{\"parameterName\":\"_severity\",\"comparison\":\"isEqualTo\",\"value\":\"Suspicious\"},\"name\":\"High severity model breaches \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"Policy Breach\\\" and modelName_s !contains (\\\"SaaS\\\") and modelName_s !contains (\\\"IaaS\\\")\\r\\n| extend EventCount = 1\\r\\n| extend EventType = \\\"NetworkSession\\\"\\r\\n| extend EventSchema = \\\"NetworkSession\\\"\\r\\n| extend EventSchemaVersion = \\\"0.2.2\\\"\\r\\n| extend EventResult = \\\"Success\\\"\\r\\n| extend DvcAction = \\\"Allow\\\"\\r\\n| project-rename EventSeverity=score_d\\r\\n| extend EventVendor = \\\"Darktrace\\\"\\r\\n| extend EventProduct = \\\"Enterprise Immune System\\\"\\r\\n| project-rename  EventStartTime = breachTime_s\\r\\n| extend EventEndTime = EventStartTime\\r\\n| project-rename NetworkRuleName=modelName_s\\r\\n| project-rename NetworkRuleNumber=pid_d\\r\\n| extend Rule = \\\"NetworkRuleNumber\\\"\\r\\n| project-rename ThreatId=threatID_d\\r\\n| extend ThreatName = NetworkRuleName\\r\\n| project-rename ThreatCategory=dtProduct_s\\r\\n| extend ThreatRiskLevel=EventSeverity\\r\\n| project-rename SrcIpAddr=SourceIP\\r\\n| project-rename SrcHostname=hostname_s\\r\\n| project-rename SrcMacAddr=sourceMac_s\\r\\n| project-rename SrcPortNumber=sourcePort_s\\r\\n| project-rename DstIpAddr=destIP_s\\r\\n| project-rename DstPortNumber=destPort_s\\r\\n| project-rename DstHostname=destHost_s\\r\\n| project-rename DstMacAddr=destMac_s\\r\\n| project-rename MitreTechniques=mitreTechniques_s\\r\\n| project-rename DarktraceLink=breachUrl_s\\r\\n| where compliance_b == false and Category == \\\"Critical\\\"\\r\\n| project TimeGenerated, NetworkRuleName, ThreatRiskLevel, ThreatId, DarktraceLink, SrcHostname, SrcIpAddr, DstHostname, DstIpAddr, EventStartTime, MitreTechniques\\r\\n| limit 100\\r\\n| sort by TimeGenerated desc\\r\\n\",\"size\":0,\"title\":\"Critical Model Breaches\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"formatOptions\":{\"customColumnWidthSetting\":\"20%\"}},{\"columnMatch\":\"Activity\",\"formatter\":1,\"formatOptions\":{\"linkColumn\":\"DarktraceURL\",\"linkTarget\":\"Url\",\"customColumnWidthSetting\":\"40%\"}},{\"columnMatch\":\"DeviceName\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"DeviceAddress\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"LogSeverity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"representation\":\"red\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"DarktraceURL\",\"formatter\":5},{\"columnMatch\":\"DarktraceUrl\",\"formatter\":5,\"formatOptions\":{\"linkTarget\":\"Url\"}},{\"columnMatch\":\"AdditionalExtensions\",\"formatter\":5,\"formatOptions\":{\"customColumnWidthSetting\":\"70%\"}}],\"labelSettings\":[{\"columnId\":\"TimeGenerated\",\"label\":\"Time\"}]}},\"conditionalVisibility\":{\"parameterName\":\"_severity\",\"comparison\":\"isEqualTo\",\"value\":\"Critical\"},\"name\":\"Critical severity model breaches\"}]},\"conditionalVisibility\":{\"parameterName\":\"_severity\",\"comparison\":\"isNotEqualTo\",\"value\":\"hidden\"},\"name\":\"Drill down group for different severities\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"Policy Breach\\\" and modelName_s !contains (\\\"SaaS\\\") and modelName_s !contains (\\\"IaaS\\\")\\r\\n| make-series Count = count() default=0 on TimeGenerated in range({Timeframe:start}, now(), {Timeframe:grain})\",\"size\":0,\"title\":\"Total Model Breaches\",\"color\":\"orange\",\"timeContextFromParameter\":\"Timeframe\",\"timeBrushParameterName\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Count\",\"label\":\"Model Breaches\"}],\"ySettings\":{\"numberFormatSettings\":{\"unit\":0,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":0}}}}},\"name\":\"breaches in group\"},{\"type\":1,\"content\":{\"json\":\"_ Selecting a timeframe on the graph will change the timeframe for all queries in this tab _\",\"style\":\"info\"},\"name\":\"text - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"Policy Breach\\\" and modelName_s !contains (\\\"SaaS\\\") and modelName_s !contains (\\\"IaaS\\\")\\r\\n| project-rename NetworkRuleName=modelName_s\\r\\n| summarize event_count=count() by NetworkRuleName\\r\\n| top 10 by event_count\",\"size\":0,\"title\":\"Top 10 Most Breached Models\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Activity\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"60ch\"}},{\"columnMatch\":\"event_count\",\"formatter\":3,\"formatOptions\":{\"palette\":\"orange\"}}],\"labelSettings\":[{\"columnId\":\"event_count\",\"label\":\"Count\"}]}},\"customWidth\":\"55\",\"name\":\"most breached models\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\r\\ndarktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"Policy Breach\\\" and modelName_s !contains (\\\"SaaS\\\") and modelName_s !contains (\\\"IaaS\\\")\\r\\n| project-rename NetworkRuleName=modelName_s\\r\\n| project-rename DstHostname=destHost_s\\r\\n| where isnotempty(DstHostname) \\r\\n| summarize count(NetworkRuleName) by DstHostname\",\"size\":3,\"title\":\"Top External Hostnames\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"45\",\"name\":\"top external hostnames\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"Policy Breach\\\" and modelName_s !contains (\\\"SaaS\\\") and modelName_s !contains (\\\"IaaS\\\")\\r\\n| project-rename SrcIpAddr=SourceIP\\r\\n| project-rename SrcHostname=hostname_s\\r\\n| project-rename DtURL=breachUrl_s\\r\\n| project-rename ThreatRiskLevel=score_d\\r\\n| project-rename NetworkRuleName=modelName_s\\r\\n| project TimeGenerated, ThreatRiskLevel, NetworkRuleName, SrcHostname, SrcIpAddr, DtURL\\r\\n| top 10 by ThreatRiskLevel desc \",\"size\":0,\"title\":\"Top 10 Model Breaches with Highest Severity\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"20%\"}},{\"columnMatch\":\"Activity\",\"formatter\":1,\"formatOptions\":{\"linkColumn\":\"DarktraceURL\",\"linkTarget\":\"Url\",\"customColumnWidthSetting\":\"40%\"}},{\"columnMatch\":\"DeviceName\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"DeviceAddress\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"Severity\",\"formatter\":8,\"formatOptions\":{\"min\":1,\"max\":10,\"palette\":\"yellowOrangeRed\"}},{\"columnMatch\":\"DarktraceURL\",\"formatter\":5}],\"labelSettings\":[{\"columnId\":\"TimeGenerated\",\"label\":\"Time\"}]}},\"name\":\"Top 10 hitting devices\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\n| where dtProduct_s ==\\\"Policy Breach\\\" and modelName_s !contains (\\\"SaaS\\\") and modelName_s !contains (\\\"IaaS\\\")\\n| project-rename DstIpAddr=destIP_s\\n| where isnotempty(DstIpAddr) \\n| where DstIpAddr !startswith \\\"10\\\"\\n| where DstIpAddr !startswith \\\"192\\\"\\n| where DstIpAddr !startswith \\\"172\\\"\\n| summarize event_count=count() by DstIpAddr\\n| top 10 by event_count\",\"size\":0,\"title\":\"Top 10 External IPs\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"80\",\"name\":\"top 10 external IPs\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"Policy Breach\\\" and modelName_s !contains (\\\"SaaS\\\") and modelName_s !contains (\\\"IaaS\\\") and compliance_b == true\\r\\n| make-series Count = count() default=0 on TimeGenerated in range({Timeframe:start}, now(), {Timeframe:grain})\\r\\n\",\"size\":0,\"title\":\"Compliance Model Breaches Over Time\",\"color\":\"orange\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Count\",\"label\":\"Model Breaches\"}],\"ySettings\":{\"numberFormatSettings\":{\"unit\":0,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":0}}}}},\"name\":\"compliance breaches over time\"}],\"exportParameters\":true},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"overview\"},\"name\":\"overview\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"610136a1-b7cf-4eb3-9ef6-51a2d22e1621\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_severity\",\"type\":1,\"description\":\"parameter to drill down on clicked severity tile\",\"value\":\"hidden\",\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":86400000},\"label\":\"severity\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"datatable (Count: long, status: string, status_count: long) [0, \\\"Low\\\", 1, 0, \\\"Medium\\\", 2, 0, \\\"High\\\", 3, 0, \\\"Critical\\\", 4]\\r\\n| union\\r\\n    (\\r\\n    darktrace_model_alerts_CL\\r\\n    | where dtProduct_s ==\\\"Policy Breach\\\" and (modelName_s contains (\\\"SaaS\\\") or modelName_s contains (\\\"IaaS\\\"))\\r\\n    | extend ThreatRiskLevel=score_d\\r\\n    | extend status = case(    \\r\\n        ThreatRiskLevel >= 75, \\\"Critical\\\",\\r\\n        ThreatRiskLevel < 25, \\\"Low\\\",\\r\\n        ThreatRiskLevel >= 50 and ThreatRiskLevel < 75, \\\"High\\\",\\r\\n        ThreatRiskLevel >= 25 and ThreatRiskLevel < 50, \\\"Medium\\\",          \\r\\n        \\\"True\\\"\\r\\n        )\\r\\n    | where status != \\\"True\\\"\\r\\n    | extend status_count = case(status == \\\"Critical\\\", 4, status == \\\"High\\\", 3, status == \\\"Medium\\\", 2, 1)\\r\\n    | summarize Count = count() by status, status_count\\r\\n    )\\r\\n| summarize Count=sum(Count) by status, status_count\\r\\n| sort by status_count asc\",\"size\":3,\"title\":\"Model Breaches by Severity\",\"timeContextFromParameter\":\"Timeframe\",\"exportFieldName\":\"status\",\"exportParameterName\":\"_severity\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"status\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"yellow\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"orange\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"redBright\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Critical\",\"representation\":\"red\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"green\",\"text\":\"{0}{1}\"}]}},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":true,\"size\":\"auto\"}},\"name\":\"model breaches by severity\"},{\"type\":1,\"content\":{\"json\":\"_Click on the tiles to view more details (maximum 100 entries displayed)_\",\"style\":\"info\"},\"name\":\"text - 3\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"Policy Breach\\\" and (modelName_s contains (\\\"SaaS\\\") or modelName_s contains (\\\"IaaS\\\"))\\r\\n| extend EventCount = 1\\r\\n| extend EventType = \\\"NetworkSession\\\"\\r\\n| extend EventSchema = \\\"NetworkSession\\\"\\r\\n| extend EventSchemaVersion = \\\"0.2.2\\\"\\r\\n| extend EventResult = \\\"Success\\\"\\r\\n| extend DvcAction = \\\"Allow\\\"\\r\\n| project-rename EventSeverity=score_d\\r\\n| extend EventVendor = \\\"Darktrace\\\"\\r\\n| extend EventProduct = \\\"Enterprise Immune System\\\"\\r\\n| project-rename  EventStartTime = breachTime_s\\r\\n| extend EventEndTime = EventStartTime\\r\\n| project-rename NetworkRuleName=modelName_s\\r\\n| project-rename NetworkRuleNumber=pid_d\\r\\n| extend Rule = \\\"NetworkRuleNumber\\\"\\r\\n| project-rename ThreatId=threatID_d\\r\\n| extend ThreatName = NetworkRuleName\\r\\n| project-rename ThreatCategory=dtProduct_s\\r\\n| extend ThreatRiskLevel=EventSeverity\\r\\n| project-rename SrcIpAddr=SourceIP\\r\\n| project-rename SrcHostname=hostname_s\\r\\n| project-rename SrcMacAddr=sourceMac_s\\r\\n| project-rename SrcPortNumber=sourcePort_s\\r\\n| project-rename DstIpAddr=destIP_s\\r\\n| project-rename DstPortNumber=destPort_s\\r\\n| project-rename DstHostname=destHost_s\\r\\n| project-rename DstMacAddr=destMac_s\\r\\n| extend MitreTechniques=parse_json(mitreTechniques_s)\\r\\n| project-rename DarktraceLink=breachUrl_s\\r\\n| where ThreatRiskLevel < 25\\r\\n| limit 100\\r\\n| project TimeGenerated, NetworkRuleName, ThreatRiskLevel, ThreatId, DarktraceLink, SrcHostname, SrcIpAddr, DstHostname, DstIpAddr, EventStartTime, MitreTechniques\\r\\n| sort by TimeGenerated desc\\r\\n\",\"size\":0,\"title\":\"Low Severity Model Breaches\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"formatOptions\":{\"customColumnWidthSetting\":\"20%\"}},{\"columnMatch\":\"Activity\",\"formatter\":1,\"formatOptions\":{\"linkColumn\":\"DarktraceURL\",\"linkTarget\":\"Url\",\"customColumnWidthSetting\":\"40%\"}},{\"columnMatch\":\"DeviceName\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"DeviceAddress\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"LogSeverity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"representation\":\"yellow\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"DarktraceURL\",\"formatter\":5},{\"columnMatch\":\"DarktraceUrl\",\"formatter\":5,\"formatOptions\":{\"linkTarget\":\"Url\"}},{\"columnMatch\":\"OtherExtensions\",\"formatter\":5,\"formatOptions\":{\"customColumnWidthSetting\":\"50%\"}}],\"labelSettings\":[{\"columnId\":\"TimeGenerated\",\"label\":\"Time\"}]}},\"conditionalVisibility\":{\"parameterName\":\"_severity\",\"comparison\":\"isEqualTo\",\"value\":\"Low\"},\"name\":\"Low severity model breaches\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"Policy Breach\\\" and (modelName_s contains (\\\"SaaS\\\") or modelName_s contains (\\\"IaaS\\\"))\\r\\n| extend EventCount = 1\\r\\n| extend EventType = \\\"NetworkSession\\\"\\r\\n| extend EventSchema = \\\"NetworkSession\\\"\\r\\n| extend EventSchemaVersion = \\\"0.2.2\\\"\\r\\n| extend EventResult = \\\"Success\\\"\\r\\n| extend DvcAction = \\\"Allow\\\"\\r\\n| project-rename EventSeverity=score_d\\r\\n| extend EventVendor = \\\"Darktrace\\\"\\r\\n| extend EventProduct = \\\"Enterprise Immune System\\\"\\r\\n| project-rename  EventStartTime = breachTime_s\\r\\n| extend EventEndTime = EventStartTime\\r\\n| project-rename NetworkRuleName=modelName_s\\r\\n| project-rename NetworkRuleNumber=pid_d\\r\\n| extend Rule = \\\"NetworkRuleNumber\\\"\\r\\n| project-rename ThreatId=threatID_d\\r\\n| extend ThreatName = NetworkRuleName\\r\\n| project-rename ThreatCategory=dtProduct_s\\r\\n| extend ThreatRiskLevel=EventSeverity\\r\\n| project-rename SrcIpAddr=SourceIP\\r\\n| project-rename SrcHostname=hostname_s\\r\\n| project-rename SrcMacAddr=sourceMac_s\\r\\n| project-rename SrcPortNumber=sourcePort_s\\r\\n| project-rename DstIpAddr=destIP_s\\r\\n| project-rename DstPortNumber=destPort_s\\r\\n| project-rename DstHostname=destHost_s\\r\\n| project-rename DstMacAddr=destMac_s\\r\\n| extend MitreTechniques=parse_json(mitreTechniques_s)\\r\\n| project-rename DarktraceLink=breachUrl_s\\r\\n| where ThreatRiskLevel >= 25 and ThreatRiskLevel < 50\\r\\n| limit 100\\r\\n| project TimeGenerated, NetworkRuleName, ThreatRiskLevel, ThreatId, DarktraceLink, SrcHostname, SrcIpAddr, DstHostname, DstIpAddr, EventStartTime, MitreTechniques\\r\\n| sort by TimeGenerated desc\\r\\n\",\"size\":0,\"title\":\"Medium Severity Model Breaches\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"formatOptions\":{\"customColumnWidthSetting\":\"20%\"}},{\"columnMatch\":\"Activity\",\"formatter\":1,\"formatOptions\":{\"linkColumn\":\"DarktraceURL\",\"linkTarget\":\"Url\",\"customColumnWidthSetting\":\"40%\"}},{\"columnMatch\":\"DeviceName\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"DeviceAddress\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"LogSeverity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"representation\":\"orange\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"DarktraceURL\",\"formatter\":5},{\"columnMatch\":\"DarktraceUrl\",\"formatter\":5,\"formatOptions\":{\"linkTarget\":\"Url\"}},{\"columnMatch\":\"OtherExtensions\",\"formatter\":5,\"formatOptions\":{\"customColumnWidthSetting\":\"50%\"}}],\"labelSettings\":[{\"columnId\":\"TimeGenerated\",\"label\":\"Time\"}]}},\"conditionalVisibility\":{\"parameterName\":\"_severity\",\"comparison\":\"isEqualTo\",\"value\":\"Medium\"},\"name\":\"Medium severity model breaches \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"Policy Breach\\\" and (modelName_s contains (\\\"SaaS\\\") or modelName_s contains (\\\"IaaS\\\"))\\r\\n| extend EventCount = 1\\r\\n| extend EventType = \\\"NetworkSession\\\"\\r\\n| extend EventSchema = \\\"NetworkSession\\\"\\r\\n| extend EventSchemaVersion = \\\"0.2.2\\\"\\r\\n| extend EventResult = \\\"Success\\\"\\r\\n| extend DvcAction = \\\"Allow\\\"\\r\\n| project-rename EventSeverity=score_d\\r\\n| extend EventVendor = \\\"Darktrace\\\"\\r\\n| extend EventProduct = \\\"Enterprise Immune System\\\"\\r\\n| project-rename  EventStartTime = breachTime_s\\r\\n| extend EventEndTime = EventStartTime\\r\\n| project-rename NetworkRuleName=modelName_s\\r\\n| project-rename NetworkRuleNumber=pid_d\\r\\n| extend Rule = \\\"NetworkRuleNumber\\\"\\r\\n| project-rename ThreatId=threatID_d\\r\\n| extend ThreatName = NetworkRuleName\\r\\n| project-rename ThreatCategory=dtProduct_s\\r\\n| extend ThreatRiskLevel=EventSeverity\\r\\n| project-rename SrcIpAddr=SourceIP\\r\\n| project-rename SrcHostname=hostname_s\\r\\n| project-rename SrcMacAddr=sourceMac_s\\r\\n| project-rename SrcPortNumber=sourcePort_s\\r\\n| project-rename DstIpAddr=destIP_s\\r\\n| project-rename DstPortNumber=destPort_s\\r\\n| project-rename DstHostname=destHost_s\\r\\n| project-rename DstMacAddr=destMac_s\\r\\n| extend MitreTechniques=parse_json(mitreTechniques_s)\\r\\n| project-rename DarktraceLink=breachUrl_s\\r\\n| where ThreatRiskLevel >= 50 and ThreatRiskLevel < 75\\r\\n| limit 100\\r\\n| project TimeGenerated, NetworkRuleName, ThreatRiskLevel, ThreatId, DarktraceLink, SrcHostname, SrcIpAddr, DstHostname, DstIpAddr, EventStartTime, MitreTechniques\\r\\n| sort by TimeGenerated desc\\r\\n\",\"size\":0,\"title\":\"High Severity Model Breaches\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"formatOptions\":{\"customColumnWidthSetting\":\"20%\"}},{\"columnMatch\":\"Activity\",\"formatter\":1,\"formatOptions\":{\"linkColumn\":\"DarktraceURL\",\"linkTarget\":\"Url\",\"customColumnWidthSetting\":\"40%\"}},{\"columnMatch\":\"DeviceName\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"DeviceAddress\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"LogSeverity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"representation\":\"redBright\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"DarktraceURL\",\"formatter\":5},{\"columnMatch\":\"DarktraceUrl\",\"formatter\":5,\"formatOptions\":{\"linkTarget\":\"Url\"}},{\"columnMatch\":\"AdditionalExtensions\",\"formatter\":5,\"formatOptions\":{\"customColumnWidthSetting\":\"70%\"}}],\"labelSettings\":[{\"columnId\":\"TimeGenerated\",\"label\":\"Time\"}]}},\"conditionalVisibility\":{\"parameterName\":\"_severity\",\"comparison\":\"isEqualTo\",\"value\":\"High\"},\"name\":\"High severity model breaches \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"Policy Breach\\\" and (modelName_s contains (\\\"SaaS\\\") or modelName_s contains (\\\"IaaS\\\"))\\r\\n| extend EventCount = 1\\r\\n| extend EventType = \\\"NetworkSession\\\"\\r\\n| extend EventSchema = \\\"NetworkSession\\\"\\r\\n| extend EventSchemaVersion = \\\"0.2.2\\\"\\r\\n| extend EventResult = \\\"Success\\\"\\r\\n| extend DvcAction = \\\"Allow\\\"\\r\\n| project-rename EventSeverity=score_d\\r\\n| extend EventVendor = \\\"Darktrace\\\"\\r\\n| extend EventProduct = \\\"Enterprise Immune System\\\"\\r\\n| project-rename  EventStartTime = breachTime_s\\r\\n| extend EventEndTime = EventStartTime\\r\\n| project-rename NetworkRuleName=modelName_s\\r\\n| project-rename NetworkRuleNumber=pid_d\\r\\n| extend Rule = \\\"NetworkRuleNumber\\\"\\r\\n| project-rename ThreatId=threatID_d\\r\\n| extend ThreatName = NetworkRuleName\\r\\n| project-rename ThreatCategory=dtProduct_s\\r\\n| extend ThreatRiskLevel=EventSeverity\\r\\n| project-rename SrcIpAddr=SourceIP\\r\\n| project-rename SrcHostname=hostname_s\\r\\n| project-rename SrcMacAddr=sourceMac_s\\r\\n| project-rename SrcPortNumber=sourcePort_s\\r\\n| project-rename DstIpAddr=destIP_s\\r\\n| project-rename DstPortNumber=destPort_s\\r\\n| project-rename DstHostname=destHost_s\\r\\n| project-rename DstMacAddr=destMac_s\\r\\n| extend MitreTechniques=parse_json(mitreTechniques_s)\\r\\n| project-rename DarktraceLink=breachUrl_s\\r\\n| where ThreatRiskLevel >= 75\\r\\n| limit 100\\r\\n| project TimeGenerated, NetworkRuleName, ThreatRiskLevel, ThreatId, DarktraceLink, SrcHostname, SrcIpAddr, DstHostname, DstIpAddr, EventStartTime, MitreTechniques\\r\\n| sort by TimeGenerated desc\\r\\n\\r\\n\",\"size\":0,\"title\":\"Critical Severity Model Breaches\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"formatOptions\":{\"customColumnWidthSetting\":\"20%\"}},{\"columnMatch\":\"Activity\",\"formatter\":1,\"formatOptions\":{\"linkColumn\":\"DarktraceURL\",\"linkTarget\":\"Url\",\"customColumnWidthSetting\":\"40%\"}},{\"columnMatch\":\"DeviceName\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"DeviceAddress\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"Severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\">\",\"thresholdValue\":\"0\",\"representation\":\"red\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"DarktraceURL\",\"formatter\":5},{\"columnMatch\":\"LogSeverity\",\"formatter\":8,\"formatOptions\":{\"min\":1,\"max\":10,\"palette\":\"greenRed\"}},{\"columnMatch\":\"DarktraceUrl\",\"formatter\":5,\"formatOptions\":{\"linkTarget\":\"Url\"}},{\"columnMatch\":\"AdditionalExtensions\",\"formatter\":5,\"formatOptions\":{\"customColumnWidthSetting\":\"70%\"}}],\"labelSettings\":[{\"columnId\":\"TimeGenerated\",\"label\":\"Time\"}]}},\"conditionalVisibility\":{\"parameterName\":\"_severity\",\"comparison\":\"isEqualTo\",\"value\":\"Critical\"},\"name\":\"Critical severity model breaches\"}]},\"conditionalVisibility\":{\"parameterName\":\"_severity\",\"comparison\":\"isNotEqualTo\",\"value\":\"hidden\"},\"name\":\"Drill down group for different severities\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"Policy Breach\\\" and modelName_s contains (\\\"SaaS\\\")\\r\\n| make-series count() default=0 on TimeGenerated in range({Timeframe:start}, now(), {Timeframe:grain})\",\"size\":3,\"title\":\"Total SaaS Model Breaches\",\"color\":\"orange\",\"timeContextFromParameter\":\"Timeframe\",\"timeBrushParameterName\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"count_\",\"label\":\"Model Breches\"}],\"ySettings\":{\"numberFormatSettings\":{\"unit\":0,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":0}}}}},\"customWidth\":\"50\",\"name\":\"saas user graph / time \",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"Policy Breach\\\" and modelName_s contains (\\\"IaaS\\\")\\r\\n| make-series count() default=0 on TimeGenerated in range({Timeframe:start}, now(), {Timeframe:grain})\",\"size\":3,\"title\":\"Total IaaS Model Breaches\",\"color\":\"orange\",\"timeContextFromParameter\":\"Timeframe\",\"timeBrushParameterName\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"count_\",\"label\":\"Model Breaches\"}],\"ySettings\":{\"numberFormatSettings\":{\"unit\":0,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":0}}}}},\"customWidth\":\"50\",\"name\":\"iaas user graph / time\",\"styleSettings\":{\"showBorder\":true}},{\"type\":1,\"content\":{\"json\":\"_ Selecting a timeframe on the graph will change the timeframe for all queries in this tab _\",\"style\":\"info\"},\"name\":\"text - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"Policy Breach\\\" and modelName_s contains (\\\"SaaS\\\")\\r\\n| project-rename NetworkRuleName=modelName_s\\r\\n| project-rename SrcHostname=hostname_s\\r\\n| summarize Count=count() by SrcHostname\\r\\n| top 10 by Count\\r\\n| project SrcHostname, Count\\r\\n\\r\\n\",\"size\":0,\"title\":\"Top 10 SaaS Users With Most Model Breaches\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":3,\"formatOptions\":{\"palette\":\"orange\"}},{\"columnMatch\":\"event_count\",\"formatter\":3,\"formatOptions\":{\"palette\":\"orange\"}},{\"columnMatch\":\"Activity\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"60ch\"}}]}},\"name\":\"most breached SaaS users\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"Policy Breach\\\" and modelName_s contains (\\\"SaaS\\\")\\r\\n| project-rename NetworkRuleName=modelName_s\\r\\n| project-rename SrcIpAddr=SourceIP\\r\\n| project-rename SrcHostname=hostname_s\\r\\n| project-rename DtURL=breachUrl_s\\r\\n| project-rename ThreatRiskLevel=score_d\\r\\n| project TimeGenerated, ThreatRiskLevel, NetworkRuleName, SrcHostname, SrcIpAddr, DtURL\\r\\n| top 10 by ThreatRiskLevel desc \",\"size\":0,\"title\":\"Top 10 Highest Severity SaaS Model Breaches\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"20%\"}},{\"columnMatch\":\"Activity\",\"formatter\":1,\"formatOptions\":{\"linkColumn\":\"DarktraceURL\",\"linkTarget\":\"Url\",\"customColumnWidthSetting\":\"40%\"}},{\"columnMatch\":\"DeviceName\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"DeviceAddress\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"17.5%\"}},{\"columnMatch\":\"Severity\",\"formatter\":8,\"formatOptions\":{\"min\":1,\"max\":10,\"palette\":\"yellowOrangeRed\"}},{\"columnMatch\":\"DarktraceURL\",\"formatter\":5}],\"labelSettings\":[{\"columnId\":\"TimeGenerated\",\"label\":\"Time\"}]}},\"name\":\"Top 10 hitting SaaS devices\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"Policy Breach\\\" and (modelName_s contains (\\\"SaaS\\\") or modelName_s contains (\\\"IaaS\\\")) and compliance_b == true\\r\\n| make-series count() default=0 on TimeGenerated in range({Timeframe:start}, now(), {Timeframe:grain})\",\"size\":0,\"title\":\"Total XaaS Compliance Model Breaches\",\"color\":\"orange\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"count_\",\"label\":\"Model Breaches\"}],\"ySettings\":{\"numberFormatSettings\":{\"unit\":0,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":0}}}}},\"name\":\"compliance breaches over time\"}],\"exportParameters\":true},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloud\"},\"name\":\"Cloud group\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"Policy Breach\\\" and modelName_s contains (\\\"Antigena\\\") and modelName_s contains (\\\"Network\\\")\\r\\n| project-rename SrcIpAddr=SourceIP\\r\\n| project-rename SrcHostname=hostname_s\\r\\n| project-rename DtURL=breachUrl_s\\r\\n| project-rename ThreatRiskLevel=score_d\\r\\n| project-rename NetworkRuleName=modelName_s\\r\\n| project-rename DstIpAddr=destIP_s\\r\\n| project-rename DstHostname=destHost_s\\r\\n| project-rename  EventStartTime = breachTime_s\\r\\n| extend DtMitreTechniques=parse_json(mitreTechniques_s)\\r\\n| project-rename ThreatId=threatID_d\\r\\n| limit 100\\r\\n| project TimeGenerated, ThreatRiskLevel, NetworkRuleName, ThreatId, SrcHostname, SrcIpAddr, DstHostname, DstIpAddr, DtURL, EventStartTime, DtMitreTechniques\\r\\n| sort by TimeGenerated desc\\r\\n\",\"size\":0,\"title\":\"/Network \",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"agnActivity\",\"formatter\":1,\"formatOptions\":{\"linkColumn\":\"DarktraceURL\",\"linkTarget\":\"Url\"}},\"subtitleContent\":{\"columnMatch\":\"TimeGenerated\",\"formatter\":6},\"leftContent\":{\"columnMatch\":\"Device\"},\"secondaryContent\":{\"columnMatch\":\"msgInfo\",\"formatter\":1},\"showBorder\":true,\"sortCriteriaField\":\"TimeGenerated\",\"sortOrderField\":2,\"size\":\"full\"}},\"name\":\"top level query \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\n| where dtProduct_s ==\\\"Policy Breach\\\" and modelName_s contains (\\\"Antigena\\\") and modelName_s contains (\\\"SaaS\\\")\\n| project-rename SrcIpAddr=SourceIP\\n| project-rename SrcHostname=hostname_s\\n| project-rename DtURL=breachUrl_s\\n| project-rename ThreatRiskLevel=score_d\\n| project-rename NetworkRuleName=modelName_s\\n| project-rename DstIpAddr=destIP_s\\n| project-rename DstHostname=destHost_s\\n| project-rename  EventStartTime = breachTime_s\\n| extend DtMitreTechniques=parse_json(mitreTechniques_s)\\n| project-rename ThreatId=threatID_d\\n| limit 100\\n| project TimeGenerated, ThreatRiskLevel, NetworkRuleName, ThreatId, SrcHostname, SrcIpAddr, DstHostname, DstIpAddr, DtURL, EventStartTime, DtMitreTechniques\\n| sort by TimeGenerated desc\\n\",\"size\":0,\"title\":\"/Apps\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1\"}]},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"agn\"},\"name\":\"agn group\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"cd64e441-332e-4f47-8602-a25828ebc053\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"aia_type\",\"label\":\"AI Analyst Incident Types\",\"type\":2,\"description\":\"Filter out the types of AI Analyst Incidents available.\",\"isRequired\":true,\"typeSettings\":{\"showDefault\":false},\"jsonData\":\"[\\n    {\\\"value\\\": \\\"darktrace_model_alerts_CL | where dtProduct_s =='AI Analyst' | project-rename DtIncidentName=title_s | project-rename DtCurrentGroup=externalId_g | project-rename GroupScore=groupScore_d | project-rename SrcDeviceName=bestDeviceName_s | limit 100 | summarize DtMaxIncidentScore=max(GroupScore), take_any(SrcDeviceName, DtIncidentName) by DtCurrentGroup | project DtMaxIncidentScore, DtIncidentName, SrcDeviceName, DtCurrentGroup\\\", \\\"label\\\": \\\"All\\\"},\\n    {\\\"value\\\": \\\"darktrace_model_alerts_CL | where dtProduct_s =='AI Analyst' | project-rename DtIncidentName=title_s | project-rename DtCurrentGroup=externalId_g | project-rename GroupScore=groupScore_d | project-rename SrcDeviceName=bestDeviceName_s | where SrcDeviceName !contains 'SaaS' | limit 100 | summarize DtMaxIncidentScore=max(GroupScore), take_any(SrcDeviceName, DtIncidentName) by DtCurrentGroup | project DtMaxIncidentScore, DtIncidentName, SrcDeviceName, DtCurrentGroup\\\", \\\"label\\\": \\\"Network\\\"},\\n    {\\\"value\\\": \\\"darktrace_model_alerts_CL | where dtProduct_s =='AI Analyst' | project-rename DtIncidentName=title_s | project-rename DtCurrentGroup=externalId_g | project-rename GroupScore=groupScore_d | project-rename SrcDeviceName=bestDeviceName_s | where SrcDeviceName contains 'SaaS' | limit 100 | summarize DtMaxIncidentScore=max(GroupScore), take_any(SrcDeviceName, DtIncidentName) by DtCurrentGroup | project DtMaxIncidentScore, DtIncidentName, SrcDeviceName, DtCurrentGroup\\\", \\\"label\\\": \\\"SaaS\\\"}\\n]\",\"timeContext\":{\"durationMs\":86400000},\"value\":\"darktrace_model_alerts_CL | where dtProduct_s =='AI Analyst' | project-rename DtIncidentName=title_s | project-rename DtCurrentGroup=externalId_g | project-rename GroupScore=groupScore_d | project-rename SrcDeviceName=bestDeviceName_s | limit 100 | summarize DtMaxIncidentScore=max(GroupScore), take_any(SrcDeviceName, DtIncidentName) by DtCurrentGroup | project DtMaxIncidentScore, DtIncidentName, SrcDeviceName, DtCurrentGroup\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{aia_type}\",\"size\":0,\"title\":\"AI Analyst Incidents\",\"timeContextFromParameter\":\"Timeframe\",\"exportFieldName\":\"DtCurrentGroup\",\"exportParameterName\":\"SelectedAIAGroup\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 7\"},{\"type\":1,\"content\":{\"json\":\"_ Selecting an AI Analyst Incident in the table above will put its corresponding Events in focus below _\",\"style\":\"info\"},\"name\":\"text - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\n| where dtProduct_s ==\\\"AI Analyst\\\"\\n| project-rename  EventStartTime=startTime_s\\n| project-rename EventEndTime = endTime_s\\n| project-rename DtIncidentEventName=title_s\\n| project-rename DtCurrentGroup=externalId_g //externalId is the Current Group ID from Darktrace \\n| project-rename ThreatCategory=dtProduct_s\\n| extend ThreatRiskLevel=score_d //This is the event score, which is different from the GroupScore\\n| project-rename SrcHostname=hostname_s\\n| project-rename DtURL=url_s\\n| project-rename DtSummary=summary_s\\n| project-rename DtGroupScore=groupScore_d\\n| project-rename DtGroupCategory=groupCategory_s\\n| project-rename SrcDeviceName=bestDeviceName_s\\n| where DtCurrentGroup contains \\\"{SelectedAIAGroup}\\\"\\n| limit 100\\n| project TimeGenerated, DtIncidentEventName, ThreatCategory, ThreatRiskLevel, DtSummary, SrcDeviceName, SrcHostname, DtURL, DtCurrentGroup, DtGroupScore, DtGroupCategory, EventStartTime, EventEndTime\\n| sort by TimeGenerated desc\\n\\n\",\"size\":0,\"title\":\"Selected AI Analyst Incident Events\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\"},\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"AI Analyst\\\"\\r\\n| make-series count() default=0 on TimeGenerated in range({Timeframe:start}, now(), {Timeframe:grain})\",\"size\":3,\"title\":\"Total AI Analyst Incident Events\",\"color\":\"lightBlue\",\"timeContextFromParameter\":\"Timeframe\",\"timeBrushParameterName\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\",\"chartSettings\":{\"showMetrics\":false,\"ySettings\":{\"numberFormatSettings\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"minimumFractionDigits\":0,\"maximumFractionDigits\":0}}}}},\"name\":\"incidents in group\"},{\"type\":1,\"content\":{\"json\":\"_ Selecting a timeframe on the graph will change the timeframe for all queries in this tab _\",\"style\":\"info\"},\"name\":\"text - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\r\\n| where dtProduct_s ==\\\"AI Analyst\\\"\\r\\n| extend DtIncidentEventName = title_s\\r\\n| summarize event_count=count() by DtIncidentEventName\\r\\n| top 10 by event_count\",\"size\":0,\"title\":\"Top 10 Most Frequent AI Analyst Incident Events\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"event_count\",\"formatter\":3,\"formatOptions\":{\"palette\":\"blue\"}}],\"labelSettings\":[{\"columnId\":\"event_count\",\"label\":\"Count\"}]}},\"name\":\"Top 10 Most Frequent Incidents\"}],\"exportParameters\":true},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"ai-analyst\"},\"name\":\"ai- analyst group \"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\n| where dtProduct_s == \\\"Antigena Email\\\"\\n| extend Actions = parse_json(actions_s)\\n| extend Hold_Email=set_has_element(Actions, \\\"Hold\\\")\\n| extend Junk_Email=set_has_element(Actions, \\\"Move to Junk\\\")\\n| extend Lock_Link=set_has_element(Actions, \\\"Lock All Links\\\")\\n| extend Double_Lock_Link=set_has_element(Actions, \\\"Double Lock All Links\\\")\\n| extend Strip_Attachment=set_has_element(Actions, \\\"Stip All Attachments\\\")\\n| extend Convert_Attachment=set_has_element(Actions, \\\"Convert All Attachments\\\")\\n| extend Unspoof=set_has_element(Actions, \\\"Unspoof\\\")\\n| extend XAxis=set_has_element(Actions, \\\"Unspoof\\\")\\n| summarize XAxis=countif(XAxis == true), Hold_Email=countif(Hold_Email == true), Junk_Email=countif(Junk_Email == true), Lock_Link=countif(Lock_Link == true), Double_Lock_Link=countif(Double_Lock_Link == true), Convert_Attachment=countif(Convert_Attachment == true), Strip_Attachment=countif(Strip_Attachment == true), Unspoof=countif(Unspoof == true)\",\"size\":0,\"title\":\"Total Actions Taken\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"categoricalbar\",\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"Hold_Email\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"Hold_Email\",\"sortOrder\":2}],\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":0},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Junk_Email\",\"label\":\"Junk Email\",\"color\":\"redBright\"},{\"seriesName\":\"Lock_Link\",\"label\":\"Lock Link\",\"color\":\"lightBlue\"},{\"seriesName\":\"Double_Lock_Link\",\"label\":\"Double Lock Link\",\"color\":\"blueDark\"},{\"seriesName\":\"Strip_Attachment\",\"label\":\"Strip Attachment\",\"color\":\"greenDarkDark\"},{\"seriesName\":\"Convert_Attachment\",\"label\":\"Convert Attachment\",\"color\":\"green\"},{\"seriesName\":\"Unspoof\",\"label\":\"Unspoof\",\"color\":\"pink\"},{\"seriesName\":\"Hold_Email\",\"label\":\"Hold Email\",\"color\":\"redDark\"}]},\"mapSettings\":{\"locInfo\":\"LatLong\",\"sizeSettings\":\"Hold_Email\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"Hold_Email\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"type\":\"heatmap\",\"colorAggregation\":\"Sum\",\"nodeColorField\":\"Hold_Email\",\"heatmapPalette\":\"greenRed\"}}},\"name\":\"query - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"ac642d55-be90-4144-8bc3-ce0cb7fcc161\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SearchRecipient\",\"label\":\"Search Recipient\",\"type\":1,\"description\":\"Filter for held emails\",\"value\":\"\",\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\n| where dtProduct_s == \\\"Antigena Email\\\"\\n| extend Actions = parse_json(actions_s)\\n| extend Hold_Email=set_has_element(Actions, \\\"Hold\\\")\\n| where Hold_Email == true \\n| extend Recipients=parse_json(recipients_s)\\n| where Recipients contains \\\"{SearchRecipient}\\\"\\n| project-rename ThreatRiskLevel=anomaly_score_d\\n| project-rename AttachmentSHA1s=attachment_sha1s_s\\n| project-rename Sender=from_s\\n| project-rename Subject=subject_s\\n| project-rename Tags=tags_s\\n| project-rename TimestampUTC=timestamp_t\\n| project-rename UUID=uuid_s\\n| project-rename DarktraceLink=url_s\\n| project-rename Direction=direction_s\\n| project Subject, Sender, Recipients, ThreatRiskLevel, TimestampUTC, Direction, Tags, AttachmentSHA1s, DarktraceLink, UUID\",\"size\":0,\"title\":\"Held Emails\",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL\\n| where dtProduct_s == \\\"Antigena Email\\\"\\n| where direction_s == \\\"inbound\\\"\\n| project-rename Sender=from_s\\n| summarize Count=count() by Sender\\n| top 10 by Count\",\"size\":0,\"title\":\"Top 10 Most Frequent External Senders \",\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":3,\"formatOptions\":{\"palette\":\"orange\"}},{\"columnMatch\":\"event_count\",\"formatter\":3,\"formatOptions\":{\"palette\":\"orange\"}}]}},\"name\":\"query - 1\"}]},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"email\"},\"name\":\"group - 7\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"darktrace_model_alerts_CL //anything starting with 'Dt' is not an ASIM mapping \\n| where dtProduct_s ==\\\"System Alert\\\"\\n| extend EventVendor = \\\"Darktrace\\\"\\n| extend EventProduct = \\\"Darktrace DETECT\\\"\\n| project-rename NetworkRuleName=friendlyName_s\\n| project-rename ThreatRiskLevel=priority_code_d\\n| project-rename ThreatRiskCategory=priority_s\\n| project-rename EventStartTime = time_s\\n| project-rename SrcIpAddr=deviceIP_s\\n| project-rename SrcHostname=hostname_s\\n| project-rename DtStatus=status_s\\n| project-rename DtURL=url_s\\n| project-rename DtSeverity=Severity\\n| project-rename DtName=name_s\\n| project-rename DtMessage=Message\\n| project EventVendor, EventProduct, NetworkRuleName, ThreatRiskLevel, ThreatRiskCategory, SrcIpAddr, SrcHostname, DtStatus, DtURL, DtName, DtMessage\",\"size\":0,\"timeContextFromParameter\":\"Timeframe\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 0\"}]},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"status\"},\"name\":\"group - 8\"}],\"fromTemplateId\":\"sentinel-Darktrace\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                                "version": "1.0",
                                "sourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
                                "category": "sentinel"
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(resourceId('Microsoft.Insights/workbooks', 'DarktraceWorkbook'),'/'))))]",
                            "properties": {
                                "description": "@{workbookKey=DarktraceWorkbook; logoFileName=Darktrace.svg; description=The Darktrace Workbook visualises Model Breach and AI Analyst data received by the Darktrace Data Connector and visualises events across the network, SaaS, IaaS and Email.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.1; title=Darktrace; templateRelativePath=DarktraceWorkbook.json; subtitle=; provider=Darktrace}.description",
                                "parentId": "[resourceId('Microsoft.Insights/workbooks', 'DarktraceWorkbook')]",
                                "contentId": "DarktraceWorkbook",
                                "kind": "Workbook",
                                "version": "1.0.1",
                                "source": {
                                    "kind": "Solution",
                                    "name": "Darktrace",
                                    "sourceId": "darktrace1655286944672.darktrace_for_sentinel"
                                },
                                "author": {
                                    "name": "Darktrace"
                                },
                                "support": {
                                    "tier": "Partner",
                                    "name": "Darktrace",
                                    "link": "https://www.darktrace.com/en/contact/"
                                },
                                "dependencies": {
                                    "operator": "AND",
                                    "criteria": [
                                        {
                                            "contentId": "darktrace_model_alerts_CL",
                                            "kind": "DataType"
                                        },
                                        {
                                            "contentId": "DarktraceRESTConnector",
                                            "kind": "DataConnector"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "2.0.1",
                "packageName": "Darktrace",
                "packageId": "darktrace1655286944672.darktrace_for_sentinel",
                "contentProductId": "darktrace1655286944672.darktrace_for_sentinel-wb-qfluhpkmn55wu",
                "id": "darktrace1655286944672.darktrace_for_sentinel-wb-qfluhpkmn55wu",
                "contentSchemaVersion": "3.0.0",
                "version": "1.0.1",
                "isDeprecated": false
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-ar-',uniquestring('a3c7b8ed-56a9-47b7-98e5-2555c16e17c9')),'1.1.0'))]",
            "location": "[parameters('workspace-location')]",
            "apiVersion": "2023-04-01-preview",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'darktrace1655286944672.darktrace_for_sentinel')]"
            ],
            "properties": {
                "contentId": "a3c7b8ed-56a9-47b7-98e5-2555c16e17c9",
                "displayName": "Darktrace Model Breach",
                "contentKind": "AnalyticsRule",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.1.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "a3c7b8ed-56a9-47b7-98e5-2555c16e17c9",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "NRT",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "This rule creates Microsoft Sentinel Alerts based on Darktrace Model Breaches, fetched every 5 minutes.",
                                "displayName": "Darktrace Model Breach",
                                "enabled": false,
                                "query": "darktrace_model_alerts_CL \n| where dtProduct_s ==\"Policy Breach\"\n| project-rename EventSeverity=score_d, EventStartTime=breachTime_s, NetworkRuleName=modelName_s, NetworkRuleNumber=pid_d, ThreatId=threatID_d, ThreatCategory=dtProduct_s, SrcIpAddr=SourceIP, SrcHostname=hostname_s, SrcMacAddr=sourceMac_s, SrcPortNumber=sourcePort_s, DstIpAddr=destIP_s, DstPortNumber=destPort_s, DstHostname=destHost_s, DstMacAddr=destMac_s, DtCompliance=compliance_b, DtClientSensor=cSensor_b, DtDescription=description_s, DtAntigena=antigena_b, DtDeviceID=deviceId_d, DtSubnetID=sid_d, DtTags=tags_s, DtMitreTechniques=mitreTechniques_s, DtMessage=Message, DtUUID=uuid_g, DtBreachURL=breachUrl_s, DtSrcTypeLabel=typeLabel_s, DtTriggeredComponents=triggeredComponents_s, DtDetails=details_s, DtLongitude=longitude_d, DtLatitude=latitude_d, DtCategory=Category\n| extend EventCount=1, EventType=\"NetworkSession\", EventSchema=\"NetworkSession\", EventSchemaVersion=\"0.2.2\", EventResult=\"Success\", DvcAction = \"Allow\", EventVendor = \"Darktrace\", EventProduct = \"Darktrace DETECT\", EventEndTime=EventStartTime, ThreatName=NetworkRuleName, ThreatRiskLevel=EventSeverity\n| extend DtSentinelCategory = case(DtCategory == \"Suspicious\", \"Medium\", \n                                  DtCategory == \"Critical\", \"High\",\n                                  \"Informational\") \n",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "DarktraceRESTConnector",
                                        "dataTypes": [
                                            "darktrace_model_alerts_CL"
                                        ]
                                    }
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "HostName",
                                                "columnName": "SrcHostname"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "HostName",
                                                "columnName": "DstHostname"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "SrcIpAddr"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "DstIpAddr"
                                            }
                                        ],
                                        "entityType": "IP"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "DstPortNumber": "DstPortNumber",
                                    "SrcMacAddr": "SrcMacAddr",
                                    "EventSeverity": "EventSeverity",
                                    "DstMacAddr": "DstMacAddr",
                                    "DtCompliance": "DtCompliance",
                                    "DtDeviceID": "DtDeviceID",
                                    "DtCategory": "DtCategory",
                                    "NetworkRuleName": "NetworkRuleName",
                                    "SrcPortNumber": "SrcPortNumber",
                                    "DtDescription": "DtDescription",
                                    "NetworkRuleNumber": "NetworkRuleNumber",
                                    "ThreatId": "ThreatId",
                                    "DtSentinelCategory": "DtSentinelCategory",
                                    "EventStartTime": "EventStartTime"
                                },
                                "alertDetailsOverride": {
                                    "alertDynamicProperties": [
                                        {
                                            "alertProperty": "AlertLink",
                                            "value": "DtBreachURL"
                                        },
                                        {
                                            "alertProperty": "ProviderName",
                                            "value": "EventVendor"
                                        },
                                        {
                                            "alertProperty": "ProductName",
                                            "value": "EventProduct"
                                        },
                                        {
                                            "alertProperty": "ProductComponentName",
                                            "value": "ThreatCategory"
                                        },
                                        {
                                            "alertProperty": "Severity",
                                            "value": "DtSentinelCategory"
                                        }
                                    ],
                                    "alertDescriptionFormat": "{{DtMessage}}",
                                    "alertSeverityColumnName": null,
                                    "alertTacticsColumnName": null,
                                    "alertDisplayNameFormat": "Darktrace: {{ThreatRiskLevel}} - {{NetworkRuleName}}"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'a3c7b8ed-56a9-47b7-98e5-2555c16e17c9'),'/'))))]",
                            "properties": {
                                "description": "Darktrace Analytics Rule 1",
                                "parentId": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'a3c7b8ed-56a9-47b7-98e5-2555c16e17c9')]",
                                "contentId": "a3c7b8ed-56a9-47b7-98e5-2555c16e17c9",
                                "kind": "AnalyticsRule",
                                "version": "1.1.0",
                                "source": {
                                    "kind": "Solution",
                                    "name": "Darktrace",
                                    "sourceId": "darktrace1655286944672.darktrace_for_sentinel"
                                },
                                "author": {
                                    "name": "Darktrace"
                                },
                                "support": {
                                    "tier": "Partner",
                                    "name": "Darktrace",
                                    "link": "https://www.darktrace.com/en/contact/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "2.0.1",
                "packageName": "Darktrace",
                "packageId": "darktrace1655286944672.darktrace_for_sentinel",
                "contentProductId": "darktrace1655286944672.darktrace_for_sentinel-ar-etrop7xu54peq",
                "id": "darktrace1655286944672.darktrace_for_sentinel-ar-etrop7xu54peq",
                "contentSchemaVersion": "3.0.0",
                "version": "1.1.0",
                "isDeprecated": false,
                "dependencies": {
                    "operator": "AND",
                    "criteria": [
                        {
                            "contentKind": "DataType",
                            "contentId": "darktrace_model_alerts_CL"
                        },
                        {
                            "contentKind": "DataConnector",
                            "contentId": "DarktraceRESTConnector"
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-ar-',uniquestring('ffa2977f-3077-4bba-b1bf-f3417699cbb0')),'1.1.0'))]",
            "location": "[parameters('workspace-location')]",
            "apiVersion": "2023-04-01-preview",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'darktrace1655286944672.darktrace_for_sentinel')]"
            ],
            "properties": {
                "contentId": "ffa2977f-3077-4bba-b1bf-f3417699cbb0",
                "displayName": "Darktrace AI Analyst",
                "contentKind": "AnalyticsRule",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.1.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "ffa2977f-3077-4bba-b1bf-f3417699cbb0",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "NRT",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "This rule creates Microsoft Sentinel Incidents based on Darktrace AI Analyst Incidents, fetched every 5 minutes.",
                                "displayName": "Darktrace AI Analyst",
                                "enabled": false,
                                "query": "darktrace_model_alerts_CL \n| where dtProduct_s ==\"AI Analyst\"\n| project-rename  EventStartTime=startTime_s, EventEndTime = endTime_s, NetworkRuleName=title_s, DtCurrentGroup=externalId_g, ThreatCategory=dtProduct_s, ThreatRiskLevel=score_d, SrcHostname=hostname_s, SrcIpAddr=deviceIP_s, DtURL=url_s, DtSummary=summary_s, DtGroupScore=groupScore_d, DtGroupCategory=groupCategory_s, DtSrcDeviceName=bestDeviceName_s, DtIndentifier=identifier_s, ActivityID=activityId_s, DtGroupingID=groupingId_s, DtGroupByActivity=groupByActivity_b, DtSummaryFirstSentence=summaryFirstSentence_s, DtNewEvent=newEvent_b, DtCGLegacy=currentGroup_s, DtGroupPreviousGroups=groupPreviousGroups_s, DtTime=time_s, DtSeverity=Severity, DtLongitude=longitude_d, DtLatitude=latitude_d  \n| extend EventVendor = \"Darktrace\", EventProduct = \"Darktrace DETECT\", DtSentinelCategory=DtGroupCategory\n| extend DtSentinelCategory = case (DtGroupCategory == \"compliance\", \"Low\", \n                                    DtGroupCategory == \"suspicious\", \"Medium\",\n                                    \"High\") //compliance -> low, suspcious -> medium, critical -> high\n",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "DarktraceRESTConnector",
                                        "dataTypes": [
                                            "darktrace_model_alerts_CL"
                                        ]
                                    }
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "HostName",
                                                "columnName": "SrcHostname"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "SrcIpAddr"
                                            }
                                        ],
                                        "entityType": "IP"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "DtNewEvent": "DtNewEvent",
                                    "DtGroupCategory": "DtGroupCategory",
                                    "DtSrcDeviceName": "DtSrcDeviceName",
                                    "DtSentinelCategory": "DtSentinelCategory",
                                    "DtSummary": "DtSummary",
                                    "EventEndTime": "EventEndTime",
                                    "DtGroupScore": "DtGroupScore",
                                    "NetworkRuleName": "NetworkRuleName",
                                    "ThreatRiskLevel": "ThreatRiskLevel",
                                    "DtSeverity": "DtSeverity",
                                    "EventStartTime": "EventStartTime",
                                    "DtCurrentGroup": "DtCurrentGroup"
                                },
                                "alertDetailsOverride": {
                                    "alertDynamicProperties": [
                                        {
                                            "alertProperty": "AlertLink",
                                            "value": "DtURL"
                                        },
                                        {
                                            "alertProperty": "ProviderName",
                                            "value": "EventVendor"
                                        },
                                        {
                                            "alertProperty": "ProductName",
                                            "value": "EventProduct"
                                        },
                                        {
                                            "alertProperty": "ProductComponentName",
                                            "value": "ThreatCategory"
                                        },
                                        {
                                            "alertProperty": "Severity",
                                            "value": "DtSentinelCategory"
                                        }
                                    ],
                                    "alertDescriptionFormat": "{{DtSummary}}",
                                    "alertSeverityColumnName": null,
                                    "alertTacticsColumnName": null,
                                    "alertDisplayNameFormat": "Darktrace: {{ThreatRiskLevel}} - {{NetworkRuleName}}"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'ffa2977f-3077-4bba-b1bf-f3417699cbb0'),'/'))))]",
                            "properties": {
                                "description": "Darktrace Analytics Rule 2",
                                "parentId": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'ffa2977f-3077-4bba-b1bf-f3417699cbb0')]",
                                "contentId": "ffa2977f-3077-4bba-b1bf-f3417699cbb0",
                                "kind": "AnalyticsRule",
                                "version": "1.1.0",
                                "source": {
                                    "kind": "Solution",
                                    "name": "Darktrace",
                                    "sourceId": "darktrace1655286944672.darktrace_for_sentinel"
                                },
                                "author": {
                                    "name": "Darktrace"
                                },
                                "support": {
                                    "tier": "Partner",
                                    "name": "Darktrace",
                                    "link": "https://www.darktrace.com/en/contact/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "2.0.1",
                "packageName": "Darktrace",
                "packageId": "darktrace1655286944672.darktrace_for_sentinel",
                "contentProductId": "darktrace1655286944672.darktrace_for_sentinel-ar-egbvwigrzuplu",
                "id": "darktrace1655286944672.darktrace_for_sentinel-ar-egbvwigrzuplu",
                "contentSchemaVersion": "3.0.0",
                "version": "1.1.0",
                "isDeprecated": false,
                "dependencies": {
                    "operator": "AND",
                    "criteria": [
                        {
                            "contentKind": "DataType",
                            "contentId": "darktrace_model_alerts_CL"
                        },
                        {
                            "contentKind": "DataConnector",
                            "contentId": "DarktraceRESTConnector"
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-ar-',uniquestring('2e629769-60eb-4a14-8bfc-bde9be66ebeb')),'1.1.0'))]",
            "location": "[parameters('workspace-location')]",
            "apiVersion": "2023-04-01-preview",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'darktrace1655286944672.darktrace_for_sentinel')]"
            ],
            "properties": {
                "contentId": "2e629769-60eb-4a14-8bfc-bde9be66ebeb",
                "displayName": "Darktrace System Status",
                "contentKind": "AnalyticsRule",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.1.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "2e629769-60eb-4a14-8bfc-bde9be66ebeb",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "This rule creates Microsoft Sentinel Alerts based on Darktrace system status alerts for health monitoring, fetched every 5 minutes.",
                                "displayName": "Darktrace System Status",
                                "enabled": false,
                                "query": "darktrace_model_alerts_CL //anything starting with 'Dt' is not an ASIM mapping \n| where dtProduct_s ==\"System Alert\"\n| extend EventVendor=\"Darktrace\", EventProduct=\"Darktrace DETECT\"\n| project-rename ThreatCategory=dtProduct_s, EventStartTime=time_s, NetworkRuleName=friendlyName_s, SrcIpAddr=deviceIP_s, SrcHostname=hostname_s, ThreatRiskLevel=priority_code_d, ThreatRiskCategory=priority_s, DtSeverity=Severity, DtName=name_s, DtStatus=status_s, DtMessage=Message, DtURL=url_s, DtUUID=uuid_g\n",
                                "queryFrequency": "PT5M",
                                "queryPeriod": "PT5M",
                                "severity": "Informational",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "DarktraceRESTConnector",
                                        "dataTypes": [
                                            "darktrace_model_alerts_CL"
                                        ]
                                    }
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "HostName",
                                                "columnName": "SrcHostname"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "SrcIpAddr"
                                            }
                                        ],
                                        "entityType": "IP"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "EventStartTime": "EventStartTime",
                                    "DtSeverity": "DtSeverity",
                                    "DtName": "DtName",
                                    "DtMessage": "DtMessage",
                                    "NetworkRuleName": "NetworkRuleName",
                                    "ThreatRiskLevel": "ThreatRiskLevel",
                                    "DtStatus": "DtStatus",
                                    "ThreatRiskCategory": "ThreatRiskCategory"
                                },
                                "alertDetailsOverride": {
                                    "alertDynamicProperties": [
                                        {
                                            "alertProperty": "AlertLink",
                                            "value": "DtURL"
                                        },
                                        {
                                            "alertProperty": "ProviderName",
                                            "value": "EventVendor"
                                        },
                                        {
                                            "alertProperty": "ProductName",
                                            "value": "EventProduct"
                                        },
                                        {
                                            "alertProperty": "ProductComponentName",
                                            "value": "ThreatCategory"
                                        }
                                    ],
                                    "alertDescriptionFormat": "{{DtMessage}}",
                                    "alertSeverityColumnName": null,
                                    "alertTacticsColumnName": null,
                                    "alertDisplayNameFormat": "Darktrace: {{ThreatRiskLevel}} - {{NetworkRuleName}}"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '2e629769-60eb-4a14-8bfc-bde9be66ebeb'),'/'))))]",
                            "properties": {
                                "description": "Darktrace Analytics Rule 3",
                                "parentId": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '2e629769-60eb-4a14-8bfc-bde9be66ebeb')]",
                                "contentId": "2e629769-60eb-4a14-8bfc-bde9be66ebeb",
                                "kind": "AnalyticsRule",
                                "version": "1.1.0",
                                "source": {
                                    "kind": "Solution",
                                    "name": "Darktrace",
                                    "sourceId": "darktrace1655286944672.darktrace_for_sentinel"
                                },
                                "author": {
                                    "name": "Darktrace"
                                },
                                "support": {
                                    "tier": "Partner",
                                    "name": "Darktrace",
                                    "link": "https://www.darktrace.com/en/contact/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "2.0.1",
                "packageName": "Darktrace",
                "packageId": "darktrace1655286944672.darktrace_for_sentinel",
                "contentProductId": "darktrace1655286944672.darktrace_for_sentinel-ar-xavq55guv4ktm",
                "id": "darktrace1655286944672.darktrace_for_sentinel-ar-xavq55guv4ktm",
                "contentSchemaVersion": "3.0.0",
                "version": "1.1.0",
                "isDeprecated": false,
                "dependencies": {
                    "operator": "AND",
                    "criteria": [
                        {
                            "contentKind": "DataType",
                            "contentId": "darktrace_model_alerts_CL"
                        },
                        {
                            "contentKind": "DataConnector",
                            "contentId": "DarktraceRESTConnector"
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(concat(parameters('workspace'),'-dc-',uniquestring('DarktraceRESTConnector')),'1.0.0'))]",
            "location": "[parameters('workspace-location')]",
            "apiVersion": "2023-04-01-preview",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'darktrace1655286944672.darktrace_for_sentinel')]"
            ],
            "properties": {
                "contentId": "DarktraceRESTConnector",
                "displayName": "Darktrace Connector for Microsoft Sentinel REST API",
                "contentKind": "DataConnector",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/','DarktraceRESTConnector')]",
                            "apiVersion": "2021-03-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
                            "location": "[parameters('workspace-location')]",
                            "kind": "GenericUI",
                            "properties": {
                                "connectorUiConfig": {
                                    "id": "DarktraceRESTConnector",
                                    "title": "Darktrace Connector for Microsoft Sentinel REST API",
                                    "publisher": "Darktrace",
                                    "descriptionMarkdown": "The Darktrace REST API connector pushes real-time events from Darktrace to Microsoft Sentinel and is designed to be used with the Darktrace Solution for Sentinel. The connector writes logs to a custom log table titled \"darktrace_model_alerts_CL\"; Model Breaches, AI Analyst Incidents, System Alerts and Email Alerts can be ingested - additional filters can be set up on the Darktrace System Configuration page. Data is pushed to Sentinel from Darktrace masters.",
                                    "graphQueries": [
                                        {
                                            "metricName": "Total data received",
                                            "legend": "darktrace_model_alerts_CL",
                                            "baseQuery": "darktrace_model_alerts_CL"
                                        }
                                    ],
                                    "sampleQueries": [
                                        {
                                            "description": "Look for Test Alerts",
                                            "query": "darktrace_model_alerts_CL\n            | where modelName_s == \"Unrestricted Test Model\""
                                        },
                                        {
                                            "description": "Return Top Scoring Darktrace Model Breaches",
                                            "query": "darktrace_model_alerts_CL\n            | where dtProduct_s ==\"Policy Breach\"\n            | project-rename SrcIpAddr=SourceIP\n            | project-rename SrcHostname=hostname_s\n            | project-rename DarktraceLink=breachUrl_s\n           | project-rename ThreatRiskLevel=score_d\n            | project-rename NetworkRuleName=modelName_s\n            | project TimeGenerated, NetworkRuleName, SrcHostname, SrcIpAddr, ThreatRiskLevel\n            | top 10 by ThreatRiskLevel desc"
                                        },
                                        {
                                            "description": "Return AI Analyst Incidents",
                                            "query": "darktrace_model_alerts_CL\n            | where dtProduct_s == \"AI Analyst\"\n            | project-rename  EventStartTime=startTime_s\n            | project-rename EventEndTime = endTime_s\n            | project-rename NetworkRuleName=title_s\n            | project-rename CurrentGroup=externalId_g //externalId is the Current Group ID from Darktrace\n            | project-rename ThreatCategory=dtProduct_s\n            | extend ThreatRiskLevel=score_d //This is the event score, which is different from the GroupScore\n            | project-rename SrcHostname=hostname_s\n            | project-rename DarktraceLink=url_s\n            | project-rename Summary=summary_s\n            | project-rename GroupScore=groupScore_d\n            | project-rename GroupCategory=groupCategory_s\n            | project-rename SrcDeviceName=bestDeviceName_s"
                                        },
                                        {
                                            "description": "Return System Health Alerts",
                                            "query": "  darktrace_model_alerts_CL\n            | where dtProduct_s == \"System Alert\""
                                        },
                                        {
                                            "description": "Return email Logs for a specific external sender (example@test.com)",
                                            "query": "darktrace_model_alerts_CL\n             | where dtProduct_s == 'Antigena Email'\n        | where from_s == 'example@test.com'"
                                        }
                                    ],
                                    "dataTypes": [
                                        {
                                            "name": "darktrace_model_alerts_CL",
                                            "lastDataReceivedQuery": "darktrace_model_alerts_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                                        }
                                    ],
                                    "connectivityCriterias": [
                                        {
                                            "type": "IsConnectedQuery",
                                            "value": [
                                                "darktrace_model_alerts_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
                                            ]
                                        }
                                    ],
                                    "availability": {
                                        "status": 1,
                                        "isPreview": false
                                    },
                                    "permissions": {
                                        "resourceProvider": [
                                            {
                                                "provider": "Microsoft.OperationalInsights/workspaces",
                                                "permissionsDisplayText": "read and write permissions are required.",
                                                "providerDisplayName": "Workspace",
                                                "scope": "Workspace",
                                                "requiredPermissions": {
                                                    "write": true,
                                                    "read": true,
                                                    "delete": true
                                                }
                                            },
                                            {
                                                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                                                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                                                "providerDisplayName": "Keys",
                                                "scope": "Workspace",
                                                "requiredPermissions": {
                                                    "action": true
                                                }
                                            }
                                        ],
                                        "customs": [
                                            {
                                                "name": "Darktrace Prerequisites",
                                                "description": "To use this Data Connector a Darktrace master running v5.2+ is required.\n Data is sent to the [Azure Monitor HTTP Data Collector API](https://docs.microsoft.com/azure/azure-monitor/logs/data-collector-api) over HTTPs from Darktrace masters, therefore outbound connectivity from the Darktrace master to Microsoft Sentinel REST API is required."
                                            },
                                            {
                                                "name": "Filter Darktrace Data",
                                                "description": "During configuration it is possible to set up additional filtering on the Darktrace System Configuration page to constrain the amount or types of data sent."
                                            },
                                            {
                                                "name": "Try the Darktrace Sentinel Solution",
                                                "description": "You can get the most out of this connector by installing the Darktrace Solution for Microsoft Sentinel. This will provide workbooks to visualise alert data and analytics rules to automatically create alerts and incidents from Darktrace Model Breaches and AI Analyst incidents."
                                            }
                                        ]
                                    },
                                    "instructionSteps": [
                                        {
                                            "description": "1. Detailed setup instructions can be found on the Darktrace Customer Portal: https://customerportal.darktrace.com/product-guides/main/microsoft-sentinel-introduction\n 2. Take note of the Workspace ID and the Primary key. You will need to enter these details on your Darktrace System Configuration page.\n ",
                                            "instructions": [
                                                {
                                                    "parameters": {
                                                        "fillWith": [
                                                            "WorkspaceId"
                                                        ],
                                                        "label": "Workspace ID"
                                                    },
                                                    "type": "CopyableLabel"
                                                },
                                                {
                                                    "parameters": {
                                                        "fillWith": [
                                                            "PrimaryKey"
                                                        ],
                                                        "label": "Primary Key"
                                                    },
                                                    "type": "CopyableLabel"
                                                }
                                            ]
                                        },
                                        {
                                            "description": "1. Perform the following steps on the Darktrace System Configuration page:\n 2. Navigate to the System Configuration Page (Main Menu > Admin > System Config)\n 3. Go into Modules configuration and click on the \"Microsoft Sentinel\" configuration card\n 4. Select \"HTTPS (JSON)\" and hit \"New\"\n 5. Fill in the required details and select appropriate filters\n 6. Click \"Verify Alert Settings\" to attempt authentication and send out a test alert\n 7. Run a \"Look for Test Alerts\" sample query to validate that the test alert has been received",
                                            "title": "Darktrace Configuration"
                                        }
                                    ],
                                    "metadata": {
                                        "id": "169a86e6-a4e2-4abc-a5c0-eece5d013204",
                                        "version": "1.0.0",
                                        "kind": "dataConnector",
                                        "source": {
                                            "kind": "solution",
                                            "name": "Darktrace"
                                        },
                                        "author": {
                                            "name": "Darktrace"
                                        },
                                        "support": {
                                            "tier": "developer",
                                            "name": "Darktrace",
                                            "link": "customerportal.darktrace.com"
                                        }
                                    }
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', 'DarktraceRESTConnector'),'/'))))]",
                            "properties": {
                                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', 'DarktraceRESTConnector')]",
                                "contentId": "DarktraceRESTConnector",
                                "kind": "DataConnector",
                                "version": "1.0.0",
                                "source": {
                                    "kind": "Solution",
                                    "name": "Darktrace",
                                    "sourceId": "darktrace1655286944672.darktrace_for_sentinel"
                                },
                                "author": {
                                    "name": "Darktrace"
                                },
                                "support": {
                                    "tier": "Partner",
                                    "name": "Darktrace",
                                    "link": "https://www.darktrace.com/en/contact/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "2.0.1",
                "packageName": "Darktrace",
                "packageId": "darktrace1655286944672.darktrace_for_sentinel",
                "contentProductId": "darktrace1655286944672.darktrace_for_sentinel-dc-pik5v23gwnzga",
                "id": "darktrace1655286944672.darktrace_for_sentinel-dc-pik5v23gwnzga",
                "contentSchemaVersion": "3.0.0",
                "version": "1.0.0",
                "isDeprecated": false
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', 'DarktraceRESTConnector'),'/'))))]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', 'DarktraceRESTConnector')]"
            ],
            "location": "[parameters('workspace-location')]",
            "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', 'DarktraceRESTConnector')]",
                "contentId": "DarktraceRESTConnector",
                "kind": "DataConnector",
                "version": "1.0.0",
                "source": {
                    "kind": "Solution",
                    "name": "Darktrace",
                    "sourceId": "darktrace1655286944672.darktrace_for_sentinel"
                },
                "author": {
                    "name": "Darktrace"
                },
                "support": {
                    "tier": "Partner",
                    "name": "Darktrace",
                    "link": "https://www.darktrace.com/en/contact/"
                }
            }
        },
        {
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/','DarktraceRESTConnector')]",
            "apiVersion": "2021-03-01-preview",
            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
            "location": "[parameters('workspace-location')]",
            "kind": "GenericUI",
            "properties": {
                "connectorUiConfig": {
                    "title": "Darktrace Connector for Microsoft Sentinel REST API",
                    "publisher": "Darktrace",
                    "descriptionMarkdown": "The Darktrace REST API connector pushes real-time events from Darktrace to Microsoft Sentinel and is designed to be used with the Darktrace Solution for Sentinel. The connector writes logs to a custom log table titled \"darktrace_model_alerts_CL\"; Model Breaches, AI Analyst Incidents, System Alerts and Email Alerts can be ingested - additional filters can be set up on the Darktrace System Configuration page. Data is pushed to Sentinel from Darktrace masters.",
                    "graphQueries": [
                        {
                            "metricName": "Total data received",
                            "legend": "darktrace_model_alerts_CL",
                            "baseQuery": "darktrace_model_alerts_CL"
                        }
                    ],
                    "dataTypes": [
                        {
                            "name": "darktrace_model_alerts_CL",
                            "lastDataReceivedQuery": "darktrace_model_alerts_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                        }
                    ],
                    "connectivityCriterias": [
                        {
                            "type": "IsConnectedQuery",
                            "value": [
                                "darktrace_model_alerts_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
                            ]
                        }
                    ],
                    "sampleQueries": [
                        {
                            "description": "Look for Test Alerts",
                            "query": "darktrace_model_alerts_CL\n            | where modelName_s == \"Unrestricted Test Model\""
                        },
                        {
                            "description": "Return Top Scoring Darktrace Model Breaches",
                            "query": "darktrace_model_alerts_CL\n            | where dtProduct_s ==\"Policy Breach\"\n            | project-rename SrcIpAddr=SourceIP\n            | project-rename SrcHostname=hostname_s\n            | project-rename DarktraceLink=breachUrl_s\n           | project-rename ThreatRiskLevel=score_d\n            | project-rename NetworkRuleName=modelName_s\n            | project TimeGenerated, NetworkRuleName, SrcHostname, SrcIpAddr, ThreatRiskLevel\n            | top 10 by ThreatRiskLevel desc"
                        },
                        {
                            "description": "Return AI Analyst Incidents",
                            "query": "darktrace_model_alerts_CL\n            | where dtProduct_s == \"AI Analyst\"\n            | project-rename  EventStartTime=startTime_s\n            | project-rename EventEndTime = endTime_s\n            | project-rename NetworkRuleName=title_s\n            | project-rename CurrentGroup=externalId_g //externalId is the Current Group ID from Darktrace\n            | project-rename ThreatCategory=dtProduct_s\n            | extend ThreatRiskLevel=score_d //This is the event score, which is different from the GroupScore\n            | project-rename SrcHostname=hostname_s\n            | project-rename DarktraceLink=url_s\n            | project-rename Summary=summary_s\n            | project-rename GroupScore=groupScore_d\n            | project-rename GroupCategory=groupCategory_s\n            | project-rename SrcDeviceName=bestDeviceName_s"
                        },
                        {
                            "description": "Return System Health Alerts",
                            "query": "  darktrace_model_alerts_CL\n            | where dtProduct_s == \"System Alert\""
                        },
                        {
                            "description": "Return email Logs for a specific external sender (example@test.com)",
                            "query": "darktrace_model_alerts_CL\n             | where dtProduct_s == 'Antigena Email'\n        | where from_s == 'example@test.com'"
                        }
                    ],
                    "availability": {
                        "status": 1,
                        "isPreview": false
                    },
                    "permissions": {
                        "resourceProvider": [
                            {
                                "provider": "Microsoft.OperationalInsights/workspaces",
                                "permissionsDisplayText": "read and write permissions are required.",
                                "providerDisplayName": "Workspace",
                                "scope": "Workspace",
                                "requiredPermissions": {
                                    "write": true,
                                    "read": true,
                                    "delete": true
                                }
                            },
                            {
                                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                                "providerDisplayName": "Keys",
                                "scope": "Workspace",
                                "requiredPermissions": {
                                    "action": true
                                }
                            }
                        ],
                        "customs": [
                            {
                                "name": "Darktrace Prerequisites",
                                "description": "To use this Data Connector a Darktrace master running v5.2+ is required.\n Data is sent to the [Azure Monitor HTTP Data Collector API](https://docs.microsoft.com/azure/azure-monitor/logs/data-collector-api) over HTTPs from Darktrace masters, therefore outbound connectivity from the Darktrace master to Microsoft Sentinel REST API is required."
                            },
                            {
                                "name": "Filter Darktrace Data",
                                "description": "During configuration it is possible to set up additional filtering on the Darktrace System Configuration page to constrain the amount or types of data sent."
                            },
                            {
                                "name": "Try the Darktrace Sentinel Solution",
                                "description": "You can get the most out of this connector by installing the Darktrace Solution for Microsoft Sentinel. This will provide workbooks to visualise alert data and analytics rules to automatically create alerts and incidents from Darktrace Model Breaches and AI Analyst incidents."
                            }
                        ]
                    },
                    "instructionSteps": [
                        {
                            "description": "1. Detailed setup instructions can be found on the Darktrace Customer Portal: https://customerportal.darktrace.com/product-guides/main/microsoft-sentinel-introduction\n 2. Take note of the Workspace ID and the Primary key. You will need to enter these details on your Darktrace System Configuration page.\n ",
                            "instructions": [
                                {
                                    "parameters": {
                                        "fillWith": [
                                            "WorkspaceId"
                                        ],
                                        "label": "Workspace ID"
                                    },
                                    "type": "CopyableLabel"
                                },
                                {
                                    "parameters": {
                                        "fillWith": [
                                            "PrimaryKey"
                                        ],
                                        "label": "Primary Key"
                                    },
                                    "type": "CopyableLabel"
                                }
                            ]
                        },
                        {
                            "description": "1. Perform the following steps on the Darktrace System Configuration page:\n 2. Navigate to the System Configuration Page (Main Menu > Admin > System Config)\n 3. Go into Modules configuration and click on the \"Microsoft Sentinel\" configuration card\n 4. Select \"HTTPS (JSON)\" and hit \"New\"\n 5. Fill in the required details and select appropriate filters\n 6. Click \"Verify Alert Settings\" to attempt authentication and send out a test alert\n 7. Run a \"Look for Test Alerts\" sample query to validate that the test alert has been received",
                            "title": "Darktrace Configuration"
                        }
                    ],
                    "id": "DarktraceRESTConnector"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', 'darktrace1655286944672.darktrace_for_sentinel')]",
            "location": "[parameters('workspace-location')]",
            "apiVersion": "2023-04-01-preview",
            "properties": {
                "version": "2.0.1",
                "kind": "Solution",
                "contentSchemaVersion": "3.0.0",
                "contentId": "darktrace1655286944672.darktrace_for_sentinel",
                "source": {
                    "kind": "Solution",
                    "name": "Darktrace",
                    "sourceId": "darktrace1655286944672.darktrace_for_sentinel"
                },
                "author": {
                    "name": "Darktrace"
                },
                "support": {
                    "name": "Darktrace",
                    "tier": "Partner",
                    "link": "https://www.darktrace.com/en/contact/"
                },
                "dependencies": {
                    "operator": "AND",
                    "criteria": [
                        {
                            "kind": "Workbook",
                            "contentId": "DarktraceWorkbook",
                            "version": "1.0.1"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "a3c7b8ed-56a9-47b7-98e5-2555c16e17c9",
                            "version": "1.1.0"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "ffa2977f-3077-4bba-b1bf-f3417699cbb0",
                            "version": "1.1.0"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "2e629769-60eb-4a14-8bfc-bde9be66ebeb",
                            "version": "1.1.0"
                        },
                        {
                            "kind": "DataConnector",
                            "contentId": "DarktraceRESTConnector",
                            "version": "1.0.0"
                        }
                    ]
                },
                "firstPublishDate": "2022-05-02",
                "providers": [
                    "Darktrace"
                ],
                "categories": {
                    "domains": [
                        "Security - Threat Protection"
                    ]
                },
                "contentKind": "Solution",
                "contentProductId": "darktrace1655286944672.darktrace_for_sentinel-sl-nbs2gk2vd77n4",
                "id": "darktrace1655286944672.darktrace_for_sentinel-sl-nbs2gk2vd77n4",
                "displayName": "Darktrace",
                "publisherDisplayName": "Darktrace plc",
                "descriptionHtml": "<p>Please note, this solution is replacing \u201cAI Analyst Darktrace\u201d Microsoft Sentinel solution which will not be supported from 01 Dec, 2022. For full installation guidance please visit the <a href=\"https://customerportal.darktrace.com/login\">Darktrace Customer Portal</a>.</p><p> </p><p><b>Overview</b></p><p>The new Darktrace solution for Microsoft Sentinel brings unparalleled Self-Learning AI insights from Darktrace to be analyzed and correlated against the Microsoft product suite data in Microsoft Sentinel SIEM. Microsoft Sentinel users will find a detailed Darktrace Workbook which graphs a broad set of Darktrace data, including AI Analyst, apps, network and email alerting. Alongside that, Analytic Rule templates are provided to assist with automatic Microsoft Sentinel incident creation from AI Analyst breaches and Alert creation from Darktrace Model Breaches and System Alerts.</p><p>The setup is greatly simplified with the Darktrace Data Connector. This outbound REST API connector only requires authentication details and web connectivity between Darktrace and Microsoft Sentinel, allowing users to connect Darktrace data to their SIEM in minutes, without having to rely on complex log-forwarding scenarios.</p><p><b></b></p><p><b>Changes and improvements</b></p><p><b></b></p><p><b>New Data Connector</b></p><p>The Darktrace solution for Microsoft Sentinel moves away from using limited CEF Syslog data and pushes all Darktrace information directly into Microsoft Sentinel using Azure Monitor API over HTTPs. Not only does this greatly simplify initial setup and troubleshooting, but it also ensures that more context-rich data is collected in Microsoft Sentinel minimizing analyst context-switching.</p><p>With the added flexibility of consuming JSON data, additional new data categories are now brought to Microsoft Sentinel:</p><ul type=\"disc\"><li>Darktrace/Email</li><li>AI Analyst Incidents</li><li>Darktrace/Endpoint</li><li>System Status Alerts</li></ul><p>All data ingested from Darktrace is now placed in the custom log table.</p><p> </p><p><b>Redesigned Workbook</b></p><p>The Darktrace workbook has been redesigned from the ground up, ensuring Microsoft Sentinel analysts can get a comprehensive overview of Darktrace data at a glance:</p><ul type=\"disc\"><li>AI Analyst data now ingested into Microsoft Sentinel. A queue of AI Analyst incidents is displayed with a one-click pivot into a list of AI Analyst Incident Events belonging to the current incident grouping</li><li>Darktrace/Email data now ingested which provides a breakdown of actions over emails in a specified timeframe as well as a recipient search allowing to quickly locate held emails and evaluate specific users for threats</li><li>Data from Darktrace DETECT, graphed and organized based on new model breach tags \u2013 Compliance, Information, Suspicious, Critical</li><li>A dedicated tab for Darktrace RESPOND for a quick review of the latest autonomous response actions</li><li>Darktrace/Endpoint data graphed in a separate tab, allowing a quick overview of threats beyond the perimeter</li><li>System Status alerts tab ensuring Darktrace users can stay on top of system health</li></ul><p> </p><p><b>Analytic Rule Templates</b></p><p>The new solution ships with a selection of Analytics Rules templates which automate the creation of Microsoft Sentinel Incidents and Alerts from Darktrace data.</p><ul type=\"disc\"><li>AI Analyst Incidents - runs as a Near-Real-Time (NRT) rule, a Microsoft Sentinel Incident is created with a dynamic severity setting for AI Analyst Incidents</li><li>Model Breaches - runs as a Near-Real-Time (NRT) rule, a Microsoft Sentinel alert is created with a dynamic severity based on Model Breach </li><li>System Status Alerts - runs as a scheduled rule with 5 minute frequency and creates Microsoft Sentinel Alerts out of Darktrace System Status Alerts</li></ul><p>The Microsoft Sentinel analysts can pick which rules to activate and can modify the severities of resulting events according to the workflow standards for their organization.</p><p></p>",
                "icon": "https://store-images.s-microsoft.com/image/apps.41579.308be9d0-24cc-4c92-acbb-06ff29017673.b30e20f1-9345-435e-9925-5ac5d986c9b7.24e056e0-8250-49ad-871e-7bd9b96a5fd5",
                "isPreview": false,
                "isDeprecated": false
            }
        }
    ],
    "variables": {}
}
