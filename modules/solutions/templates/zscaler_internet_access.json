{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "String",
            "minLength": 1,
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
            }
        },
        "workspace-location": {
            "type": "String",
            "defaultValue": "",
            "metadata": {
                "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
            }
        },
        "workspace": {
            "defaultValue": "",
            "type": "String",
            "metadata": {
                "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
            }
        }
    },
    "resources": [
        {
            "name": "pid-1805f830-5c09-4543-943f-1ba4d9a84620-partnercenter",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-10-01",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": []
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring('ZscalerFirewallWorkbook')))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'zscaler1579058425289.zscaler_internet_access_mss')]"
            ],
            "properties": {
                "description": "Gain insights into your ZIA cloud firewall logs by connecting to Microsoft Sentinel.\nThe Zscaler firewall overview workbook provides an overview and ability to drill down into all cloud firewall activity in your Zscaler instance including non-web related networking events, security events, firewall rules, and bandwidth consumption",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.1.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Insights/workbooks",
                            "name": "ZscalerFirewallWorkbook",
                            "location": "[parameters('workspace-location')]",
                            "kind": "shared",
                            "apiVersion": "2021-08-01",
                            "metadata": {
                                "description": "Gain insights into your ZIA cloud firewall logs by connecting to Microsoft Sentinel.\nThe Zscaler firewall overview workbook provides an overview and ability to drill down into all cloud firewall activity in your Zscaler instance including non-web related networking events, security events, firewall rules, and bandwidth consumption"
                            },
                            "properties": {
                                "displayName": "Zscaler Firewall",
                                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler Firewall Overview\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"query\":\"\",\"parameters\":[{\"id\":\"ff5a2a6c-cf01-432a-ab49-e59918ead8ab\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":86400000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true}},{\"id\":\"fe452f11-ddc9-4b85-b441-b8f6be3b33a8\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SourceIP\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\" \\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where SourceTranslatedAddress  != \\\"\\\" \\r\\n| summarize Count = count() by SourceTranslatedAddress\\r\\n| project Value = SourceTranslatedAddress, Label = strcat(SourceTranslatedAddress, \\\" count: \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"d5fa439b-b1d7-491e-8953-5e4f7bf74f81\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SourcePort\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\" \\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\")\\r\\n| where SourcePort  != \\\"\\\" \\r\\n| summarize Count = count() by SourcePort\\r\\n| project Value = SourcePort, Label = strcat(\\\"Port: \\\",SourcePort, \\\" count: \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"2f749931-c232-471f-b91f-f91514fd7fa7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DestinationIP\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID  !contains \\\"Allow\\\" \\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where DestinationIP  != \\\"\\\" \\r\\n| summarize Count = count() by DestinationIP\\r\\n| project Value = DestinationIP, Label = strcat(DestinationIP, \\\" count: \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"5ecf989b-46cc-4cde-80fb-720d1ad2a5e2\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DestinationPort\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID  !contains \\\"Allow\\\" \\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\"\\r\\n| where DestinationPort  != \\\"\\\" \\r\\n| summarize Count = count() by DestinationPort\\r\\n| project Value = DestinationPort, Label = strcat(DestinationPort, \\\" count: \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 1\"},{\"type\":1,\"content\":{\"json\":\"### Block actions\"},\"name\":\"text - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where DeviceEventClassID !contains \\\"Allow\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| summarize Count = count() by Protocol\\r\\n| sort by Count desc\\r\\n| top 10 by Count\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Top blocked protocols\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| where SourceUserPrivileges == SourceUserName\\r\\n| summarize Count = count() by SourceUserName\\r\\n| sort by Count desc\\r\\n| top 10 by Count\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Top blocked locations\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| where DestinationPort   != \\\"0\\\" \\r\\n| extend dst_port = tostring(DestinationPort) \\r\\n| summarize Count = count() by  dst_port\\r\\n| top 10 by Count desc nulls last \",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Top blocked destination ports\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| where DestinationIP != \\\"\\\" \\r\\n| summarize Count = count() by DestinationIP\\r\\n| sort by Count desc\\r\\n| top 10 by Count\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Top blocked destination IP addresses\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID  !contains \\\"Allow\\\" \\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| where SourceTranslatedAddress  != \\\"\\\" \\r\\n| summarize Count = count() by SourceTranslatedAddress\\r\\n| sort by Count desc\\r\\n| top 10 by Count\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Top blocked source IP addresses\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| where SourcePort   != \\\"0\\\" \\r\\n| extend src_port = tostring(SourcePort) \\r\\n| summarize Count = count() by  src_port\\r\\n| order by Count\\r\\n| take 10\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Top blocked source ports\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 12\"},{\"type\":1,\"content\":{\"json\":\"---\"},\"name\":\"text - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID  contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| summarize ['Recived MB'] = sum(ReceivedBytes/1024.0/1024.0), ['Sent MB'] = sum(SentBytes/1024.0/1024.0) by bin(TimeGenerated, {TimeRange:grain}), SourceUserPrivileges\\r\\n| project-rename Location = SourceUserPrivileges \\r\\n| order by ['Recived MB'] desc, ['Sent MB'] desc\",\"size\":0,\"exportFieldName\":\"\",\"exportParameterName\":\"LocationFilter\",\"exportDefaultValue\":\"{\\\"Location\\\":\\\"*\\\"}\",\"exportToExcelOptions\":\"visible\",\"title\":\"Non-http downloads and uploads in MB\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"formatOptions\":{\"min\":0,\"palette\":\"turquoise\",\"showIcon\":true}},{\"columnMatch\":\"Location\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Recived MB\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"purple\",\"showIcon\":true,\"aggregation\":\"Sum\"}},{\"columnMatch\":\"Sent MB\",\"formatter\":3,\"formatOptions\":{\"min\":0,\"palette\":\"magenta\",\"showIcon\":true,\"aggregation\":\"Sum\"}},{\"columnMatch\":\"$gen_group\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}}],\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Location\"],\"expandTopLevel\":false,\"finalBy\":\"Location\"}}},\"customWidth\":\"50\",\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID  contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| summarize ['Recived MB'] = sum(ReceivedBytes/1024.0/1024.0), ['Sent MB'] = sum(SentBytes/1024.0/1024.0) by bin(TimeGenerated, {TimeRange:grain}), SourceUserPrivileges\\r\\n| project-rename Location = SourceUserPrivileges \\r\\n| where Location == dynamic({LocationFilter}).childRows[0].Location or dynamic({LocationFilter}).Location == Location or dynamic({LocationFilter}).Location == \\\"*\\\"\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Non-http downloads and uploads in MB\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"customWidth\":\"50\",\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSFWlog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (SourcePort in ({SourcePort}) or '{SourcePort:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") and (DestinationPort in ({DestinationPort}) or '{DestinationPort:label}' == \\\"All\\\")\\r\\n| where Activity !contains \\\"Default\\\"  and Activity !contains \\\"Recommended\\\" \\r\\n| summarize count()  by bin(TimeGenerated, {TimeRange:grain}), Activity \",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Non-default firewall rules getting triggered\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"name\":\"query - 11\"}],\"fromTemplateId\":\"sentinel-ZscalerFirewallOverview\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                                "version": "1.0",
                                "sourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
                                "category": "sentinel"
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(resourceId('Microsoft.Insights/workbooks', 'ZscalerFirewallWorkbook'),'/'))))]",
                            "properties": {
                                "description": "@{workbookKey=ZscalerFirewallWorkbook; logoFileName=zscaler_logo.svg; description=Gain insights into your ZIA cloud firewall logs by connecting to Microsoft Sentinel.\nThe Zscaler firewall overview workbook provides an overview and ability to drill down into all cloud firewall activity in your Zscaler instance including non-web related networking events, security events, firewall rules, and bandwidth consumption; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.1.0; title=Zscaler Firewall; templateRelativePath=ZscalerFirewall.json; subtitle=; provider=Zscaler}.description",
                                "parentId": "[resourceId('Microsoft.Insights/workbooks', 'ZscalerFirewallWorkbook')]",
                                "contentId": "ZscalerFirewallWorkbook",
                                "kind": "Workbook",
                                "version": "1.1.0",
                                "source": {
                                    "kind": "Solution",
                                    "name": "Zscaler Internet Access",
                                    "sourceId": "zscaler1579058425289.zscaler_internet_access_mss"
                                },
                                "author": {
                                    "name": "Zscaler"
                                },
                                "support": {
                                    "name": "Zscaler",
                                    "tier": "Partner",
                                    "link": "https://help.zscaler.com/submit-ticket-links"
                                },
                                "dependencies": {
                                    "operator": "AND",
                                    "criteria": [
                                        {
                                            "contentId": "CommonSecurityLog",
                                            "kind": "DataType"
                                        },
                                        {
                                            "contentId": "Zscaler",
                                            "kind": "DataConnector"
                                        },
                                        {
                                            "contentId": "CefAma",
                                            "kind": "DataConnector"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "3.0.3",
                "packageName": "Zscaler Internet Access",
                "packageId": "zscaler1579058425289.zscaler_internet_access_mss",
                "contentSchemaVersion": "3.0.0",
                "contentId": "ZscalerFirewallWorkbook",
                "contentKind": "Workbook",
                "displayName": "Zscaler Firewall",
                "contentProductId": "zscaler1579058425289.zscaler_internet_access_mss-wb-m3lv2zo4nmkda",
                "id": "zscaler1579058425289.zscaler_internet_access_mss-wb-m3lv2zo4nmkda",
                "version": "1.1.0",
                "isDeprecated": false
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring('ZscalerOffice365AppsWorkbook')))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'zscaler1579058425289.zscaler_internet_access_mss')]"
            ],
            "properties": {
                "description": "Gain insights into Office 365 use on your network.\nThe Zscaler Office 365 overview workbook shows you the Microsoft apps running on your network and their individual bandwidth consumption. It also helps identify phishing attempts in which attackers disguised themselves as Microsoft services.",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.1.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Insights/workbooks",
                            "name": "ZscalerOffice365AppsWorkbook",
                            "location": "[parameters('workspace-location')]",
                            "kind": "shared",
                            "apiVersion": "2021-08-01",
                            "metadata": {
                                "description": "Gain insights into Office 365 use on your network.\nThe Zscaler Office 365 overview workbook shows you the Microsoft apps running on your network and their individual bandwidth consumption. It also helps identify phishing attempts in which attackers disguised themselves as Microsoft services."
                            },
                            "properties": {
                                "displayName": "Zscaler Office365 Apps",
                                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler Office 365 overview\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"query\":\"\",\"parameters\":[{\"id\":\"ff5a2a6c-cf01-432a-ab49-e59918ead8ab\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":259200000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DestinationServiceName contains \\\"Microsoft\\\" or DestinationServiceName contains  \\\"Skype\\\"  or DestinationServiceName contains \\\"Sharepoint\\\" or DestinationServiceName contains \\\"Onedrive\\\"  or DestinationServiceName contains \\\"Outlook\\\" or DestinationServiceName contains \\\"office.com\\\"\\r\\n| where DeviceEventClassID contains \\\"Allow\\\" \\r\\n| summarize count()  by bin(TimeGenerated, {TimeRange:grain}), DestinationServiceName\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Microsoft services activity over time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"50\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DestinationServiceName contains \\\"Microsoft\\\" or DestinationServiceName contains  \\\"Skype\\\"  or DestinationServiceName contains \\\"Sharepoint\\\" or DestinationServiceName contains \\\"Onedrive\\\"  or DestinationServiceName contains \\\"Outlook\\\" or DestinationServiceName contains \\\"office.com\\\"\\r\\n| where DeviceEventClassID contains \\\"Allow\\\" \\r\\n| summarize BW_usage_MB = sum((ReceivedBytes+SentBytes)/1024.0/1024.0)  by bin(TimeGenerated, {TimeRange:grain}),  SourceUserPrivileges\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"BW consumption, by Microsoft apps (based on Location)\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"customWidth\":\"50\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DestinationServiceName contains \\\"Microsoft\\\" or DestinationServiceName contains  \\\"Skype\\\"  or DestinationServiceName contains \\\"Sharepoint\\\" or DestinationServiceName contains \\\"Onedrive\\\"  or DestinationServiceName contains \\\"Outlook\\\" or DestinationServiceName contains \\\"office.com\\\"\\r\\n| where DeviceEventClassID contains \\\"Allow\\\" \\r\\n| summarize sum((ReceivedBytes+SentBytes)/1024.0/1024.0)  by bin(TimeGenerated, {TimeRange:grain}),  DestinationServiceName\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"BW consumption, by Microsoft Apps (based on App)\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"customWidth\":\"50\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DestinationServiceName contains \\\"Microsoft\\\" or DestinationServiceName contains  \\\"Skype\\\"  or DestinationServiceName contains \\\"Sharepoint\\\" or DestinationServiceName contains \\\"Onedrive\\\"  or DestinationServiceName contains \\\"Outlook\\\" or DestinationServiceName contains \\\"office.com\\\"\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\" \\r\\n| where DeviceCustomString2 == \\\"Phishing\\\"\\r\\n| summarize count()  by bin(TimeGenerated, {TimeRange:grain}), DestinationServiceName\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Phishing attempts disguised as Microsoft services\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"DestinationServiceName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"name\":\"query - 5\"}],\"fromTemplateId\":\"sentinel-ZscalerOffice365Apps\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                                "version": "1.0",
                                "sourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
                                "category": "sentinel"
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(resourceId('Microsoft.Insights/workbooks', 'ZscalerOffice365AppsWorkbook'),'/'))))]",
                            "properties": {
                                "description": "@{workbookKey=ZscalerOffice365AppsWorkbook; logoFileName=zscaler_logo.svg; description=Gain insights into Office 365 use on your network.\nThe Zscaler Office 365 overview workbook shows you the Microsoft apps running on your network and their individual bandwidth consumption. It also helps identify phishing attempts in which attackers disguised themselves as Microsoft services.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.1.0; title=Zscaler Office365 Apps; templateRelativePath=ZscalerOffice365Apps.json; subtitle=; provider=Zscaler}.description",
                                "parentId": "[resourceId('Microsoft.Insights/workbooks', 'ZscalerOffice365AppsWorkbook')]",
                                "contentId": "ZscalerOffice365AppsWorkbook",
                                "kind": "Workbook",
                                "version": "1.1.0",
                                "source": {
                                    "kind": "Solution",
                                    "name": "Zscaler Internet Access",
                                    "sourceId": "zscaler1579058425289.zscaler_internet_access_mss"
                                },
                                "author": {
                                    "name": "Zscaler"
                                },
                                "support": {
                                    "name": "Zscaler",
                                    "tier": "Partner",
                                    "link": "https://help.zscaler.com/submit-ticket-links"
                                },
                                "dependencies": {
                                    "operator": "AND",
                                    "criteria": [
                                        {
                                            "contentId": "CommonSecurityLog",
                                            "kind": "DataType"
                                        },
                                        {
                                            "contentId": "Zscaler",
                                            "kind": "DataConnector"
                                        },
                                        {
                                            "contentId": "CefAma",
                                            "kind": "DataConnector"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "3.0.3",
                "packageName": "Zscaler Internet Access",
                "packageId": "zscaler1579058425289.zscaler_internet_access_mss",
                "contentSchemaVersion": "3.0.0",
                "contentId": "ZscalerOffice365AppsWorkbook",
                "contentKind": "Workbook",
                "displayName": "Zscaler Office365 Apps",
                "contentProductId": "zscaler1579058425289.zscaler_internet_access_mss-wb-mwylnbjzc5c4u",
                "id": "zscaler1579058425289.zscaler_internet_access_mss-wb-mwylnbjzc5c4u",
                "version": "1.1.0",
                "isDeprecated": false
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring('ZscalerThreatsOverviewWorkbook')))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'zscaler1579058425289.zscaler_internet_access_mss')]"
            ],
            "properties": {
                "description": "Gain insights into threats blocked by Zscaler Internet access on your network.\nThe Zscaler threat overview workbook shows your entire threat landscape including blocked malware, IPS/AV rules, and blocked cloud apps. Threats are displayed by threat categories, filetypes, inbound vs outbound threats, usernames, user location, and more.",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.2.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Insights/workbooks",
                            "name": "ZscalerThreatsOverviewWorkbook",
                            "location": "[parameters('workspace-location')]",
                            "kind": "shared",
                            "apiVersion": "2021-08-01",
                            "metadata": {
                                "description": "Gain insights into threats blocked by Zscaler Internet access on your network.\nThe Zscaler threat overview workbook shows your entire threat landscape including blocked malware, IPS/AV rules, and blocked cloud apps. Threats are displayed by threat categories, filetypes, inbound vs outbound threats, usernames, user location, and more."
                            },
                            "properties": {
                                "displayName": "Zscaler Threats",
                                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler Threats Overview\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"e6ceec81-0d4d-420e-8ed3-062a7eb4129a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":604800000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceEventClassID == \\\"Blocked\\\"\\r\\n| where DeviceCustomString5Label == \\\"threatname\\\" \\r\\n| where DeviceCustomString5 != \\\"None\\\" \\r\\n| where DeviceCustomString5 != \\\"suspiciousfile\\\" \\r\\n| summarize Count = count() by ['Threat name'] = DeviceCustomString5, threatname = DeviceCustomString5\\r\\n| order by Count desc\",\"size\":0,\"exportFieldName\":\"threatname\",\"exportParameterName\":\"threatname\",\"exportDefaultValue\":\"All\",\"exportToExcelOptions\":\"visible\",\"title\":\"Blocked threats\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Threat name\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"threatname\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\",\"showIcon\":true}}],\"filter\":true}},\"customWidth\":\"30\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceEventClassID == \\\"Blocked\\\"\\r\\n| where DeviceCustomString5Label == \\\"threatname\\\" \\r\\n| where DeviceCustomString5 != \\\"None\\\" \\r\\n| where DeviceCustomString5 != \\\"suspiciousfile\\\"\\r\\n| where '{threatname}' == \\\"All\\\" or '{threatname}' == DeviceCustomString5 \\r\\n| summarize count() by bin(TimeGenerated, {TimeRange:grain}), ['Threat name'] = DeviceCustomString5\\r\\n\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Blocked threats over time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"70\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceEventClassID contains \\\"Block\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where DeviceCustomString2 != \\\"\\\"\\r\\n| summarize Count = count() by urlcat = DeviceCustomString2\\r\\n| order by Count desc\\r\\n\",\"size\":0,\"exportFieldName\":\"urlcat\",\"exportParameterName\":\"urlcat\",\"exportDefaultValue\":\"All\",\"exportToExcelOptions\":\"visible\",\"title\":\"Blocked URL categories\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"urlcat\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"greenRed\",\"showIcon\":true}}],\"filter\":true,\"labelSettings\":[{\"columnId\":\"urlcat\",\"label\":\"URL categories\"},{\"columnId\":\"Count\",\"label\":\"\"}]}},\"customWidth\":\"30\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceEventClassID contains \\\"Block\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where DeviceCustomString2 != \\\"\\\"\\r\\n| where '{urlcat}' == \\\"All\\\" or '{urlcat}' == DeviceCustomString2\\r\\n| summarize Count = count() by urlcat = DeviceCustomString2, bin(TimeGenerated, {TimeRange:grain})\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Blocked URL categories over time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"customWidth\":\"70\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID == \\\"Blocked\\\"\\r\\n| where Activity contains \\\"IPS\\\" \\r\\n| summarize Count = count()  by  Activity\\r\\n| order by Count desc\",\"size\":0,\"exportFieldName\":\"Activity\",\"exportParameterName\":\"Activity\",\"exportDefaultValue\":\"All\",\"exportToExcelOptions\":\"visible\",\"title\":\"Transactions blocked IPS\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Activity\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\",\"showIcon\":true}}],\"filter\":true}},\"customWidth\":\"30\",\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID == \\\"Blocked\\\"\\r\\n| where Activity contains \\\"IPS\\\" \\r\\n| where Activity == '{Activity}' or '{Activity}' == \\\"All\\\"\\r\\n| summarize Count = count()  by  Activity, bin(TimeGenerated, {TimeRange:grain})\\r\\n| order by Count desc\\r\\n\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Transactions blocked IPS over time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Activity\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"SourceIP\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true,\"aggregation\":\"Unique\"}},{\"columnMatch\":\"DestinationIP\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true,\"aggregation\":\"Unique\"}},{\"columnMatch\":\"TimeGenerated\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orangeBlue\",\"showIcon\":true,\"aggregation\":\"Sum\"}},{\"columnMatch\":\"count_\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true,\"aggregation\":\"Sum\"}},{\"columnMatch\":\"$gen_group\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}}],\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Activity\",\"SourceIP\",\"DestinationIP\"]}}},\"customWidth\":\"70\",\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where SourceUserPrivileges != SourceUserName \\r\\n| extend DeviceCustomNumber1 = coalesce(column_ifexists(\\\"FieldDeviceCustomNumber1\\\", long(null)),DeviceCustomNumber1)\\r\\n | where DeviceCustomNumber1>=50\\r\\n| summarize Count = count() by SourceUserName, RiskScore = DeviceCustomNumber1\\r\\n| order by RiskScore desc, Count\",\"size\":0,\"exportFieldName\":\"SourceUserName\",\"exportParameterName\":\"SourceUserName\",\"exportDefaultValue\":\"All\",\"exportToExcelOptions\":\"visible\",\"title\":\"Users accessing malicious destinations\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SourceUserName\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"RiskScore\",\"formatter\":8,\"formatOptions\":{\"min\":50,\"palette\":\"greenRed\",\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}}],\"filter\":true}},\"customWidth\":\"30\",\"name\":\"query - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where SourceUserPrivileges != SourceUserName \\r\\n| where SourceUserName == '{SourceUserName}' or '{SourceUserName}' == \\\"All\\\"\\r\\n| where DeviceCustomNumber1>=50\\r\\n| summarize count() by bin(TimeGenerated, {TimeRange:grain}), SourceUserName\\r\\n\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Users accessing malicious destinations over time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"customWidth\":\"70\",\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceEventClassID == \\\"Blocked\\\"\\r\\n| where FileType != \\\"None\\\" \\r\\n| summarize count() by FileType \\r\\n| sort by count_  desc nulls last \\r\\n| top 10 by count_\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Blocked file types\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n|  where DeviceCustomString4 !=\\\"None\\\"\\r\\n| summarize count() by malwarecat = DeviceCustomString4\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Transactions intercepted by malware protection\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"malwarecat\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"count_\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}}],\"labelSettings\":[{\"columnId\":\"malwarecat\",\"label\":\"Malware Categoty\"},{\"columnId\":\"count_\"}]}},\"customWidth\":\"33\",\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| extend DeviceCustomNumber1 = coalesce(column_ifexists(\\\"FieldDeviceCustomNumber1\\\", long(null)),DeviceCustomNumber1)\\r\\n| where DeviceCustomNumber1 != 0\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\" \\r\\n| where DeviceCustomString4 !=\\\"None\\\"\\r\\n| where RequestMethod == \\\"GET\\\"  or  RequestMethod == \\\"POST\\\"\\r\\n| extend replaced= iif ( RequestMethod==\\\"GET\\\" , replace('GET', 'Inbound Threats', RequestMethod) , replace('POST', 'Outbound Threats', RequestMethod))\\r\\n| summarize count() by  replaced\\r\\n\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Inbound and outbound blocked threats\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"replaced\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"33\",\"name\":\"query - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| parse AdditionalExtensions with * \\\"urlclass=\\\" urlclass \\\";devicemodel=\\\" devicemodel\\r\\n| where urlclass == \\\"Advanced Security Risk\\\" \\r\\n| summarize count() by urlcat = DeviceCustomString2\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Blocked advanced security risk URL categories\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 13\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n|  where DeviceCustomString4 !=\\\"None\\\"\\r\\n| where SourceUserPrivileges == \\\"Road Warrior\\\" \\r\\n| summarize count() by malwarecat = DeviceCustomString4\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Threats blocked for Road Warriors\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 14\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DeviceCustomString3 contains \\\"Behavior\\\" \\r\\n| summarize count() by malwarecat = DeviceCustomString4\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Threats intercepted by Sandbox protection\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 15\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let data = CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where DeviceEventClassID contains \\\"Block\\\"\\r\\n| where MaliciousIPCountry !=\\\"\\\";\\r\\nlet appData = data\\r\\n| summarize TotalCount = count() by MaliciousIPCountry\\r\\n| join kind=inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by MaliciousIPCountry\\r\\n    | project-away TimeGenerated) on MaliciousIPCountry\\r\\n| order by TotalCount desc, MaliciousIPCountry asc\\r\\n| project MaliciousIPCountry, TotalCount, Trend\\r\\n| serialize Id = row_number();\\r\\ndata\\r\\n| summarize TotalCount = count() by Activity , MaliciousIPCountry\\r\\n| join kind=inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by MaliciousIPCountry, Activity\\r\\n    | project-away TimeGenerated) on MaliciousIPCountry, Activity\\r\\n| order by TotalCount desc, MaliciousIPCountry asc\\r\\n| project MaliciousIPCountry, Activity, TotalCount, Trend\\r\\n| serialize Id = row_number(1000000)\\r\\n| join kind=inner (appData) on MaliciousIPCountry\\r\\n| project Id, Name = Activity, Type = 'Activity', ['MaliciousIPCountry Count'] = TotalCount, Trend,  ParentId = Id1\\r\\n| union (appData \\r\\n    | project Id, Name = MaliciousIPCountry, Type = 'Operation', ['MaliciousIPCountry Count'] = TotalCount,  Trend)\\r\\n| order by ['MaliciousIPCountry Count'] desc, Name asc\\r\\n\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Blocked destination activities, by location\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Id\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Name\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Type\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"MaliciousIPCountry Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orangeRed\",\"showIcon\":true}},{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"grayBlue\",\"showIcon\":true}},{\"columnMatch\":\"ParentId\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}}],\"filter\":true,\"hierarchySettings\":{\"idColumn\":\"Id\",\"parentColumn\":\"ParentId\",\"treeType\":0,\"expanderColumn\":\"Name\"}}},\"customWidth\":\"50\",\"name\":\"query - 16\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\" \\r\\n| where DestinationServiceName != \\\"generalbrowsing\\\"\\r\\n| summarize count() by DestinationServiceName, bin(TimeGenerated, {TimeRange:grain})\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Blocked cloud apps over time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"50\",\"name\":\"query - 17\"}],\"fromTemplateId\":\"sentinel-ZscalerThreats\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                                "version": "1.0",
                                "sourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
                                "category": "sentinel"
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(resourceId('Microsoft.Insights/workbooks', 'ZscalerThreatsOverviewWorkbook'),'/'))))]",
                            "properties": {
                                "description": "@{workbookKey=ZscalerThreatsOverviewWorkbook; logoFileName=zscaler_logo.svg; description=Gain insights into threats blocked by Zscaler Internet access on your network.\nThe Zscaler threat overview workbook shows your entire threat landscape including blocked malware, IPS/AV rules, and blocked cloud apps. Threats are displayed by threat categories, filetypes, inbound vs outbound threats, usernames, user location, and more.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.2.0; title=Zscaler Threats; templateRelativePath=ZscalerThreats.json; subtitle=; provider=Zscaler}.description",
                                "parentId": "[resourceId('Microsoft.Insights/workbooks', 'ZscalerThreatsOverviewWorkbook')]",
                                "contentId": "ZscalerThreatsOverviewWorkbook",
                                "kind": "Workbook",
                                "version": "1.2.0",
                                "source": {
                                    "kind": "Solution",
                                    "name": "Zscaler Internet Access",
                                    "sourceId": "zscaler1579058425289.zscaler_internet_access_mss"
                                },
                                "author": {
                                    "name": "Zscaler"
                                },
                                "support": {
                                    "name": "Zscaler",
                                    "tier": "Partner",
                                    "link": "https://help.zscaler.com/submit-ticket-links"
                                },
                                "dependencies": {
                                    "operator": "AND",
                                    "criteria": [
                                        {
                                            "contentId": "CommonSecurityLog",
                                            "kind": "DataType"
                                        },
                                        {
                                            "contentId": "Zscaler",
                                            "kind": "DataConnector"
                                        },
                                        {
                                            "contentId": "CefAma",
                                            "kind": "DataConnector"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "3.0.3",
                "packageName": "Zscaler Internet Access",
                "packageId": "zscaler1579058425289.zscaler_internet_access_mss",
                "contentSchemaVersion": "3.0.0",
                "contentId": "ZscalerThreatsOverviewWorkbook",
                "contentKind": "Workbook",
                "displayName": "Zscaler Threats",
                "contentProductId": "zscaler1579058425289.zscaler_internet_access_mss-wb-z7o22jmbekovq",
                "id": "zscaler1579058425289.zscaler_internet_access_mss-wb-z7o22jmbekovq",
                "version": "1.2.0",
                "isDeprecated": false
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring('ZscalerWebOverviewWorkbook')))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'zscaler1579058425289.zscaler_internet_access_mss')]"
            ],
            "properties": {
                "description": "Gain insights into your ZIA web logs by connecting to Microsoft Sentinel.\nThe Zscaler web overview workbook provides a bird's eye view and ability to drill down into all the security and networking events related to web transactions, types of devices, and bandwidth consumption.",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.1.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Insights/workbooks",
                            "name": "ZscalerWebOverviewWorkbook",
                            "location": "[parameters('workspace-location')]",
                            "kind": "shared",
                            "apiVersion": "2021-08-01",
                            "metadata": {
                                "description": "Gain insights into your ZIA web logs by connecting to Microsoft Sentinel.\nThe Zscaler web overview workbook provides a bird's eye view and ability to drill down into all the security and networking events related to web transactions, types of devices, and bandwidth consumption."
                            },
                            "properties": {
                                "displayName": "Zscaler Web Overview",
                                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Zscaler web overview\"},\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"query\":\"\",\"parameters\":[{\"id\":\"e246fdd8-f37f-4290-a205-7ffa192ea860\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":86400000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true}},{\"id\":\"fe452f11-ddc9-4b85-b441-b8f6be3b33a8\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SourceIP\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where SourceTranslatedAddress  != \\\"\\\" \\r\\n| summarize Count = count() by SourceTranslatedAddress\\r\\n| project Value = SourceTranslatedAddress, Label = strcat(SourceTranslatedAddress, \\\" count: \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"2f749931-c232-471f-b91f-f91514fd7fa7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DestinationIP\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceEventClassID  !contains \\\"Allow\\\" \\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where DestinationIP  != \\\"\\\" \\r\\n| summarize Count = count() by DestinationIP\\r\\n| project Value = DestinationIP, Label = strcat(DestinationIP, \\\" count: \\\", Count)\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All\"},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DestinationServiceName !=\\\"\\\"\\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| summarize Count = count() by DestinationServiceName\\r\\n| order by Count desc\",\"size\":0,\"exportFieldName\":\"DestinationServiceName\",\"exportParameterName\":\"DestinationServiceNameFilter\",\"exportDefaultValue\":\"All\",\"exportToExcelOptions\":\"visible\",\"title\":\"Apps being accessed\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"DestinationServiceName\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"palette\":\"purple\",\"showIcon\":true}}],\"filter\":true}},\"customWidth\":\"40\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DestinationServiceName !=\\\"\\\"\\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where DestinationServiceName == '{DestinationServiceNameFilter}' or '{DestinationServiceNameFilter}' == \\\"All\\\"\\r\\n| summarize Count = count() by DestinationServiceName, bin(TimeGenerated, {TimeRange:grain})\\r\\n\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Apps being accessed over time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"60\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DeviceEventClassID contains \\\"Allow\\\"\\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where DestinationServiceName has_any (\\\"Microsoft\\\", \\\"Skype\\\", \\\"SharePoint\\\", \\\"OneDrive\\\", \\\"Outlook\\\", \\\"office.com\\\", \\\"Sharepoint Online\\\", \\\"Microsoft Forms\\\", \\\"Microsoft Azure\\\")\\r\\n| summarize Count = count()  by DestinationServiceName\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Microsoft services\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"DestinationServiceName\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"greenBlue\",\"showIcon\":true}}],\"filter\":true}},\"customWidth\":\"50\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| parse AdditionalExtensions with * \\\"devicemodel=\\\" devicemodel\\r\\n| where devicemodel != \\\"\\\"  and    devicemodel !startswith \\\"NA\\\"\\r\\n| summarize count() by devicemodel \",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Devices\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DeviceEventClassID == \\\"Allowed\\\" or DeviceEventClassID == \\\"Allow\\\"\\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| summarize Downloads = sum( ReceivedBytes)/1024.0/1024.0 , Uploads = sum( SentBytes)/1024.0/1024.0 by Location = SourceUserPrivileges\",\"size\":0,\"exportFieldName\":\"Location\",\"exportParameterName\":\"LocationFilter\",\"exportDefaultValue\":\"All\",\"exportToExcelOptions\":\"visible\",\"title\":\"Upload and download data in MB, by location - click to filter\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SourceUserPrivileges\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Downloads\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}},{\"columnMatch\":\"Uploads\",\"formatter\":4,\"formatOptions\":{\"palette\":\"green\",\"showIcon\":true}}]}},\"customWidth\":\"50\",\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\"\\r\\n| where DeviceEventClassID == \\\"Allowed\\\" or DeviceEventClassID == \\\"Allow\\\"\\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where SourceUserPrivileges == '{LocationFilter}' or '{LocationFilter}' == \\\"All\\\"\\r\\n| summarize Downloads = sum( ReceivedBytes)/1024.0/1024.0 , Uploads = sum( SentBytes)/1024.0/1024.0 by bin(TimeGenerated, {TimeRange:grain}) \",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Upload and download data in MB over time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"customWidth\":\"50\",\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let data = CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where ApplicationProtocol !=\\\"\\\"\\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where DeviceProduct == \\\"NSSWeblog\\\";\\r\\nlet appData = data\\r\\n| summarize TotalCount = count() by ApplicationProtocol\\r\\n| join kind=inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by ApplicationProtocol\\r\\n    | project-away TimeGenerated) on ApplicationProtocol\\r\\n| order by TotalCount desc, ApplicationProtocol asc\\r\\n| project ApplicationProtocol, TotalCount, Trend\\r\\n| serialize Id = row_number();\\r\\ndata\\r\\n| summarize TotalCount = count() by RequestMethod , ApplicationProtocol\\r\\n| join kind=inner (data\\r\\n    | make-series Trend = count() default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by ApplicationProtocol, RequestMethod \\r\\n    | project-away TimeGenerated) on ApplicationProtocol, RequestMethod \\r\\n| order by TotalCount desc, ApplicationProtocol asc\\r\\n| project ApplicationProtocol, RequestMethod , TotalCount, Trend\\r\\n| serialize Id = row_number(1000000)\\r\\n| join kind=inner (appData) on ApplicationProtocol\\r\\n| project Id, Name = RequestMethod , Type = 'RequestMethod', ['ApplicationProtocol Count'] = TotalCount, Trend,  ParentId = Id1\\r\\n| union (appData \\r\\n    | project Id, Name = ApplicationProtocol, Type = 'ApplicationProtocol', ['ApplicationProtocol Count'] = TotalCount,  Trend)\\r\\n| order by ['ApplicationProtocol Count'] desc, Name asc\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Protocols and methods\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Id\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Name\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Type\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"ApplicationProtocol Count\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"palette\":\"gray\",\"showIcon\":true}},{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"palette\":\"blueDark\",\"showIcon\":true}},{\"columnMatch\":\"ParentId\",\"formatter\":5,\"formatOptions\":{\"showIcon\":true}}],\"filter\":true,\"hierarchySettings\":{\"idColumn\":\"Id\",\"parentColumn\":\"ParentId\",\"treeType\":0,\"expanderColumn\":\"Name\"}}},\"customWidth\":\"70\",\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceVendor == \\\"Zscaler\\\"\\r\\n| where DeviceEventClassID == \\\"Allowed\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where RequestMethod != \\\"\\\" \\r\\n| where RequestMethod != \\\"None\\\" \\r\\n| summarize count() by RequestMethod \\r\\n\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Allowed HTTP methods\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"30\",\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where SourceUserPrivileges == \\\"Road Warrior\\\" \\r\\n| summarize URLS_BLOCKED = count() by bin(TimeGenerated, {TimeRange:grain}), Activity\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Block reasons for road warriors\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"name\":\"query - 15\"},{\"type\":1,\"content\":{\"json\":\"---\\r\\n### Block actvities\"},\"name\":\"text - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where SourceUserPrivileges != \\\"\\\" \\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| summarize Count = count() by DestinationHostName\\r\\n| top 10 by Count\\r\\n| order by Count desc\",\"size\":0,\"exportFieldName\":\"DestinationHostName\",\"exportParameterName\":\"DestinationHostName\",\"exportDefaultValue\":\"All\",\"exportToExcelOptions\":\"visible\",\"title\":\"Top blocked domains for HTTP/S requests\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"DestinationHostName\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"coldHot\",\"showIcon\":true}}],\"labelSettings\":[{\"columnId\":\"DestinationHostName\",\"label\":\"Destination Host Name\"},{\"columnId\":\"Count\"}]}},\"customWidth\":\"33\",\"name\":\"query - 16\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where SourceUserPrivileges != SourceUserName\\r\\n| summarize Count = count() by SourceUserName\\r\\n| top 10 by Count\\r\\n| order by Count desc\",\"size\":0,\"exportFieldName\":\"SourceUserName\",\"exportParameterName\":\"SourceUserName\",\"exportDefaultValue\":\"All\",\"exportToExcelOptions\":\"visible\",\"title\":\"Top blocked users for HTTP/S requests\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SourceUserName\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"coldHot\",\"showIcon\":true}}],\"rowLimit\":1000}},\"customWidth\":\"33\",\"name\":\"query - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| summarize Count = count() by Activity\\r\\n| sort by Count \\r\\n| top 10 by Count\\r\\n\",\"size\":0,\"exportFieldName\":\"Activity\",\"exportParameterName\":\"Activity\",\"exportDefaultValue\":\"All\",\"exportToExcelOptions\":\"visible\",\"title\":\"Top Block Reasons for HTTP/S Requests\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Activity\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":8,\"formatOptions\":{\"palette\":\"coldHot\",\"showIcon\":true}}]}},\"customWidth\":\"33\",\"name\":\"query - 13\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\r\\n| where DeviceEventClassID !contains \\\"Allow\\\"\\r\\n| where SourceUserPrivileges != \\\"\\\" \\r\\n| where DeviceProduct == \\\"NSSWeblog\\\" \\r\\n| where (SourceTranslatedAddress in ({SourceIP}) or '{SourceIP:label}' == \\\"All\\\") and  (DestinationIP in ({DestinationIP}) or '{DestinationIP:label}' == \\\"All\\\") \\r\\n| where (DestinationHostName == '{DestinationHostName}' or '{DestinationHostName}' == \\\"All\\\") and (SourceUserName == '{SourceUserName}' or '{SourceUserName}' == \\\"All\\\") and (Activity == '{Activity}' or '{Activity}' == \\\"All\\\")\\r\\n| summarize Count = count() by DestinationHostName, SourceUserName, Activity, DestinationIP, Location = SourceUserPrivileges\\r\\n| order by Count desc\",\"size\":0,\"exportToExcelOptions\":\"visible\",\"title\":\"Block activities summary\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"DestinationHostName\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"SourceUserName\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Activity\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}}],\"filter\":true}},\"name\":\"query - 14\"}],\"fromTemplateId\":\"sentinel-ZscalerWebOverview\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                                "version": "1.0",
                                "sourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
                                "category": "sentinel"
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(resourceId('Microsoft.Insights/workbooks', 'ZscalerWebOverviewWorkbook'),'/'))))]",
                            "properties": {
                                "description": "@{workbookKey=ZscalerWebOverviewWorkbook; logoFileName=zscaler_logo.svg; description=Gain insights into your ZIA web logs by connecting to Microsoft Sentinel.\nThe Zscaler web overview workbook provides a bird's eye view and ability to drill down into all the security and networking events related to web transactions, types of devices, and bandwidth consumption.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.1.0; title=Zscaler Web Overview; templateRelativePath=ZscalerWebOverview.json; subtitle=; provider=Zscaler}.description",
                                "parentId": "[resourceId('Microsoft.Insights/workbooks', 'ZscalerWebOverviewWorkbook')]",
                                "contentId": "ZscalerWebOverviewWorkbook",
                                "kind": "Workbook",
                                "version": "1.1.0",
                                "source": {
                                    "kind": "Solution",
                                    "name": "Zscaler Internet Access",
                                    "sourceId": "zscaler1579058425289.zscaler_internet_access_mss"
                                },
                                "author": {
                                    "name": "Zscaler"
                                },
                                "support": {
                                    "name": "Zscaler",
                                    "tier": "Partner",
                                    "link": "https://help.zscaler.com/submit-ticket-links"
                                },
                                "dependencies": {
                                    "operator": "AND",
                                    "criteria": [
                                        {
                                            "contentId": "CommonSecurityLog",
                                            "kind": "DataType"
                                        },
                                        {
                                            "contentId": "Zscaler",
                                            "kind": "DataConnector"
                                        },
                                        {
                                            "contentId": "CefAma",
                                            "kind": "DataConnector"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "3.0.3",
                "packageName": "Zscaler Internet Access",
                "packageId": "zscaler1579058425289.zscaler_internet_access_mss",
                "contentSchemaVersion": "3.0.0",
                "contentId": "ZscalerWebOverviewWorkbook",
                "contentKind": "Workbook",
                "displayName": "Zscaler Web Overview",
                "contentProductId": "zscaler1579058425289.zscaler_internet_access_mss-wb-edfoyxbam2qfk",
                "id": "zscaler1579058425289.zscaler_internet_access_mss-wb-edfoyxbam2qfk",
                "version": "1.1.0",
                "isDeprecated": false
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('010bd98c-a6be-498c-bdcd-502308c0fdae')))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'zscaler1579058425289.zscaler_internet_access_mss')]"
            ],
            "properties": {
                "description": "Identifies callouts to Discord CDN addresses for risky file extensions. This detection will trigger when a callout for a risky file is made to a discord server that has only been seen once in your environment. Unique discord servers are identified using the server ID that is included in the request URL (DiscordServerId in query). Discord CDN has been used in multiple campaigns to download additional payloads",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.4",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "010bd98c-a6be-498c-bdcd-502308c0fdae",
                            "apiVersion": "2023-02-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies callouts to Discord CDN addresses for risky file extensions. This detection will trigger when a callout for a risky file is made to a discord server that has only been seen once in your environment. Unique discord servers are identified using the server ID that is included in the request URL (DiscordServerId in query). Discord CDN has been used in multiple campaigns to download additional payloads",
                                "displayName": "Discord CDN Risky File Download",
                                "enabled": false,
                                "query": "let connectionThreshold = 1;\nlet riskyExtensions = dynamic([\".bin\",\".exe\",\".dll\",\".bin\",\".msi\"]);\nCommonSecurityLog\n| where DeviceVendor =~ \"ZScaler\"\n| where RequestURL has_any(\"media.discordapp.net\", \"cdn.discordapp.com\")\n| where RequestURL has \"attachments\"\n| where DeviceAction !~ \"blocked\"\n| extend DiscordServerId = extract(@\"\\/attachments\\/([0-9]+)\\/\", 1, RequestURL)\n| summarize dcount(RequestURL), make_set(SourceUserName), make_set(SourceIP), make_set(RequestURL), min(TimeGenerated), max(TimeGenerated), make_set(DeviceAction) by DiscordServerId, DeviceProduct\n| where dcount_RequestURL <= connectionThreshold\n| mv-expand set_SourceUserName to typeof(string), set_RequestURL to typeof(string), set_DeviceAction to typeof(string), set_SourceIP to typeof(string)\n| summarize by DiscordServerId, DeviceProduct, dcount_RequestURL, set_SourceUserName, min_TimeGenerated, max_TimeGenerated, set_DeviceAction, set_SourceIP, set_RequestURL\n| project StartTime=min_TimeGenerated, EndTime=max_TimeGenerated, DeviceActionTaken=set_DeviceAction, DeviceProduct, SourceUser=set_SourceUserName, SourceIP=set_SourceIP, RequestURL=set_RequestURL\n| where RequestURL has_any (riskyExtensions)\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "dataTypes": [
                                            "CommonSecurityLog"
                                        ],
                                        "connectorId": "CefAma"
                                    }
                                ],
                                "tactics": [
                                    "CommandAndControl"
                                ],
                                "subTechniques": [
                                    "T1071.001"
                                ],
                                "techniques": [
                                    "T1071"
                                ],
                                "entityMappings": [
                                    {
                                        "entityType": "Account",
                                        "fieldMappings": [
                                            {
                                                "columnName": "SourceUser",
                                                "identifier": "FullName"
                                            }
                                        ]
                                    },
                                    {
                                        "entityType": "IP",
                                        "fieldMappings": [
                                            {
                                                "columnName": "SourceIP",
                                                "identifier": "Address"
                                            }
                                        ]
                                    },
                                    {
                                        "entityType": "URL",
                                        "fieldMappings": [
                                            {
                                                "columnName": "RequestURL",
                                                "identifier": "Url"
                                            }
                                        ]
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '010bd98c-a6be-498c-bdcd-502308c0fdae'),'/'))))]",
                            "properties": {
                                "description": "Zscaler Internet Access Analytics Rule 1",
                                "parentId": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '010bd98c-a6be-498c-bdcd-502308c0fdae')]",
                                "contentId": "010bd98c-a6be-498c-bdcd-502308c0fdae",
                                "kind": "AnalyticsRule",
                                "version": "1.0.4",
                                "source": {
                                    "kind": "Solution",
                                    "name": "Zscaler Internet Access",
                                    "sourceId": "zscaler1579058425289.zscaler_internet_access_mss"
                                },
                                "author": {
                                    "name": "Zscaler"
                                },
                                "support": {
                                    "name": "Zscaler",
                                    "tier": "Partner",
                                    "link": "https://help.zscaler.com/submit-ticket-links"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "3.0.3",
                "packageName": "Zscaler Internet Access",
                "packageId": "zscaler1579058425289.zscaler_internet_access_mss",
                "contentSchemaVersion": "3.0.0",
                "contentId": "010bd98c-a6be-498c-bdcd-502308c0fdae",
                "contentKind": "AnalyticsRule",
                "displayName": "Discord CDN Risky File Download",
                "contentProductId": "zscaler1579058425289.zscaler_internet_access_mss-ar-cyaqgyfsohazo",
                "id": "zscaler1579058425289.zscaler_internet_access_mss-ar-cyaqgyfsohazo",
                "version": "1.0.4",
                "isDeprecated": false,
                "dependencies": {
                    "operator": "AND",
                    "criteria": [
                        {
                            "contentKind": "DataType",
                            "contentId": "CommonSecurityLog"
                        },
                        {
                            "contentKind": "DataConnector",
                            "contentId": "CefAma"
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('4d500e6d-c984-43a3-9f39-7edec8dcc04d')))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'zscaler1579058425289.zscaler_internet_access_mss')]"
            ],
            "properties": {
                "description": "This will look for connections to a domain where only a single file is requested, this is unusual as most modern web applications require additional recources. This type of activity is often assocaited with malware beaconing or tracking URL's delivered in emails. Developed for Zscaler but applicable to any outbound web logging.",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.5",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "4d500e6d-c984-43a3-9f39-7edec8dcc04d",
                            "apiVersion": "2023-02-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "This will look for connections to a domain where only a single file is requested, this is unusual as most modern web applications require additional recources. This type of activity is often assocaited with malware beaconing or tracking URL's delivered in emails. Developed for Zscaler but applicable to any outbound web logging.",
                                "displayName": "Request for single resource on domain",
                                "enabled": false,
                                "query": "let scriptExtensions = dynamic([\".php\", \".aspx\", \".asp\", \".cfml\"]);\n//The number of URI's seen to be suspicious, higher = less likely to be suspicious\nlet uriThreshold = 1;\nCommonSecurityLog\n// Only look at connections that were allowed through the web proxy\n| where DeviceVendor =~ \"Zscaler\" and DeviceAction =~ \"Allowed\"\n// Only look where some data was exchanged.\n| where SentBytes > 0 and ReceivedBytes > 0\n// Extract the Domain\n| extend Domain = iff(countof(DestinationHostName,'.') >= 2, strcat(split(DestinationHostName,'.')[-2], '.',split(DestinationHostName,'.')[-1]), DestinationHostName)\n| extend GetData=iff(RequestURL == \"?\", 1, 0)\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), makelist(RequestURL), makelist(DestinationIP), makelist(SourceIP), numOfConnections = count(), make_set(RequestMethod), max(GetData), max(RequestContext) by Domain\n// Determine the number of URIs that have been visited for the domain\n| extend destinationURI = arraylength(list_RequestURL)\n| where destinationURI <= uriThreshold\n| where tostring(list_RequestURL) has_any(scriptExtensions)\n//Remove matches with referer\n| where max_RequestContext == \"\"\n//Keep requests where data was trasferred either in a GET with parameters or a POST\n| where set_RequestMethod in~ (\"POST\") or max_GetData == 1\n//Defeat email click tracking, may increase FN's while decreasing FP's\n| where list_RequestURL !has \"click\" and set_RequestMethod !has \"GET\"\n| mvexpand list_RequestURL, list_DestinationIP\n| extend RequestURL = tostring(list_RequestURL), DestinationIP = tostring(list_DestinationIP), ClientIP = tostring(list_SourceIP)\n//Extend custom entitites for incidents\n| project-away list_RequestURL, list_DestinationIP, list_SourceIP, destinationURI, Domain, StartTimeUtc, EndTimeUtc, max_GetData, max_RequestContext\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "dataTypes": [
                                            "CommonSecurityLog"
                                        ],
                                        "connectorId": "CefAma"
                                    }
                                ],
                                "tactics": [
                                    "CommandAndControl"
                                ],
                                "techniques": [
                                    "T1102",
                                    "T1071"
                                ],
                                "entityMappings": [
                                    {
                                        "entityType": "IP",
                                        "fieldMappings": [
                                            {
                                                "columnName": "DestinationIP",
                                                "identifier": "Address"
                                            }
                                        ]
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '4d500e6d-c984-43a3-9f39-7edec8dcc04d'),'/'))))]",
                            "properties": {
                                "description": "Zscaler Internet Access Analytics Rule 2",
                                "parentId": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '4d500e6d-c984-43a3-9f39-7edec8dcc04d')]",
                                "contentId": "4d500e6d-c984-43a3-9f39-7edec8dcc04d",
                                "kind": "AnalyticsRule",
                                "version": "1.0.5",
                                "source": {
                                    "kind": "Solution",
                                    "name": "Zscaler Internet Access",
                                    "sourceId": "zscaler1579058425289.zscaler_internet_access_mss"
                                },
                                "author": {
                                    "name": "Zscaler"
                                },
                                "support": {
                                    "name": "Zscaler",
                                    "tier": "Partner",
                                    "link": "https://help.zscaler.com/submit-ticket-links"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "3.0.3",
                "packageName": "Zscaler Internet Access",
                "packageId": "zscaler1579058425289.zscaler_internet_access_mss",
                "contentSchemaVersion": "3.0.0",
                "contentId": "4d500e6d-c984-43a3-9f39-7edec8dcc04d",
                "contentKind": "AnalyticsRule",
                "displayName": "Request for single resource on domain",
                "contentProductId": "zscaler1579058425289.zscaler_internet_access_mss-ar-heyba7vhwpehe",
                "id": "zscaler1579058425289.zscaler_internet_access_mss-ar-heyba7vhwpehe",
                "version": "1.0.5",
                "isDeprecated": false,
                "dependencies": {
                    "operator": "AND",
                    "criteria": [
                        {
                            "contentKind": "DataType",
                            "contentId": "CommonSecurityLog"
                        },
                        {
                            "contentKind": "DataConnector",
                            "contentId": "CefAma"
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring('ZScalerFW_Parser-Parser')))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'zscaler1579058425289.zscaler_internet_access_mss')]"
            ],
            "properties": {
                "description": "",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[concat(parameters('workspace'),'/','ZScalerFW_Parser')]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "ZScalerFW_Parser",
                                "category": "Microsoft Sentinel Parser",
                                "functionAlias": "ZScalerFW_Parser",
                                "query": "CommonSecurityLog\n| where DeviceVendor == \"Zscaler\" and DeviceProduct == \"NSSFWlog\"\n| extend deviceTranslatedPort = extract(@\"deviceTranslatedPort=(.*?)(;|$)\", 1, AdditionalExtensions),\n    tunnelType = extract(@\"tunnelType=(.*?)(;|$)\", 1, AdditionalExtensions),\n    dnat = extract(@\"dnat=(.*?)(;|$)\", 1, AdditionalExtensions),\n    stateful = extract(@\"stateful=(.*?)(;|$)\", 1, AdditionalExtensions),\n    reason = coalesce(\n                            extract(@\"reason=(.*?)(;|$)\", 1, AdditionalExtensions),                            \n                            column_ifexists(\"Reason\", \"\")\n                        ),\n    DeviceCustomString6Label = extract(@\"cs6label=(.*?)(;|$)\", 1, AdditionalExtensions),\n    destCountry = extract(@\"destCountry=(.*?)(;|$)\", 1, AdditionalExtensions),\n    avgduration = extract(@\"avgduration=(.*?)(;|$)\", 1, AdditionalExtensions)\n",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": ""
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'ZScalerFW_Parser'),'/'))))]",
                            "dependsOn": [
                                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'ZScalerFW_Parser')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'ZScalerFW_Parser')]",
                                "contentId": "ZScalerFW_Parser-Parser",
                                "kind": "Parser",
                                "version": "1.0.0",
                                "source": {
                                    "name": "Zscaler Internet Access",
                                    "kind": "Solution",
                                    "sourceId": "zscaler1579058425289.zscaler_internet_access_mss"
                                },
                                "author": {
                                    "name": "Zscaler"
                                },
                                "support": {
                                    "name": "Zscaler",
                                    "tier": "Partner",
                                    "link": "https://help.zscaler.com/submit-ticket-links"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "3.0.3",
                "packageName": "Zscaler Internet Access",
                "packageId": "zscaler1579058425289.zscaler_internet_access_mss",
                "contentSchemaVersion": "3.0.0",
                "contentId": "ZScalerFW_Parser-Parser",
                "contentKind": "Parser",
                "displayName": "ZScalerFW_Parser",
                "contentProductId": "zscaler1579058425289.zscaler_internet_access_mss-pr-nsxjbbwlsxdx2",
                "id": "zscaler1579058425289.zscaler_internet_access_mss-pr-nsxjbbwlsxdx2",
                "version": "1.0.0",
                "isDeprecated": false
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[concat(parameters('workspace'),'/','ZScalerFW_Parser')]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "ZScalerFW_Parser",
                "category": "Microsoft Sentinel Parser",
                "functionAlias": "ZScalerFW_Parser",
                "query": "CommonSecurityLog\n| where DeviceVendor == \"Zscaler\" and DeviceProduct == \"NSSFWlog\"\n| extend deviceTranslatedPort = extract(@\"deviceTranslatedPort=(.*?)(;|$)\", 1, AdditionalExtensions),\n    tunnelType = extract(@\"tunnelType=(.*?)(;|$)\", 1, AdditionalExtensions),\n    dnat = extract(@\"dnat=(.*?)(;|$)\", 1, AdditionalExtensions),\n    stateful = extract(@\"stateful=(.*?)(;|$)\", 1, AdditionalExtensions),\n    reason = coalesce(\n                            extract(@\"reason=(.*?)(;|$)\", 1, AdditionalExtensions),                            \n                            column_ifexists(\"Reason\", \"\")\n                        ),\n    DeviceCustomString6Label = extract(@\"cs6label=(.*?)(;|$)\", 1, AdditionalExtensions),\n    destCountry = extract(@\"destCountry=(.*?)(;|$)\", 1, AdditionalExtensions),\n    avgduration = extract(@\"avgduration=(.*?)(;|$)\", 1, AdditionalExtensions)\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": ""
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "location": "[parameters('workspace-location')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'ZScalerFW_Parser'),'/'))))]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'ZScalerFW_Parser')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'ZScalerFW_Parser')]",
                "contentId": "ZScalerFW_Parser-Parser",
                "kind": "Parser",
                "version": "1.0.0",
                "source": {
                    "kind": "Solution",
                    "name": "Zscaler Internet Access",
                    "sourceId": "zscaler1579058425289.zscaler_internet_access_mss"
                },
                "author": {
                    "name": "Zscaler"
                },
                "support": {
                    "name": "Zscaler",
                    "tier": "Partner",
                    "link": "https://help.zscaler.com/submit-ticket-links"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring('ZScalerWeb_Parser-Parser')))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'zscaler1579058425289.zscaler_internet_access_mss')]"
            ],
            "properties": {
                "description": "",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[concat(parameters('workspace'),'/','ZScalerWeb_Parser')]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "ZScalerWeb_Parser",
                                "category": "Microsoft Sentinel Parser",
                                "functionAlias": "ZScalerWeb_Parser",
                                "query": "CommonSecurityLog \n| where DeviceVendor == \"Zscaler\" and DeviceProduct == \"NSSWeblog\"\n| extend reason = coalesce(\n                            extract(@\"reason=(.*?)(;|$)\", 1, AdditionalExtensions),                            \n                            column_ifexists(\"Reason\", \"\")\n                        ),\n    user = extract(@\"suser=(.*?);\", 1, AdditionalExtensions),\n    sourceIP = extract(@\"sourceTranslatedAddress=(.*?)(;|$)\", 1, AdditionalExtensions),\n    outcome = coalesce(\n                        extract(@\"outcome=(.*?)(;|$)\", 1, AdditionalExtensions),                            \n                        column_ifexists(\"EventOutcome\", \"\")\n                    ),\n    cat = coalesce(\n                        extract(@\"cat=(.*?)(;|$)\", 1, AdditionalExtensions),                            \n                        column_ifexists(\"DeviceEventCategory\", \"\")\n                    ),\n    rulelabel = extract(@\"rulelabel=(.*?)(;|$)\", 1, AdditionalExtensions),\n    ruletype = extract(@\"ruletype=(.*?)(;|$)\", 1, AdditionalExtensions),\n    urlclass = extract(@\"urlclass=(.*?)(;|$)\", 1, AdditionalExtensions),\n    devicemodel = extract(@\"devicemodel=(.*?)(;|$)\", 1, AdditionalExtensions)\n",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": ""
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'ZScalerWeb_Parser'),'/'))))]",
                            "dependsOn": [
                                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'ZScalerWeb_Parser')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'ZScalerWeb_Parser')]",
                                "contentId": "ZScalerWeb_Parser-Parser",
                                "kind": "Parser",
                                "version": "1.0.0",
                                "source": {
                                    "name": "Zscaler Internet Access",
                                    "kind": "Solution",
                                    "sourceId": "zscaler1579058425289.zscaler_internet_access_mss"
                                },
                                "author": {
                                    "name": "Zscaler"
                                },
                                "support": {
                                    "name": "Zscaler",
                                    "tier": "Partner",
                                    "link": "https://help.zscaler.com/submit-ticket-links"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "3.0.3",
                "packageName": "Zscaler Internet Access",
                "packageId": "zscaler1579058425289.zscaler_internet_access_mss",
                "contentSchemaVersion": "3.0.0",
                "contentId": "ZScalerWeb_Parser-Parser",
                "contentKind": "Parser",
                "displayName": "ZScalerWeb_Parser",
                "contentProductId": "zscaler1579058425289.zscaler_internet_access_mss-pr-ragvxtllzwoto",
                "id": "zscaler1579058425289.zscaler_internet_access_mss-pr-ragvxtllzwoto",
                "version": "1.0.0",
                "isDeprecated": false
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[concat(parameters('workspace'),'/','ZScalerWeb_Parser')]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "ZScalerWeb_Parser",
                "category": "Microsoft Sentinel Parser",
                "functionAlias": "ZScalerWeb_Parser",
                "query": "CommonSecurityLog \n| where DeviceVendor == \"Zscaler\" and DeviceProduct == \"NSSWeblog\"\n| extend reason = coalesce(\n                            extract(@\"reason=(.*?)(;|$)\", 1, AdditionalExtensions),                            \n                            column_ifexists(\"Reason\", \"\")\n                        ),\n    user = extract(@\"suser=(.*?);\", 1, AdditionalExtensions),\n    sourceIP = extract(@\"sourceTranslatedAddress=(.*?)(;|$)\", 1, AdditionalExtensions),\n    outcome = coalesce(\n                        extract(@\"outcome=(.*?)(;|$)\", 1, AdditionalExtensions),                            \n                        column_ifexists(\"EventOutcome\", \"\")\n                    ),\n    cat = coalesce(\n                        extract(@\"cat=(.*?)(;|$)\", 1, AdditionalExtensions),                            \n                        column_ifexists(\"DeviceEventCategory\", \"\")\n                    ),\n    rulelabel = extract(@\"rulelabel=(.*?)(;|$)\", 1, AdditionalExtensions),\n    ruletype = extract(@\"ruletype=(.*?)(;|$)\", 1, AdditionalExtensions),\n    urlclass = extract(@\"urlclass=(.*?)(;|$)\", 1, AdditionalExtensions),\n    devicemodel = extract(@\"devicemodel=(.*?)(;|$)\", 1, AdditionalExtensions)\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": ""
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "location": "[parameters('workspace-location')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'ZScalerWeb_Parser'),'/'))))]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'ZScalerWeb_Parser')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'ZScalerWeb_Parser')]",
                "contentId": "ZScalerWeb_Parser-Parser",
                "kind": "Parser",
                "version": "1.0.0",
                "source": {
                    "kind": "Solution",
                    "name": "Zscaler Internet Access",
                    "sourceId": "zscaler1579058425289.zscaler_internet_access_mss"
                },
                "author": {
                    "name": "Zscaler"
                },
                "support": {
                    "name": "Zscaler",
                    "tier": "Partner",
                    "link": "https://help.zscaler.com/submit-ticket-links"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-fa-',uniquestring('FunctionApp')))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'zscaler1579058425289.zscaler_internet_access_mss')]"
            ],
            "properties": {
                "description": "",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0",
                    "parameters": {
                        "Storage account name": {
                            "defaultValue": "zscalerauthenticationsa",
                            "type": "String",
                            "metadata": {
                                "description": "Name of the storage account, which will be created by the playbook."
                            }
                        },
                        "Keyvault name": {
                            "defaultValue": "zscalerauthenticationkv",
                            "type": "String",
                            "metadata": {
                                "description": "Name of the Azure Keyvault, which will be created by the playbook. A vault's name must be between 3-24 alphanumeric characters. The name must begin with a letter, end with a letter or digit, and not contain consecutive hyphens."
                            }
                        },
                        "FunctionAppname": {
                            "defaultValue": "zscalerauthenticationfa",
                            "type": "String",
                            "metadata": {
                                "description": "Name of the Azure Function App, which will be created by the playbook."
                            }
                        },
                        "Zscaler Key": {
                            "defaultValue": "",
                            "type": "securestring",
                            "metadata": {
                                "description": "Your Zscaler key."
                            }
                        },
                        "Zscaler Username": {
                            "defaultValue": "",
                            "type": "securestring",
                            "metadata": {
                                "description": "Your Zscaler username."
                            }
                        },
                        "Zscaler Password": {
                            "defaultValue": "",
                            "type": "securestring",
                            "metadata": {
                                "description": "Your Zscaler password."
                            }
                        }
                    },
                    "variables": {
                        "functionAppName": "[[parameters('FunctionAppname')]",
                        "appServicePlanName": "[[parameters('FunctionAppname')]",
                        "keyvault_name": "[[toLower(parameters('Keyvault name'))]",
                        "storageAccountName": "[[toLower(parameters('Storage account name'))]",
                        "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                        "playbookContentId1": "FunctionApp",
                        "playbookId1": "[[resourceId('Microsoft.Logic/workflows', 'FunctionApp')]",
                        "workspace-name": "[parameters('workspace')]",
                        "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.KeyVault/vaults",
                            "apiVersion": "2016-10-01",
                            "name": "[[variables('keyvault_name')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "properties": {
                                "sku": {
                                    "family": "A",
                                    "name": "standard"
                                },
                                "tenantId": "[[subscription().tenantId]",
                                "enabledForDeployment": false,
                                "enabledForDiskEncryption": false,
                                "enabledForTemplateDeployment": true,
                                "enableSoftDelete": true,
                                "accessPolicies": "[json('[]')]"
                            }
                        },
                        {
                            "type": "Microsoft.KeyVault/vaults/secrets",
                            "apiVersion": "2016-10-01",
                            "name": "[[concat(variables('keyvault_name'), '/', 'Zscaler-Key')]",
                            "dependsOn": [
                                "[[resourceId('Microsoft.KeyVault/vaults', variables('keyvault_name'))]"
                            ],
                            "properties": {
                                "value": "[[parameters('Zscaler Key')]",
                                "contentType": "string",
                                "attributes": {
                                    "enabled": true
                                }
                            }
                        },
                        {
                            "type": "Microsoft.KeyVault/vaults/secrets",
                            "apiVersion": "2016-10-01",
                            "name": "[[concat(variables('keyvault_name'), '/', 'Zscaler-Username')]",
                            "dependsOn": [
                                "[[resourceId('Microsoft.KeyVault/vaults', variables('keyvault_name'))]"
                            ],
                            "properties": {
                                "value": "[[parameters('Zscaler Username')]",
                                "contentType": "string",
                                "attributes": {
                                    "enabled": true
                                }
                            }
                        },
                        {
                            "type": "Microsoft.KeyVault/vaults/secrets",
                            "apiVersion": "2016-10-01",
                            "name": "[[concat(variables('keyvault_name'), '/', 'Zscaler-Password')]",
                            "dependsOn": [
                                "[[resourceId('Microsoft.KeyVault/vaults', variables('keyvault_name'))]"
                            ],
                            "properties": {
                                "value": "[[parameters('Zscaler Password')]",
                                "contentType": "string",
                                "attributes": {
                                    "enabled": true
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Storage/storageAccounts",
                            "name": "[[variables('storageAccountName')]",
                            "apiVersion": "2021-01-01",
                            "location": "[[variables('workspace-location-inline')]",
                            "sku": {
                                "name": "Standard_LRS",
                                "tier": "Standard"
                            },
                            "kind": "StorageV2"
                        },
                        {
                            "type": "Microsoft.Web/sites",
                            "apiVersion": "2018-11-01",
                            "name": "[[variables('functionAppName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "kind": "functionapp",
                            "dependsOn": [
                                "[[resourceId('Microsoft.Web/serverfarms',variables('appServicePlanName'))]"
                            ],
                            "properties": {
                                "enabled": true,
                                "hostNameSslStates": [
                                    {
                                        "name": "[[concat(variables('functionAppName'), '.azurewebsites.net')]",
                                        "sslState": "Disabled",
                                        "hostType": "Standard"
                                    },
                                    {
                                        "name": "[[concat(variables('functionAppName'), '.scm.azurewebsites.net')]",
                                        "sslState": "Disabled",
                                        "hostType": "Repository"
                                    }
                                ],
                                "serverFarmId": "[[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                                "reserved": false,
                                "isXenon": false,
                                "hyperV": false,
                                "scmSiteAlsoStopped": false,
                                "clientAffinityEnabled": false,
                                "clientCertEnabled": false,
                                "hostNamesDisabled": false,
                                "containerSize": 1536,
                                "dailyMemoryTimeQuota": 0,
                                "httpsOnly": false,
                                "redundancyMode": "None"
                            }
                        },
                        {
                            "type": "Microsoft.Web/sites/config",
                            "apiVersion": "2018-11-01",
                            "name": "[[concat(variables('functionAppName'), '/web')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "dependsOn": [
                                "[[resourceId('Microsoft.Web/sites', variables('functionAppName'))]",
                                "[[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                                "[[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
                            ],
                            "properties": {
                                "numberOfWorkers": 1,
                                "defaultDocuments": [
                                    "Default.htm",
                                    "Default.html",
                                    "Default.asp",
                                    "index.htm",
                                    "index.html",
                                    "iisstart.htm",
                                    "default.aspx",
                                    "index.php"
                                ],
                                "netFrameworkVersion": "v4.0",
                                "phpVersion": "5.6",
                                "requestTracingEnabled": false,
                                "remoteDebuggingEnabled": false,
                                "httpLoggingEnabled": false,
                                "logsDirectorySizeLimit": 35,
                                "detailedErrorLoggingEnabled": false,
                                "publishingUsername": "$zsacler-fa",
                                "scmType": "None",
                                "use32BitWorkerProcess": true,
                                "webSocketsEnabled": false,
                                "alwaysOn": false,
                                "managedPipelineMode": "Integrated",
                                "virtualApplications": [
                                    {
                                        "virtualPath": "/",
                                        "physicalPath": "site\\wwwroot",
                                        "preloadEnabled": false
                                    }
                                ],
                                "loadBalancing": "LeastRequests",
                                "experiments": {
                                    "rampUpRules": "[json('[]')]"
                                },
                                "autoHealEnabled": false,
                                "cors": {
                                    "allowedOrigins": [
                                        "https://functions.azure.com",
                                        "https://functions-staging.azure.com",
                                        "https://functions-next.azure.com"
                                    ],
                                    "supportCredentials": false
                                },
                                "localMySqlEnabled": false,
                                "ipSecurityRestrictions": [
                                    {
                                        "ipAddress": "Any",
                                        "action": "Allow",
                                        "priority": 1,
                                        "name": "Allow all",
                                        "description": "Allow all access"
                                    }
                                ],
                                "scmIpSecurityRestrictions": [
                                    {
                                        "ipAddress": "Any",
                                        "action": "Allow",
                                        "priority": 1,
                                        "name": "Allow all",
                                        "description": "Allow all access"
                                    }
                                ],
                                "scmIpSecurityRestrictionsUseMain": false,
                                "http20Enabled": false,
                                "minTlsVersion": "1.2",
                                "ftpsState": "AllAllowed",
                                "reservedInstanceCount": 0
                            }
                        },
                        {
                            "type": "Microsoft.Web/sites/functions",
                            "apiVersion": "2018-11-01",
                            "name": "[[concat(variables('functionAppName'), '/GetApiKey')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "dependsOn": [
                                "[[resourceId('Microsoft.Web/sites', variables('functionAppName'))]",
                                "[[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                                "[[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
                            ],
                            "properties": {
                                "config": {
                                    "bindings": [
                                        {
                                            "authLevel": "anonymous",
                                            "name": "req",
                                            "type": "httpTrigger",
                                            "direction": "in"
                                        },
                                        {
                                            "name": "res",
                                            "type": "http",
                                            "direction": "out"
                                        }
                                    ]
                                },
                                "files": {
                                    "index.js": "module.exports = function (context, data) {  var input = data;    var timestamp = Date.now().toString();    var high = timestamp.substring(timestamp.length - 6);    var low = (parseInt(high) >> 1).toString();    var apiKey = '';    while (low.length < 6) {    low = '0' + low;    }    for (var i = 0; i < high.length; i++) {    apiKey += input.body.key.charAt(parseInt(high.charAt(i)));    }    for (var j = 0; j < low.length; j++) {    apiKey += input.body.key.charAt(parseInt(low.charAt(j)) + 2);    }    context.res = {    body: {      apiKey: apiKey,      timestamp: timestamp    }  };  context.done();};"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Web/sites/hostNameBindings",
                            "apiVersion": "2018-11-01",
                            "name": "[[concat(variables('functionAppName'), '/', variables('functionAppName'), '.azurewebsites.net')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "dependsOn": [
                                "[[resourceId('Microsoft.Web/sites', variables('functionAppName'))]",
                                "[[resourceId('Microsoft.Web/serverfarms',variables('appServicePlanName'))]"
                            ],
                            "properties": {
                                "siteName": "zsacler-fa",
                                "hostNameType": "Verified"
                            }
                        },
                        {
                            "type": "Microsoft.Web/serverfarms",
                            "apiVersion": "2018-02-01",
                            "name": "[[variables('appServicePlanName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "sku": {
                                "name": "Y1",
                                "tier": "Dynamic"
                            },
                            "kind": "functionapp",
                            "properties": {
                                "name": "[[variables('appServicePlanName')]",
                                "workerSize": "0",
                                "workerSizeId": "0",
                                "numberOfWorkers": "1"
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[[concat(variables('workspace-name'),'/Microsoft.SecurityInsights/',concat('AzureFunction-', last(split(variables('playbookId1'),'/'))))]",
                            "properties": {
                                "parentId": "[[variables('playbookId1')]",
                                "contentId": "FunctionApp",
                                "kind": "AzureFunction",
                                "version": "1.0",
                                "source": {
                                    "kind": "Solution",
                                    "name": "Zscaler Internet Access",
                                    "sourceId": "zscaler1579058425289.zscaler_internet_access_mss"
                                },
                                "author": {
                                    "name": "Zscaler"
                                },
                                "support": {
                                    "name": "Zscaler",
                                    "tier": "Partner",
                                    "link": "https://help.zscaler.com/submit-ticket-links"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "3.0.3",
                "packageName": "Zscaler Internet Access",
                "packageId": "zscaler1579058425289.zscaler_internet_access_mss",
                "contentSchemaVersion": "3.0.0",
                "contentId": "FunctionApp",
                "contentKind": "AzureFunction",
                "displayName": "FunctionApp",
                "contentProductId": "zscaler1579058425289.zscaler_internet_access_mss-fa-2zzsyg2fypkvo",
                "id": "zscaler1579058425289.zscaler_internet_access_mss-fa-2zzsyg2fypkvo",
                "version": "1.0",
                "isDeprecated": false
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring('Zscaler API authentication')))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'zscaler1579058425289.zscaler_internet_access_mss')]"
            ],
            "properties": {
                "description": "This playbook generates access token in Zscaler API. Call this playbook as a step in functional Zscaler playbooks. The output is a JSessionID which can be used to do other API actions",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0",
                    "parameters": {
                        "PlaybookName": {
                            "defaultValue": "Zscaler-Authentication-Playbook",
                            "type": "String",
                            "metadata": {
                                "description": "Name of the playbook, used as name for the resources. Use only letters and dashes."
                            }
                        },
                        "Keyvault name": {
                            "defaultValue": "zscalerauthenticationkv",
                            "type": "String",
                            "metadata": {
                                "description": "Name of the Azure Keyvault, which will be created by the playbook. A vault's name must be between 3-24 alphanumeric characters. The name must begin with a letter, end with a letter or digit, and not contain consecutive hyphens."
                            }
                        },
                        "FunctionAppname": {
                            "defaultValue": "zscalerauthenticationfa",
                            "type": "String",
                            "metadata": {
                                "description": "Name of the Azure Function App, which will be created by the playbook."
                            }
                        },
                        "Zscaler Admin Url": {
                            "defaultValue": "https://admin.<zscaler_instance_domain>.net",
                            "type": "String",
                            "metadata": {
                                "description": "Update to a valid Zscaler admin url."
                            }
                        }
                    },
                    "variables": {
                        "functionAppName": "[[parameters('FunctionAppname')]",
                        "keyvault_name": "[[toLower(parameters('Keyvault name'))]",
                        "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/keyvault')]",
                        "_connection-1": "[[variables('connection-1')]",
                        "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                        "workspace-name": "[parameters('workspace')]",
                        "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('keyvault_name')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "dependsOn": "[json('[]')]",
                            "properties": {
                                "api": {
                                    "id": "[[variables('_connection-1')]"
                                },
                                "parameterValues": {
                                    "token:TenantId": "[[subscription().tenantId]",
                                    "token:grantType": "code",
                                    "vaultName": "[[variables('KeyVault_name')]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Logic/workflows",
                            "apiVersion": "2017-07-01",
                            "name": "[[parameters('PlaybookName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('keyvault_name'))]"
                            ],
                            "tags": {
                                "hidden-SentinelTemplateName": "Zscaler-Authentication",
                                "hidden-SentinelTemplateVersion": "1.0",
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                            },
                            "properties": {
                                "state": "Enabled",
                                "definition": {
                                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {
                                        "$connections": {
                                            "type": "Object"
                                        }
                                    },
                                    "triggers": {
                                        "manual": {
                                            "type": "Request",
                                            "kind": "Http"
                                        }
                                    },
                                    "actions": {
                                        "GetApiKey": {
                                            "runAfter": {
                                                "Get_Zscaler_Password": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Function",
                                            "inputs": {
                                                "body": {
                                                    "key": "@body('Get_Zscaler_Key')?['value']"
                                                },
                                                "function": {
                                                    "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/sites/', variables('functionAppName'), '/functions/GetApiKey')]"
                                                }
                                            }
                                        },
                                        "Get_Zscaler_Key": {
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['keyvault']['connectionId']"
                                                    }
                                                },
                                                "method": "get",
                                                "path": "/secrets/@{encodeURIComponent('Zscaler-Key')}/value"
                                            },
                                            "runtimeConfiguration": {
                                                "secureData": {
                                                    "properties": [
                                                        "outputs"
                                                    ]
                                                }
                                            }
                                        },
                                        "Get_Zscaler_Username": {
                                            "runAfter": {
                                                "Get_Zscaler_Key": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['keyvault']['connectionId']"
                                                    }
                                                },
                                                "method": "get",
                                                "path": "/secrets/@{encodeURIComponent('Zscaler-Username')}/value"
                                            },
                                            "runtimeConfiguration": {
                                                "secureData": {
                                                    "properties": [
                                                        "outputs"
                                                    ]
                                                }
                                            }
                                        },
                                        "Get_Zscaler_Password": {
                                            "runAfter": {
                                                "Get_Zscaler_Username": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['keyvault']['connectionId']"
                                                    }
                                                },
                                                "method": "get",
                                                "path": "/secrets/@{encodeURIComponent('Zscaler-Password')}/value"
                                            },
                                            "runtimeConfiguration": {
                                                "secureData": {
                                                    "properties": [
                                                        "outputs"
                                                    ]
                                                }
                                            }
                                        },
                                        "HTTP": {
                                            "runAfter": {
                                                "Parse_Response": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Http",
                                            "inputs": {
                                                "body": {
                                                    "apiKey": "@{body('Parse_Response')?['apiKey']}",
                                                    "password": "@{body('Get_Zscaler_Password')?['value']}",
                                                    "timestamp": "@{body('Parse_Response')?['timestamp']}",
                                                    "username": "@{body('Get_Zscaler_Username')?['value']}"
                                                },
                                                "headers": {
                                                    "Cache-Control": "no-cache",
                                                    "Content-Type": "application/json"
                                                },
                                                "method": "POST",
                                                "uri": "[[uriComponentToString(uri(parameters('Zscaler Admin Url'), '/api/v1/authenticatedSession'))]"
                                            }
                                        },
                                        "Parse_Headers": {
                                            "runAfter": {
                                                "HTTP": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ParseJson",
                                            "inputs": {
                                                "content": "@outputs('HTTP')['headers']",
                                                "schema": {
                                                    "properties": {
                                                        "Connection": {
                                                            "type": "string"
                                                        },
                                                        "Content-Length": {
                                                            "type": "string"
                                                        },
                                                        "Content-Type": {
                                                            "type": "string"
                                                        },
                                                        "Date": {
                                                            "type": "string"
                                                        },
                                                        "Keep-Alive": {
                                                            "type": "string"
                                                        },
                                                        "Server": {
                                                            "type": "string"
                                                        },
                                                        "Set-Cookie": {
                                                            "type": "string"
                                                        },
                                                        "Strict-Transport-Security": {
                                                            "type": "string"
                                                        },
                                                        "X-Content-Type-Options": {
                                                            "type": "string"
                                                        },
                                                        "X-Frame-Options": {
                                                            "type": "string"
                                                        },
                                                        "X-XSS-Protection": {
                                                            "type": "string"
                                                        }
                                                    },
                                                    "type": "object"
                                                }
                                            }
                                        },
                                        "Parse_Response": {
                                            "runAfter": {
                                                "GetApiKey": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ParseJson",
                                            "inputs": {
                                                "content": "@body('GetApiKey')",
                                                "schema": {
                                                    "properties": {
                                                        "apiKey": {
                                                            "type": "string"
                                                        },
                                                        "timestamp": {
                                                            "type": "string"
                                                        }
                                                    },
                                                    "type": "object"
                                                }
                                            }
                                        },
                                        "Response": {
                                            "runAfter": {
                                                "Parse_Headers": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Response",
                                            "kind": "Http",
                                            "inputs": {
                                                "body": {
                                                    "cookie": "@{body('Parse_Headers')?['Set-Cookie']}"
                                                },
                                                "headers": "@outputs('HTTP')['headers']",
                                                "statusCode": "@outputs('HTTP')['statusCode']"
                                            }
                                        }
                                    }
                                },
                                "parameters": {
                                    "$connections": {
                                        "value": {
                                            "keyvault": {
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('keyvault_name'))]",
                                                "connectionName": "keyvault",
                                                "id": "[[concat('/subscriptions/', subscription().subscriptionId ,'/providers/Microsoft.Web/locations/', variables('workspace-location-inline') ,'/managedApis/keyvault')]"
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(resourceId('Microsoft.Logic/workflows', 'Zscaler API authentication'),'/'))))]",
                            "properties": {
                                "parentId": "[resourceId('Microsoft.Logic/workflows', 'Zscaler API authentication')]",
                                "contentId": "Zscaler API authentication",
                                "kind": "Playbook",
                                "version": "1.0",
                                "source": {
                                    "kind": "Solution",
                                    "name": "Zscaler Internet Access",
                                    "sourceId": "zscaler1579058425289.zscaler_internet_access_mss"
                                },
                                "author": {
                                    "name": "Zscaler"
                                },
                                "support": {
                                    "name": "Zscaler",
                                    "tier": "Partner",
                                    "link": "https://help.zscaler.com/submit-ticket-links"
                                },
                                "dependencies": {
                                    "criteria": [
                                        {
                                            "kind": "AzureFunction",
                                            "contentId": "FunctionApp",
                                            "version": "1.0"
                                        }
                                    ]
                                }
                            }
                        }
                    ],
                    "metadata": {
                        "title": "Zscaler API authentication",
                        "description": "This playbook generates access token in Zscaler API. Call this playbook as a step in functional Zscaler playbooks. The output is a JSessionID which can be used to do other API actions",
                        "prerequisites": [
                            "Playbook templates leverage the Zscaler API. To use the Zscaler capabilities, you need a Zscaler API key. Refer this link: [API Developers Guide: Getting Started](https://help.zscaler.com/zia/api-getting-started)",
                            "Please deploy the function app before the Zscaler API authentication playbook."
                        ],
                        "lastUpdateTime": "2021-07-28T00:00:00Z",
                        "tags": [
                            "Utilities"
                        ],
                        "releaseNotes": {
                            "version": "1.0",
                            "title": "[replace('b', 'b', '')]",
                            "notes": [
                                "Initial version"
                            ]
                        }
                    }
                },
                "packageKind": "Solution",
                "packageVersion": "3.0.3",
                "packageName": "Zscaler Internet Access",
                "packageId": "zscaler1579058425289.zscaler_internet_access_mss",
                "contentSchemaVersion": "3.0.0",
                "contentId": "Zscaler API authentication",
                "contentKind": "Playbook",
                "displayName": "Zscaler-Authentication-Playbook",
                "contentProductId": "zscaler1579058425289.zscaler_internet_access_mss-pl-ywh6mhzsfrcv6",
                "id": "zscaler1579058425289.zscaler_internet_access_mss-pl-ywh6mhzsfrcv6",
                "version": "1.0",
                "isDeprecated": false
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring('Add-Url-To-Category')))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'zscaler1579058425289.zscaler_internet_access_mss')]"
            ],
            "properties": {
                "description": "This playbook allows blocks URLs in Zscaler by adding them to categories",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0",
                    "parameters": {
                        "PlaybookName": {
                            "defaultValue": "Zscaler-Add-Url-To-Category",
                            "type": "String",
                            "metadata": {
                                "description": "Name of the Logic App/Playbook"
                            }
                        },
                        "Zscaler Authentation Playbook": {
                            "defaultValue": "Zscaler-Authentication-Playbook",
                            "type": "String",
                            "metadata": {
                                "description": "Name of the Zscaler Authentication Playbook"
                            }
                        },
                        "Zscaler Admin Url": {
                            "defaultValue": "https://admin.<zscaler_instance_domain>.net",
                            "type": "String",
                            "metadata": {
                                "description": "Update to a valid Zscaler admin url."
                            }
                        },
                        "Block Category": {
                            "defaultValue": "OTHER_MISCELLANEOUS",
                            "type": "String",
                            "metadata": {
                                "description": "Zscaler block category"
                            }
                        }
                    },
                    "variables": {
                        "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
                        "ZscalerAuthenticationFlow": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Zscaler Authentation Playbook'))]",
                        "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "_connection-1": "[[variables('connection-1')]",
                        "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                        "workspace-name": "[parameters('workspace')]",
                        "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('AzureSentinelConnectionName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "kind": "V1",
                            "properties": {
                                "displayName": "[[variables('AzureSentinelConnectionName')]",
                                "parameterValueType": "Alternative",
                                "api": {
                                    "id": "[[variables('_connection-1')]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Logic/workflows",
                            "apiVersion": "2017-07-01",
                            "name": "[[parameters('PlaybookName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
                            ],
                            "identity": {
                                "type": "SystemAssigned"
                            },
                            "tags": {
                                "hidden-SentinelTemplateName": "BlockURL-Zscaler",
                                "hidden-SentinelTemplateVersion": "1.0",
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                            },
                            "properties": {
                                "state": "Enabled",
                                "definition": {
                                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {
                                        "$connections": {
                                            "type": "Object"
                                        }
                                    },
                                    "triggers": {
                                        "Microsoft_Sentinel_incident": {
                                            "type": "ApiConnectionWebhook",
                                            "inputs": {
                                                "body": {
                                                    "callback_url": "@{listCallbackUrl()}"
                                                },
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                    }
                                                },
                                                "path": "/incident-creation"
                                            }
                                        }
                                    },
                                    "actions": {
                                        "Set_Zscaler_Block_Category": {
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "Category",
                                                        "type": "String",
                                                        "value": "[[parameters('Block Category')]"
                                                    }
                                                ]
                                            }
                                        },
                                        "Entities_-_Get_URLs": {
                                            "runAfter": {
                                                "Set_Zscaler_Block_Category": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "path": "/entities/url"
                                            }
                                        },
                                        "For_each": {
                                            "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
                                            "actions": {
                                                "Add_comment_to_incident_(V3)": {
                                                    "runAfter": {
                                                        "Compose": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "body": {
                                                            "incidentArmId": "@triggerBody()?['object']?['id']",
                                                            "message": "[[concat('<p>@{outputs(''Compose'')}<br>Url @{items(''For_each'')?[''Url'']} has been added to category @{variables(''Category'')}</p>')]"
                                                        },
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                            }
                                                        },
                                                        "method": "post",
                                                        "path": "/Incidents/Comment"
                                                    }
                                                },
                                                "Compose": {
                                                    "runAfter": {
                                                        "HTTP_Activate_Changes": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Compose",
                                                    "inputs": "<img src=\"https://www.zscaler.com//themes/custom/zscaler/logo.svg\" alt=\"Zscaler\">"
                                                },
                                                "HTTP_Add_Url": {
                                                    "type": "Http",
                                                    "inputs": {
                                                        "body": {
                                                            "configuredName": "@{variables('Category')}",
                                                            "urls": [
                                                                "@{items('For_each')?['Url']}"
                                                            ]
                                                        },
                                                        "cookie": "@body('Parse_Authentication_Response')?['cookie']",
                                                        "headers": {
                                                            "Cache-Control": "no-cache",
                                                            "Content-Type": "application/json"
                                                        },
                                                        "method": "PUT",
                                                        "uri": "[[uriComponentToString(uri(parameters('Zscaler Admin Url'), '/api/v1/urlCategories/@{variables(''Category'')}?action=ADD_TO_LIST'))]"
                                                    }
                                                },
                                                "HTTP_Activate_Changes": {
                                                    "runAfter": {
                                                        "HTTP_Add_Url": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Http",
                                                    "inputs": {
                                                        "cookie": "@body('Parse_Authentication_Response')?['cookie']",
                                                        "method": "POST",
                                                        "uri": "[[uriComponentToString(uri(parameters('Zscaler Admin Url'), '/api/v1/status/activate'))]"
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Parse_Authentication_Response": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Foreach"
                                        },
                                        "HTTP_Delete_Api_Session": {
                                            "runAfter": {
                                                "For_each": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Http",
                                            "inputs": {
                                                "cookie": "@body('Parse_Authentication_Response')?['cookie']",
                                                "method": "DELETE",
                                                "uri": "[[uriComponentToString(uri(parameters('Zscaler Admin Url'), '/api/v1/authenticatedSession'))]"
                                            }
                                        },
                                        "Parse_Authentication_Response": {
                                            "runAfter": {
                                                "zscaler": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ParseJson",
                                            "inputs": {
                                                "content": "@body('zscaler')",
                                                "schema": {
                                                    "properties": {
                                                        "cookie": {
                                                            "type": "string"
                                                        }
                                                    },
                                                    "type": "object"
                                                }
                                            }
                                        },
                                        "zscaler": {
                                            "runAfter": {
                                                "Entities_-_Get_URLs": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Workflow",
                                            "inputs": {
                                                "host": {
                                                    "triggerName": "manual",
                                                    "workflow": {
                                                        "id": "[[variables('ZscalerAuthenticationFlow')]"
                                                    }
                                                }
                                            }
                                        }
                                    }
                                },
                                "parameters": {
                                    "$connections": {
                                        "value": {
                                            "azuresentinel": {
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                                                "connectionName": "[[variables('AzureSentinelConnectionName')]",
                                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                                                "connectionProperties": {
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity"
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(resourceId('Microsoft.Logic/workflows', 'Add-Url-To-Category'),'/'))))]",
                            "properties": {
                                "parentId": "[resourceId('Microsoft.Logic/workflows', 'Add-Url-To-Category')]",
                                "contentId": "Add-Url-To-Category",
                                "kind": "Playbook",
                                "version": "1.0",
                                "source": {
                                    "kind": "Solution",
                                    "name": "Zscaler Internet Access",
                                    "sourceId": "zscaler1579058425289.zscaler_internet_access_mss"
                                },
                                "author": {
                                    "name": "Zscaler"
                                },
                                "support": {
                                    "name": "Zscaler",
                                    "tier": "Partner",
                                    "link": "https://help.zscaler.com/submit-ticket-links"
                                }
                            }
                        }
                    ],
                    "metadata": {
                        "title": "Block URL - Zscaler",
                        "description": "This playbook allows blocks URLs in Zscaler by adding them to categories",
                        "prerequisites": [
                            "1. This playbook leverages a nested playbook: Zscaler authentication. The **Zscaler-Authentication-Playbook** can be deployed using below steps:\n\n 1. Using direct ARM template (github)\n\n 2. By navigating to Automation --> Playbook templates --> ZScalar Authentication",
                            "2. Create a block category in Zscaler, which this playbook will add IPs to."
                        ],
                        "lastUpdateTime": "2021-07-28T00:00:00Z",
                        "entities": [
                            "Url"
                        ],
                        "tags": [
                            "Remediation"
                        ],
                        "releaseNotes": {
                            "version": "1.0",
                            "title": "[replace('b', 'b', '')]",
                            "notes": [
                                "Initial version"
                            ]
                        }
                    }
                },
                "packageKind": "Solution",
                "packageVersion": "3.0.3",
                "packageName": "Zscaler Internet Access",
                "packageId": "zscaler1579058425289.zscaler_internet_access_mss",
                "contentSchemaVersion": "3.0.0",
                "contentId": "Add-Url-To-Category",
                "contentKind": "Playbook",
                "displayName": "Zscaler-Add-Url-To-Category",
                "contentProductId": "zscaler1579058425289.zscaler_internet_access_mss-pl-stn56z4f7cicy",
                "id": "zscaler1579058425289.zscaler_internet_access_mss-pl-stn56z4f7cicy",
                "version": "1.0",
                "isDeprecated": false
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring('Get-Sandbox-Report-For-Hash')))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', 'zscaler1579058425289.zscaler_internet_access_mss')]"
            ],
            "properties": {
                "description": "This playbook post a Zscaler Sandbox report for each FileHash found in the incident.",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0",
                    "parameters": {
                        "PlaybookName": {
                            "defaultValue": "Zscaler-Get-Sandbox-Report-For-Hash",
                            "type": "String",
                            "metadata": {
                                "description": "Name of the Logic App/Playbook"
                            }
                        },
                        "Zscaler Authentation Playbook": {
                            "defaultValue": "Zscaler-Authentication-Playbook",
                            "type": "String",
                            "metadata": {
                                "description": "Name of the Zscaler Authentication Playbook"
                            }
                        },
                        "Zscaler Admin Url": {
                            "defaultValue": "https://admin.<zscaler_instance_domain>.net",
                            "type": "String",
                            "metadata": {
                                "description": "Update to a valid Zscaler admin url."
                            }
                        }
                    },
                    "variables": {
                        "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
                        "ZscalerAuthenticationFlow": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Zscaler Authentation Playbook'))]",
                        "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "_connection-1": "[[variables('connection-1')]",
                        "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                        "workspace-name": "[parameters('workspace')]",
                        "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('AzureSentinelConnectionName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "kind": "V1",
                            "properties": {
                                "displayName": "[[variables('AzureSentinelConnectionName')]",
                                "parameterValueType": "Alternative",
                                "api": {
                                    "id": "[[variables('_connection-1')]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Logic/workflows",
                            "apiVersion": "2017-07-01",
                            "name": "[[parameters('PlaybookName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "tags": {
                                "hidden-SentinelTemplateName": "FileHashEnrichment-Zscaler",
                                "hidden-SentinelTemplateVersion": "1.0",
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                            },
                            "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
                            ],
                            "identity": {
                                "type": "SystemAssigned"
                            },
                            "properties": {
                                "state": "Enabled",
                                "definition": {
                                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {
                                        "$connections": {
                                            "type": "Object"
                                        }
                                    },
                                    "triggers": {
                                        "Microsoft_Sentinel_incident": {
                                            "type": "ApiConnectionWebhook",
                                            "inputs": {
                                                "body": {
                                                    "callback_url": "@{listCallbackUrl()}"
                                                },
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                    }
                                                },
                                                "path": "/incident-creation"
                                            }
                                        }
                                    },
                                    "actions": {
                                        "Entities_-_Get_FileHashes": {
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "path": "/entities/filehash"
                                            }
                                        },
                                        "For_each": {
                                            "foreach": "@body('Entities_-_Get_FileHashes')?['Filehashes']",
                                            "actions": {
                                                "Append_to_Result_variable": {
                                                    "runAfter": {
                                                        "Parse_Result": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "AppendToStringVariable",
                                                    "inputs": {
                                                        "name": "Result",
                                                        "value": "Summary: @{body('Parse_Result')?['Summary']}<br/>"
                                                    }
                                                },
                                                "Compose": {
                                                    "runAfter": {
                                                        "Append_to_Result_variable": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Compose",
                                                    "inputs": "<img src=\"https://www.zscaler.com//themes/custom/zscaler/logo.svg\" alt=\"Zscaler\">"
                                                },
                                                "Add_comment_to_incident_(V3)": {
                                                    "runAfter": {
                                                        "Compose": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "body": {
                                                            "incidentArmId": "@triggerBody()?['object']?['id']",
                                                            "message": "<p>@{outputs('Compose')}<br>\nFileHash report from Zscaler playbook:<br>\n<br>\nSummary:<br>\nStatus: @{body('Parse_Result')?['Summary']?['Summary']?['Status']}<br>\nCategory: @{body('Parse_Result')?['Summary']?['Summary']?['Category']}<br>\nFileType: @{body('Parse_Result')?['Summary']?['Summary']?['FileType']}<br>\n<br>\nClassification:<br>\nType: @{body('Parse_Result')?['Summary']?['Classification']?['Type']}<br>\nCategory: @{body('Parse_Result')?['Summary']?['Classification']?['Category']}<br>\nScore: @{body('Parse_Result')?['Summary']?['Classification']?['Score']}<br>\nDetected Malware: @{body('Parse_Result')?['Summary']?['Classification']?['DetectedMalware']}<br>\n<br>\nFile properties:<br>\nFile type: @{body('Parse_Result')?['Summary']?['FileProperties']?['FileType']}<br>\nFile size: @{body('Parse_Result')?['Summary']?['FileProperties']?['FileSize']}<br>\nMD5: @{body('Parse_Result')?['Summary']?['FileProperties']?['MD5']}<br>\nSHA1: @{body('Parse_Result')?['Summary']?['FileProperties']?['SHA1']}<br>\nSha256: @{body('Parse_Result')?['Summary']?['FileProperties']?['Sha256']}<br>\nIssuer: @{body('Parse_Result')?['Summary']?['FileProperties']?['Issuer']}<br>\nDigital certificate: @{body('Parse_Result')?['Summary']?['FileProperties']?['DigitalCerificate']}<br>\nSSDeep: @{body('Parse_Result')?['Summary']?['FileProperties']?['SSDeep']}<br>\nRootCA: @{body('Parse_Result')?['Summary']?['FileProperties']?['RootCA']}</p>"
                                                        },
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                            }
                                                        },
                                                        "method": "post",
                                                        "path": "/Incidents/Comment"
                                                    }
                                                },
                                                "HTTP": {
                                                    "type": "Http",
                                                    "inputs": {
                                                        "cookie": "@body('Parse_Authentication_Response')?['cookie']",
                                                        "headers": {
                                                            "Cache-Control": "no-cache",
                                                            "Content-Type": "application/json"
                                                        },
                                                        "method": "GET",
                                                        "uri": "[[uriComponentToString(uri(parameters('Zscaler Admin Url'), '/api/v1/sandbox/report/@{items(''For_each'')?[''Value'']}?details=summary'))]"
                                                    }
                                                },
                                                "Parse_Result": {
                                                    "runAfter": {
                                                        "HTTP": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ParseJson",
                                                    "inputs": {
                                                        "content": "@body('HTTP')",
                                                        "schema": {
                                                            "properties": {
                                                                "Summary": {
                                                                    "properties": {
                                                                        "Classification": {
                                                                            "properties": {
                                                                                "Category": {
                                                                                    "type": "string"
                                                                                },
                                                                                "DetectedMalware": {
                                                                                    "type": "string"
                                                                                },
                                                                                "Score": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "Type": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "FileProperties": {
                                                                            "properties": {
                                                                                "DigitalCerificate": {
                                                                                    "type": "string"
                                                                                },
                                                                                "FileSize": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "FileType": {
                                                                                    "type": "string"
                                                                                },
                                                                                "Issuer": {
                                                                                    "type": "string"
                                                                                },
                                                                                "MD5": {
                                                                                    "type": "string"
                                                                                },
                                                                                "RootCA": {
                                                                                    "type": "string"
                                                                                },
                                                                                "SHA1": {
                                                                                    "type": "string"
                                                                                },
                                                                                "SSDeep": {
                                                                                    "type": "string"
                                                                                },
                                                                                "Sha256": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "Summary": {
                                                                            "properties": {
                                                                                "Category": {
                                                                                    "type": "string"
                                                                                },
                                                                                "Duration": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "FileType": {
                                                                                    "type": "string"
                                                                                },
                                                                                "StartTime": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "Status": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                }
                                                            },
                                                            "type": "object"
                                                        }
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Initialize_Response_variable": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Foreach"
                                        },
                                        "HTTP_Delete_Api_Session": {
                                            "runAfter": {
                                                "For_each": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Http",
                                            "inputs": {
                                                "cookie": "@body('Parse_Authentication_Response')?['cookie']",
                                                "method": "DELETE",
                                                "uri": "[[uriComponentToString(uri(parameters('Zscaler Admin Url'), '/api/v1/authenticatedSession'))]"
                                            }
                                        },
                                        "Initialize_Response_variable": {
                                            "runAfter": {
                                                "Parse_Authentication_Response": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "Result",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Parse_Authentication_Response": {
                                            "runAfter": {
                                                "zscaler": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ParseJson",
                                            "inputs": {
                                                "content": "@body('zscaler')",
                                                "schema": {
                                                    "properties": {
                                                        "cookie": {
                                                            "type": "string"
                                                        }
                                                    },
                                                    "type": "object"
                                                }
                                            }
                                        },
                                        "zscaler": {
                                            "runAfter": {
                                                "Entities_-_Get_FileHashes": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Workflow",
                                            "inputs": {
                                                "host": {
                                                    "triggerName": "manual",
                                                    "workflow": {
                                                        "id": "[[variables('ZscalerAuthenticationFlow')]"
                                                    }
                                                }
                                            }
                                        }
                                    }
                                },
                                "parameters": {
                                    "$connections": {
                                        "value": {
                                            "azuresentinel": {
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                                                "connectionName": "[[variables('AzureSentinelConnectionName')]",
                                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                                                "connectionProperties": {
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity"
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(resourceId('Microsoft.Logic/workflows', 'Get-Sandbox-Report-For-Hash'),'/'))))]",
                            "properties": {
                                "parentId": "[resourceId('Microsoft.Logic/workflows', 'Get-Sandbox-Report-For-Hash')]",
                                "contentId": "Get-Sandbox-Report-For-Hash",
                                "kind": "Playbook",
                                "version": "1.0",
                                "source": {
                                    "kind": "Solution",
                                    "name": "Zscaler Internet Access",
                                    "sourceId": "zscaler1579058425289.zscaler_internet_access_mss"
                                },
                                "author": {
                                    "name": "Zscaler"
                                },
                                "support": {
                                    "name": "Zscaler",
                                    "tier": "Partner",
                                    "link": "https://help.zscaler.com/submit-ticket-links"
                                }
                            }
                        }
                    ],
                    "metadata": {
                        "title": "FileHash Enrichment - Zscaler",
                        "description": "This playbook post a Zscaler Sandbox report for each FileHash found in the incident.",
                        "prerequisites": [
                            "1. This playbook leverages a nested playbook: Zscaler authentication. The **Zscaler-Authentication-Playbook** can be deployed using below steps:\n\n 1. Using direct ARM template (github)\n\n 2. By navigating to Automation --> Playbook templates --> ZScalar Authentication",
                            "2. Create a block category in Zscaler, which this playbook will add IPs to."
                        ],
                        "lastUpdateTime": "2021-07-28T00:00:00Z",
                        "entities": [
                            "FileHash"
                        ],
                        "tags": [
                            "Enrichment"
                        ],
                        "releaseNotes": {
                            "version": "1.0",
                            "title": "[replace('b', 'b', '')]",
                            "notes": [
                                "Initial version"
                            ]
                        }
                    }
                },
                "packageKind": "Solution",
                "packageVersion": "3.0.3",
                "packageName": "Zscaler Internet Access",
                "packageId": "zscaler1579058425289.zscaler_internet_access_mss",
                "contentSchemaVersion": "3.0.0",
                "contentId": "Get-Sandbox-Report-For-Hash",
                "contentKind": "Playbook",
                "displayName": "Zscaler-Get-Sandbox-Report-For-Hash",
                "contentProductId": "zscaler1579058425289.zscaler_internet_access_mss-pl-por7zwfhju6ie",
                "id": "zscaler1579058425289.zscaler_internet_access_mss-pl-por7zwfhju6ie",
                "version": "1.0",
                "isDeprecated": false
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
            "apiVersion": "2023-04-01-preview",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "version": "3.0.3",
                "kind": "Solution",
                "contentSchemaVersion": "3.0.0",
                "displayName": "Zscaler Internet Access",
                "publisherDisplayName": "Zscaler",
                "descriptionHtml": "Use this offer to deploy ZIA logs into Microsoft Sentinel.<div>Main users of this offer are IT teams that want to integrate ZIA logs into Microsoft Sentinel.</div><div>This simplifies the deployment process and allows IT teams to be more agile and start to realize the benefit of correlating their Zscaler Internet Access (e.g. Web and Firewall logs) with other signals and use Microsoft Sentinel to maximize the benefits of attack detection, threat visibility, proactive hunting, and threat response. </div>",
                "contentKind": "Solution",
                "contentProductId": "zscaler1579058425289.zscaler_internet_access_mss-sl-ipcb5xxjlvdxa",
                "id": "zscaler1579058425289.zscaler_internet_access_mss-sl-ipcb5xxjlvdxa",
                "icon": "https://store-images.s-microsoft.com/image/apps.15098.1805f830-5c09-4543-943f-1ba4d9a84620.f5eb75ab-61cc-4e78-8b6a-f5a0faea5be8.36f23240-e5b8-457f-81ed-912ddf3d8ef0",
                "contentId": "zscaler1579058425289.zscaler_internet_access_mss",
                "parentId": "zscaler1579058425289.zscaler_internet_access_mss",
                "source": {
                    "kind": "Solution",
                    "name": "Zscaler Internet Access",
                    "sourceId": "zscaler1579058425289.zscaler_internet_access_mss"
                },
                "author": {
                    "name": "Zscaler"
                },
                "support": {
                    "name": "Zscaler",
                    "tier": "Partner",
                    "link": "https://help.zscaler.com/submit-ticket-links"
                },
                "dependencies": {
                    "criteria": [
                        {
                            "kind": "Workbook",
                            "contentId": "ZscalerFirewallWorkbook",
                            "version": "1.1.0"
                        },
                        {
                            "kind": "Workbook",
                            "contentId": "ZscalerOffice365AppsWorkbook",
                            "version": "1.1.0"
                        },
                        {
                            "kind": "Workbook",
                            "contentId": "ZscalerThreatsOverviewWorkbook",
                            "version": "1.2.0"
                        },
                        {
                            "kind": "Workbook",
                            "contentId": "ZscalerWebOverviewWorkbook",
                            "version": "1.1.0"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "010bd98c-a6be-498c-bdcd-502308c0fdae",
                            "version": "1.0.4"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "4d500e6d-c984-43a3-9f39-7edec8dcc04d",
                            "version": "1.0.5"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "ZScalerFW_Parser-Parser",
                            "version": "1.0.0"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "ZScalerWeb_Parser-Parser",
                            "version": "1.0.0"
                        },
                        {
                            "kind": "AzureFunction",
                            "contentId": "FunctionApp",
                            "version": "1.0"
                        },
                        {
                            "kind": "Playbook",
                            "contentId": "Zscaler API authentication",
                            "version": "1.0"
                        },
                        {
                            "kind": "Playbook",
                            "contentId": "Add-Url-To-Category",
                            "version": "1.0"
                        },
                        {
                            "kind": "Playbook",
                            "contentId": "Get-Sandbox-Report-For-Hash",
                            "version": "1.0"
                        },
                        {
                            "kind": "Solution",
                            "contentId": "azuresentinel.azure-sentinel-solution-commoneventformat"
                        }
                    ]
                },
                "firstPublishDate": "2022-05-25",
                "providers": [
                    "Zscaler"
                ],
                "categories": {
                    "domains": [
                        "Security - Network",
                        "Security - Cloud Security"
                    ]
                },
                "isPreview": false,
                "isDeprecated": false,
                "migratedToPackageId": null
            },
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', 'zscaler1579058425289.zscaler_internet_access_mss')]"
        }
    ],
    "variables": {}
}
